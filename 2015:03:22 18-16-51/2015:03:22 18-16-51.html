<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1265.21">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.s1 {letter-spacing: 0.0px}
    span.s2 {font: 12.0px Helvetica}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>UnityのEditor上で動くpubsub用Server context を作った</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>あるとゲーム試すの楽になりそうなので組んでみる。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>こないだ作ったnginx-lua-moduleでのpubsubのしくみ</p>
<p class="p2"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>nginx-luajit-websocket-pubsuber</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/nginx-luajit-websocket-pubsuber">https://github.com/sassembla/nginx-luajit-websocket-pubsuber</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Client -&gt; (バックエンド) -&gt; redis -&gt; Server contextになるわけだが、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>もしも、このServer contextをUnityのEditorで実現できると、</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>ClientもServer contextも、一つのUnity上で動かせる</b>感じになる。これはラクじゃね？</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>つまりゲームコードとサーバコードを一カ所、Unity上で編集できる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>あくまで実験だが。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Editor側に来てほしいもの</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ClientはUnityのPlayer側に任せるとして、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>nginx-luajit-websocket-pubsubberがredisをqueueに使っているので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Editor側で請負いたいのは、redisのpubsubを捌く機構。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>upstreamはこんなの。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Client -&gt; (中略) -&gt; redis-pub -&gt; redis -&gt; redis-sub -&gt; Server context</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>downstreamはこんなの。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Client &lt;- (中略) &lt;- redis-sub &lt;- redis &lt;- redis-pub &lt;- Server context</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なので、Unity EditorのコードでゲームのServer側コンテキスト書いて、</p>
<p class="p3"><span class="Apple-tab-span">	</span>あとはpubとsubが出来れば、バックエンド機構の立ち上げは別途必要として、下記のような構造が作れそう。</p>
<p class="p2"><br></p>
<p class="p2"><span class="s1"><span class="Apple-tab-span">	</span></span></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span></span><span class="s2"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202015-03-25%204.09.20.png" alt="スクリーンショット 2015-03-25 4.09.20.png"></span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>、、うん、わかんねえな？</p>
<p class="p3"><span class="Apple-tab-span">	</span>要は、一台でもUnity EditorでServer contextが動いていれば、nginxをWebServerとしてClient1~3とやり取りできるようになる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Client1とUnity Editor Server context は一つのUnity Application上で動かせる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>nginx-luaでWebSocketServeしたりしてると、各ClientがLAN内で一台のUnity EditorのServer context と接続されて、ゲーム試したりとか出来る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>しかもServer context はUnity上で動いているコードなので、適当に編集可能。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Clientとやり取りするデータの型とかの共有も可能。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>まあ編集するたびに更新されるんだが。リセット命令は必要だと思うけど今回はめんd</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>出来上がった物がこちら</b></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>UEaaS</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/UEaaS">https://github.com/sassembla/UEaaS</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ひどい名前なので気に入った。</p>
<p class="p3"><span class="Apple-tab-span">	</span>そのうち正気に戻って付け直すと思う。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>機能とか特性とかは下記。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・redisでpubsubしたデータをUnityEditor内でsubscribeしたりpublishしたりする</p>
<p class="p3"><span class="Apple-tab-span">	</span>・EditorコードなのでUnity起動したらそのまま動いてる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・redisの先にClientが居れば、データが届く</p>
<p class="p3"><span class="Apple-tab-span">	</span>・payload部分はjson、それ以外のroutingとかpublish先の限定はbyteで書き込まれ、Clientに到達するのはデータのみ</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Clientのログを集計できるような命令乗っけといた</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity上で編集の必要がある全部のコードが弄れるようになった。とりあえず足がかりとしては満足だ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ざっくりClient-Server間はstringでやり取りするように書いたけど、だいたいbyteで操作してるのでmsgpackへの変更も可能。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そしてこれで、Server contextをluaで書かなくてよくなる。</p>
<p class="p2"><br></p>
</body>
</html>
