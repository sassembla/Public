<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2022.5">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #43c0a0; -webkit-text-stroke: #43c0a0; background-color: #1a1a1a}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; background-color: #1a1a1a}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #c27e65; -webkit-text-stroke: #c27e65; background-color: #1a1a1a}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; background-color: #1a1a1a; min-height: 14.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #8cd3fe; -webkit-text-stroke: #8cd3fe; background-color: #1a1a1a}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d69a; -webkit-text-stroke: #d4d69a; background-color: #1a1a1a}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca; min-height: 18.0px}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #8cd3fe; -webkit-text-stroke: #cacaca; background-color: #1a1a1a}
    p.p15 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px 'Hiragino Sans'; color: #cacaca; -webkit-text-stroke: #cacaca; min-height: 18.0px}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca; min-height: 18.0px}
    span.s1 {font: 12.0px Helvetica}
    span.s2 {font: 12.0px 'Hiragino Sans'}
    span.s3 {font-kerning: none; color: #cacaca; -webkit-text-stroke: 0px #cacaca}
    span.s4 {font-kerning: none; color: #4689cc; -webkit-text-stroke: 0px #4689cc}
    span.s5 {font-kerning: none; color: #d4d69a; -webkit-text-stroke: 0px #d4d69a}
    span.s6 {font-kerning: none}
    span.s7 {font-kerning: none; color: #8cd3fe; -webkit-text-stroke: 0px #8cd3fe}
    span.s8 {font-kerning: none; color: #43c0a0; -webkit-text-stroke: 0px #43c0a0}
    span.s9 {font-kerning: none; color: #b76fb3; -webkit-text-stroke: 0px #b76fb3}
    span.s10 {font-kerning: none; color: #c27e65; -webkit-text-stroke: 0px #c27e65}
    span.s11 {font-kerning: none; color: #cacaca}
    span.s12 {font-kerning: none; color: #d4d69a}
    span.s13 {font-kerning: none; color: #43c0a0}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Unity IAPを用いたAndroidのコンビニ課金について</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>TL;DR</p>
<p class="p3"><span class="Apple-tab-span">	</span>Googleのドキュメントは間違っている状態で放置されている、投げ捨てろ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Unityのフォーラムを見ろ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Androidにはコンビニ課金ってのがあって、Unity IAPも当然それに対応しているよ！！ ってはなし。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ただ、、たださあ、、、Googleのドキュメントがおかしいんだわ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>間違った情報が公式として残り続けている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そしてテストにもやばいレベルの問題がある。テストできねーのこれ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>実機でお支払い or キャンセル。何、その、、、19世紀か？</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>んでどんなフローになるのかとかの資料もないのな。</p>
<p class="p3"><span class="Apple-tab-span">	</span>リリースされたの2019年なのにマジで資料ない！ すげえ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>日本とメキシコ以外に対応してる国増えてると思うんだけどなー。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そして拒否してるゲームの多いこと。いやナチュラルに対応拒否させてくれ、、、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Google Play Billing Library 3.0に対応しないといけなかったのが去年だっけ、一昨年だっけ、</p>
<p class="p3"><span class="Apple-tab-span">	</span>そこから3系に対応すると、もれなくコンビニ課金機能がオンになる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>デフォルトでオンなので。</p>
<p class="p3"><span class="Apple-tab-span">	</span>で、これをオフにするか、対応するか、これはそんなはなし。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>説明</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>コンビニ決済は次のようなフローを辿るアレである。</p>
<p class="p3"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p3"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p3"><span class="Apple-tab-span">	</span>3. ここで[App戻る]という選択肢があるが、それを押すと、IStoreListenerで書かれてる必須なハンドラのみを扱っているようなUnity IAPの課金処理がしっかりばっちりハングする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>4. 実際にはこうするといけるよ的なハンドラを指定することで回避が可能だが、その資料がXXXXXなんだなあ、、、というアレ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>テスト方法について</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>コンビニ決済は2019年に生まれたPlayStore特有の決済方法だ、</p>
<p class="p3"><span class="Apple-tab-span">	</span>さて2019年といえば2年も前なわけだから、当然PlayStoreも何かしら気の利いたデバッグ方法を紹介しよう。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ないんだなあ。ないの。実機で、実アカウントでゴーするしかないの。<span class="Apple-converted-space"> </span></p>
<p class="p3"><span class="Apple-tab-span">	</span>なので体当たりでどういう遷移になるのかを追うしかなかった。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>それできっと、この記事を読んだマトモなひとが、いやこうやったらテストできましたよ、お家から快適生活ですよ、とか</p>
<p class="p3"><span class="Apple-tab-span">	</span>そういうことを書いてくれることを、心から願ってやまないよ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ちなみに豆知識として、PlayStoreに登録したテスト課金ユーザーだとコンビニ決済自体が表示されないの。どうして。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>実際に失敗したルートから書いていく。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>wrong end route</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Googleでdeffered purchase周りを調べると、次の記事に行きあたる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://developer.android.com/google/play/billing/unity">https://developer.android.com/google/play/billing/unity</a></p>
<p class="p3"><span class="Apple-tab-span">	</span>(英語でも日本語でも内容が一緒)</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、迷わせる前に書くと、これが、Unity IAPの何系を使っていてもうまく動くことはない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>関わるな。これはゴミだ。</p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>BAD END。</b></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>true end route</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unityのフォーラム曰く、</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://forum.unity.com/threads/googleplaystoremodule-does-not-exist-in-the-namespace-after-unity-update.1076585/">https://forum.unity.com/threads/googleplaystoremodule-does-not-exist-in-the-namespace-after-unity-update.1076585/</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここの最後で</p>
<p class="p4"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202021-08-19%2011.11.21.png" alt="スクリーンショット 2021-08-19 11.11.21.png"></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span>Unity</span>の中の人が「そのへんのGoogleの用意してるアレやらんでいいやつやで」って言及していて、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これを見るといいよっていうサンプルコードのリンクが別のフォーラムにあるよって書いてあって、</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://forum.unity.com/threads/sample-iap-project.529555/">https://forum.unity.com/threads/sample-iap-project.529555/</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そのフォーラムのページにいくとさらっとSampleProjectのzipのリンクがあり、、、</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p4"><span class="s2"><span class="Apple-tab-span">	</span></span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202021-08-19%2014.50.45.png" alt="スクリーンショット 2021-08-19 14.50.45.png"></p>
<p class="p5"><br></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span></span>えー、このプロジェクトを見ると次のようなコードがあって</p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s4">public</span><span class="s3"> </span><span class="s4">void</span><span class="s3"> </span><span class="s5">OnInitialized</span><span class="s3">(</span><span class="s6">IStoreController</span><span class="s3"> </span><span class="s7">controller</span><span class="s3">, </span><span class="s6">IExtensionProvider</span><span class="s3"> </span><span class="s7">extensions</span><span class="s3">)</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s5">MyDebug</span><span class="s3">(</span><span class="s6">"OnInitialized: PASS"</span><span class="s3">);</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">m_StoreController</span><span class="s3"> = </span><span class="s6">controller</span><span class="s3">;</span></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">m_StoreExtensionProvider</span><span class="s3"> = </span><span class="s6">extensions</span><span class="s3">;</span></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">m_AppleExtensions</span><span class="s3"> = </span><span class="s6">extensions</span><span class="s3">.</span><span class="s5">GetExtension</span><span class="s3">&lt;</span><span class="s8">IAppleExtensions</span><span class="s3">&gt;();</span></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">m_GoogleExtensions</span><span class="s3"> = </span><span class="s6">extensions</span><span class="s3">.</span><span class="s5">GetExtension</span><span class="s3">&lt;</span><span class="s8">IGooglePlayStoreExtensions</span><span class="s3">&gt;();</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">m_GoogleExtensions</span><span class="s3">?.</span><span class="s5">SetDeferredPurchaseListener</span><span class="s3">(</span><span class="s6">OnPurchaseDeferred</span><span class="s3">);</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p11"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s8">Dictionary</span><span class="s3">&lt;</span><span class="s4">string</span><span class="s3">, </span><span class="s4">string</span><span class="s3">&gt; </span><span class="s7">dict</span><span class="s3"> = </span><span class="s7">m_AppleExtensions</span><span class="s3">.</span><span class="s6">GetIntroductoryPriceDictionary</span><span class="s3">();</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s9">foreach</span><span class="s3"> (</span><span class="s6">UnityEngine</span><span class="s3">.</span><span class="s6">Purchasing</span><span class="s3">.</span><span class="s6">Product</span><span class="s3"> </span><span class="s7">item</span><span class="s3"> </span><span class="s9">in</span><span class="s3"> </span><span class="s7">controller</span><span class="s3">.</span><span class="s7">products</span><span class="s3">.</span><span class="s7">all</span><span class="s3">)</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">            </span></span><span class="s9">if</span><span class="s6"> (</span><span class="s7">item</span><span class="s6">.</span><span class="s7">receipt</span><span class="s6"> != </span><span class="s4">null</span><span class="s6">)</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s4">string</span><span class="s3"> </span><span class="s6">intro_json</span><span class="s3"> = (</span><span class="s6">dict</span><span class="s3"> == </span><span class="s4">null</span><span class="s3"> || !</span><span class="s6">dict</span><span class="s3">.</span><span class="s5">ContainsKey</span><span class="s3">(</span><span class="s6">item</span><span class="s3">.</span><span class="s6">definition</span><span class="s3">.</span><span class="s6">storeSpecificId</span><span class="s3">)) ? </span><span class="s4">null</span><span class="s3"> : </span><span class="s6">dict</span><span class="s3">[</span><span class="s6">item</span><span class="s3">.</span><span class="s6">definition</span><span class="s3">.</span><span class="s6">storeSpecificId</span><span class="s3">];</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s9">if</span><span class="s3"> (</span><span class="s6">item</span><span class="s3">.</span><span class="s6">definition</span><span class="s3">.</span><span class="s6">type</span><span class="s3"> == </span><span class="s6">ProductType</span><span class="s3">.</span><span class="s6">Subscription</span><span class="s3">)</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                </span>{</span></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">                    </span></span><span class="s6">SubscriptionManager</span><span class="s3"> </span><span class="s7">p</span><span class="s3"> = </span><span class="s4">new</span><span class="s3"> </span><span class="s6">SubscriptionManager</span><span class="s3">(</span><span class="s7">item</span><span class="s3">, </span><span class="s7">intro_json</span><span class="s3">);</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                    </span></span><span class="s8">SubscriptionInfo</span><span class="s6"> </span><span class="s7">info</span><span class="s6"> = </span><span class="s7">p</span><span class="s6">.</span><span class="s5">getSubscriptionInfo</span><span class="s6">();</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                    </span></span><span class="s5">MyDebug</span><span class="s6">(</span><span class="s10">"SubInfo: "</span><span class="s6"> + </span><span class="s7">info</span><span class="s6">.</span><span class="s5">getProductId</span><span class="s6">().</span><span class="s5">ToString</span><span class="s6">());</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                    </span></span><span class="s5">MyDebug</span><span class="s6">(</span><span class="s10">"isSubscribed: "</span><span class="s6"> + </span><span class="s7">info</span><span class="s6">.</span><span class="s5">isSubscribed</span><span class="s6">().</span><span class="s5">ToString</span><span class="s6">());</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                    </span></span><span class="s5">MyDebug</span><span class="s6">(</span><span class="s10">"isFreeTrial: "</span><span class="s6"> + </span><span class="s7">info</span><span class="s6">.</span><span class="s5">isFreeTrial</span><span class="s6">().</span><span class="s5">ToString</span><span class="s6">());</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p12"><br></p>
<p class="p13"><span class="Apple-tab-span">	</span>特筆すべきは</p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span></span><span class="s6">m_GoogleExtensions</span><span class="s11"> = </span><span class="s6">extensions</span><span class="s11">.</span><span class="s12">GetExtension</span><span class="s11">&lt;</span><span class="s13">IGooglePlayStoreExtensions</span><span class="s11">&gt;();</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p14"><span class="s11"><span class="Apple-converted-space">        </span></span><span class="s6">m_GoogleExtensions</span><span class="s11">?.</span><span class="s12">SetDeferredPurchaseListener</span><span class="s11">(</span><span class="s6">OnPurchaseDeferred</span><span class="s11">);</span></p>
<p class="p12"><br></p>
<p class="p13"><span class="Apple-tab-span">	</span>と、セットされているOnPurchaseDefferred関数</p>
<p class="p12"><br></p>
<p class="p11"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s4">public</span><span class="s3"> </span><span class="s4">void</span><span class="s3"> </span><span class="s6">OnPurchaseDeferred</span><span class="s3">(</span><span class="s8">Product</span><span class="s3"> </span><span class="s7">product</span><span class="s3">)</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p9"><span class="s6"></span><br></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">        </span></span><span class="s5">MyDebug</span><span class="s6">(</span><span class="s10">"Deferred product "</span><span class="s6"> + </span><span class="s7">product</span><span class="s6">.</span><span class="s7">definition</span><span class="s6">.</span><span class="s7">id</span><span class="s6">.</span><span class="s5">ToString</span><span class="s6">());</span></p>
<p class="p7"><span class="s6"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p15"><span class="s6"></span><br></p>
<p class="p16"><span class="Apple-tab-span">	</span>でーーー、、</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span>この関数があると、Unity IAPを使った状態でコンビニ決済にも対応できる。</p>
<p class="p16"><span class="Apple-tab-span">	</span>この関数は、次のタイミングで着火する</p>
<p class="p17"><br></p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン1 支払い前App戻り</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. ここで[App戻る]という選択肢があるが、それを押すと、OnPurchaseDefferredが着火する</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ここは課金前、キャンセル前、というものすごく中途半端な状態で、なおかつこの関数はUnityのmain threadとは別のスレッドで着火することに注意。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ここで「あーーコンビニ決済なんかつかっちゃたンゴねえ、、払い込み終わったらポイント付与します」というようなことをユーザーに伝えることができる。</p>
<p class="p17"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ちなみにここで取得できるproductには<b>receiptは付いてないです</b>。 付けてからよこせよPlayStore、、、pendingでいいからさあ、、、</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>先に言っとくが、OnPurchaseDefferredは、「ユーザーがコンビニ課金を使ったことをユーザーやサーバに知らせるためにある」ようなハンドラです。それ以外の価値はない。</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>おそらく最も頻度が高く、かつ誰も救わないルート。というか他ルートの体験はさらに悪いんだが。</p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン2-a 支払い後App戻り 早すぎた場合</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. Appをほったらかしてコンビニに行って決済する。10分 ~ 48時間で決済が完了するよ！！とか言われる</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. よくわからんなあと思ってでも決済したし早速購入結果見れるんじゃね？と思ってAppに戻ると、OnPurchaseDefferredが着火する。</p>
<p class="p16"><span class="Apple-tab-span">	</span>5. ここからさらにだいたい決済から10分くらいほっとくと、何事もなかったかのようにIStoreListenerのProcessPurchase関数がよばれ、レシートが手に入る。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>お金を払ったのに付与されるのは10分後です。ここでのOnPurchaseDefferredにはreceiptがあったりなかったりするが、正常系が動くのでもうどうでもいいというおまけ付き。</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>頻度第二位。すまない、まだなんだ。10分っつったら大体ほんとに10分かかるんだよこれ。いや日本語なんだけど、なんだけどさ、いやあ、、、</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>実際には5~8分くらいが中央値な気がします。するだけだ。1秒とかにならん？</p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン2-b 支払い後App戻り 10分待った場合</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. Appをほったらかしてコンビニに行って決済する。10分 ~ 48時間で決済が完了するよ！！とか言われる</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. よくわからんなあと思ってでも決済から10分待ち、Appに戻ると、何事もなかったかのようにIStoreListenerのProcessPurchase関数がよばれ、レシートが手に入る。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>こんなルート踏むやついる？？ いや常識的に考えてくれよ、金払ってもさらに待たされるんだぜ？</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>一番幸せになれる、最もレアなルート。10分待つけど、それをユーザーに説明できて、納得されることってあんの？</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><b>パターン2-c 支払い後App戻りしようと思ったらAppが落ちてて、10分待った場合</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. Appをほったらかしてコンビニに行って決済する。10分 ~ 48時間で決済が完了するよ！！とか言われる</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. よくわからんなあと思ってでも決済から10分待ち、Appに戻ると、おやおやおや、起動画面ですか、そうAppはなんらかの理由で落ちていたのだ。 あり得る話だろ？</p>
<p class="p16"><span class="Apple-tab-span">	</span>5. IStoreListenerのProcessPurchase関数がよばれ、レシートが手に入る。</p>
<p class="p16"><span class="Apple-tab-span">	</span>6. このレシートを検証すると、purchased状態であることがわかる。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>なので対価を付与しましょうね。</p>
<p class="p17"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ちなみに知らんうちにコンビニ決済対応しちゃってて一番多いのはこのパターンだと思う。</p>
<p class="p17"><span class="Apple-tab-span">	</span></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン3-a 支払い前AppもどりAppキル</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. ここで[App戻る]という選択肢があるが、戻ったところで「払ってね！」って言われるだけなので、Appキルするとしよう</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. キルしてから再度Appを起動し直すと、IStoreListenerのProcessPurchaseが呼ばれる。先程のコンビニ課金のレシートが手に入るんだねえ。</p>
<p class="p16"><span class="Apple-tab-span">	</span>5. このレシートを検証すると、pending状態であることがわかる。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>コンビニ決済は3日間の支払い猶予がある決済になっておりまして、</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>3日間支払われないとpending -&gt; cancelledへと状態が変化しますの。</p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このルート以外で、コンビニ課金でサーバにpending状態なreceiptが届けられるルートは無い。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ないんだ。</p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン3-b 支払い前AppもどりAppキルPlayStoreキャンセル</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. ここで[App戻る]という選択肢があるが、戻ったところで「払ってね！」って言われるだけで何も起こらないので、はあ金払いにいくかあってなってまあ行かんだろう。</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. まだ君は払ってない、けど再度Appを起動し直すと、IStoreListenerのProcessPurchaseが呼ばれる。先程のコンビニ課金のレシートが手に入るんだねえ。</p>
<p class="p16"><span class="Apple-tab-span">	</span>5. このレシートを検証すると、pending状態であることがわかる。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ここでサーバに送り込むチャンスがあることはすでに3-aで書いた。地獄はここからだ。</p>
<p class="p16"><span class="Apple-tab-span">	</span>6. ここで、おもむろにPlayStore Appから、ユーザーアイコンをおして、[お支払いと定期購入] &gt; [予算と履歴] から、購入をキャンセルしよう！どうなると思う？</p>
<p class="p16"><span class="Apple-tab-span">	</span>7. キャンセルされたら、それ以降、IStoreListenerのProcessPurchaseが呼ばれることはない。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>呼ばれないの当たり前じゃん、って思うよね。 まあね、サーバで検証とかしてなきゃこれで終わりでいいんだわ。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>で、5でサーバに送ってる場合、</p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>すでに送り込まれているpending状態のレシートを、クライアントからの更新があって検証する機会はもう生まれないんだ。</b></p>
<p class="p16"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>だからサーバサイドでバッチとかで対処しようね。</b></p>
<p class="p17"><br></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>はい。バッチ必須です。<span class="Apple-converted-space"> </span></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>もとから3日間の生存があるのでバッチ必須でしょってのはあるとしてさあ、PlayStoreからキャンセルになったよーってのが出りゃあ、それですんだんだけどなあ？</p>
<p class="p17"><br></p>
<p class="p16"><b><span class="Apple-tab-span">	</span>パターン4 支払い前PlayStoreキャンセル後App戻り</b></p>
<p class="p16"><span class="Apple-tab-span">	</span>1. ユーザーがコンビニ決済を選んでApp内課金を行う = 購入するプロダクトを選ぶ</p>
<p class="p16"><span class="Apple-tab-span">	</span>2. するとAppから別画面に切り替わり、「コンビニに行って決済しよう！」という画面にいく</p>
<p class="p16"><span class="Apple-tab-span">	</span>3. ここでおもむろにPlayStore Appから、ユーザーアイコンをおして、[お支払いと定期購入] &gt; [予算と履歴] から、購入をキャンセルしよう！どうなると思う？2</p>
<p class="p16"><span class="Apple-tab-span">	</span>4. これ以降どこにも何のreceiptも飛ばなくなる。</p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>キャンセルするならいっそAppに戻らなければいいのですわ。</p>
<p class="p17"><span class="Apple-tab-span">	</span></p>
<p class="p16"><span class="Apple-tab-span">	</span>えーーこれ以外にも色々あるが</p>
<p class="p16"><span class="Apple-tab-span">	</span>とりあえずもういいだろ。</p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p12"><br></p>
<p class="p13"><b>good end route</b></p>
<p class="p13"><span class="Apple-tab-span">	</span>えー、コンビニ決済、正直、対応するうまみがないです。</p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p13"><span class="Apple-tab-span">	</span>なのでApp単位でGoogleに言って拒否するのが最もまともなエクスペリエンスを提供できるぞ。</p>
<p class="p13"><span class="Apple-tab-span">	</span>どういうことだよ、、、って思うけどさあ、</p>
<p class="p13"><span class="Apple-tab-span">	</span>このコロナ禍にコンビニまで行ってPlayCardを買う以外の手段がさらに5分以上ユーザーを待たせるのを正当化できないなーっておもった。</p>
<p class="p12"><br></p>
<p class="p13"><span class="Apple-tab-span">	</span>対応しない方が世界に良い。稀有稀。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p13"><b>捕捉</b></p>
<p class="p13"><span class="Apple-tab-span">	</span>いろんなAppがコンビニ決済を蹴れている（対応していません）表示になるのだよな。きみはどう？</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p13"><b>メモ</b></p>
<p class="p12"><br></p>
<p class="p13">GooglePlayPluginsを追加</p>
<p class="p13"><a href="https://github.com/google/play-unity-plugins/releases/download/v1.5.0/google-play-plugins-1.5.0.unitypackage">google-play-plugins-1.5.0.unitypackage</a></p>
<p class="p13">https://github.com/google/play-unity-plugins/releases</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p13">そもそもちゃんと動いてない。</p>
<p class="p13">Google &gt; ウィンドウ、、からめっちゃエラーが出る。</p>
<p class="p12"><br></p>
<p class="p13">これは結論から言うと誰も使わなくていいやつだった。</p>
<p class="p13">なんだこの公式ドキュメントは。</p>
<p class="p12"><br></p>
<p class="p13">-&gt; 古いまま対応されてないだけ。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p12"><br></p>
</body>
</html>
