<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1504.83">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; color: #000000; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Sans'; color: #000000; background-color: #ebebeb}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Sans'; color: #000000; background-color: #ffffff; min-height: 17.0px}
    span.s1 {font-kerning: none}
    span.s2 {font-variant-ligatures: no-common-ligatures}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>GKEで遊ぶ時の手順</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>メモまでに、GKEで遊ぶ/遊んだ時のいろいろを書いておく。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>SDK入れる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>gcloud何ちゃら入れる</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>クラスタ用意する</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://console.cloud.google.com/kubernetes/">https://console.cloud.google.com/kubernetes/</a></p>
<p class="p3"><span class="Apple-tab-span">	</span>から頑張る</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>ContainerRegistryにアップするDocker imageを作る</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ふつーにbuildで作成する。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>作成したimageをContainerRegistryにアップする</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>タグつけてgcloudコマンドでアップ。タグつけるときにtagをつけなければ自動的にlatestがつく。</p>
<p class="p4"><span class="s1">docker tag image_name asia.gcr.io/project_name/image_name:tag</span></p>
<p class="p4"><span class="s1">gcloud docker --push asia.gcr.io/project_name/image_name</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>ContainerRegistryにアップしたコンテナをGKEで使う</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>さきほどpushしたものがgcloudから検知できるかチェック</p>
<p class="p4"><span class="s2">gcloud container images list-tags asia.gcr.io/</span><span class="s1">project_name</span><span class="s2">/</span><span class="s1">image_name</span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、なんかヒットするはず。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>Deploymentを作成してGKEへとデプロイ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>手元のマシンのkubectlの設定を変え、接続対象をGKEの特定のクラスタへと変更する。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>まずはkubectlの現在のコンテキスト(接続先)を確認。</p>
<p class="p4"><span class="s2">kubectl config current-context</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、接続先がGKEの意図したクラスタでない場合、gcloudコマンドを使ってそのパラメータを変更する。</p>
<p class="p4"><span class="s2">gcloud container clusters get-credentials your_cluster_name --zone your_zone</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>この状態でもう一度current-contextをみると、変わっているはず。</p>
<p class="p5">gke_your_project_name_asia-east1-a_your_cluster_name</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>つまりクラスタ毎にデプロイしたい場合はこれらのコマンドを使っていちいちクラスタ切り替えないと行けないわけだね。</p>
<p class="p3"><span class="Apple-tab-span">	</span>手元からやるもんじゃねーな。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>role.json</b></p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">   </span>"apiVersion": "extensions/v1beta1",</p>
<p class="p5"><span class="Apple-converted-space">   </span>"kind": "Deployment",</p>
<p class="p5"><span class="Apple-converted-space">   </span>"metadata": {</p>
<p class="p5"><span class="Apple-converted-space">      </span>"name": "role-deployment",</p>
<p class="p5"><span class="Apple-converted-space">      </span>"labels": {</p>
<p class="p5"><span class="Apple-converted-space">         </span>"app": "role"</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p5"><span class="Apple-converted-space">   </span>},</p>
<p class="p5"><span class="Apple-converted-space">   </span>"spec": {</p>
<p class="p5"><span class="Apple-converted-space">      </span>"replicas": 1,</p>
<p class="p5"><span class="Apple-converted-space">      </span>"selector": {</p>
<p class="p5"><span class="Apple-converted-space">         </span>"matchLabels": {</p>
<p class="p5"><span class="Apple-converted-space">            </span>"app": "role"</p>
<p class="p5"><span class="Apple-converted-space">         </span>}</p>
<p class="p5"><span class="Apple-converted-space">      </span>},</p>
<p class="p5"><span class="Apple-converted-space">      </span>"template": {</p>
<p class="p5"><span class="Apple-converted-space">         </span>"metadata": {</p>
<p class="p5"><span class="Apple-converted-space">            </span>"labels": {</p>
<p class="p5"><span class="Apple-converted-space">               </span>"app": "role"</p>
<p class="p5"><span class="Apple-converted-space">            </span>}</p>
<p class="p5"><span class="Apple-converted-space">         </span>},</p>
<p class="p5"><span class="Apple-converted-space">         </span>"spec": {</p>
<p class="p5"><span class="Apple-converted-space">            </span>"containers": [</p>
<p class="p5"><span class="Apple-converted-space">               </span>{</p>
<p class="p5"><span class="Apple-converted-space">                  </span>"name": "role",</p>
<p class="p5"><span class="Apple-converted-space">                  </span>"image": "asia.gcr.io/dev-milive/dev-role",</p>
<p class="p5"><span class="Apple-converted-space">                  </span>"ports": [</p>
<p class="p5"><span class="Apple-converted-space">                     </span>{</p>
<p class="p5"><span class="Apple-converted-space">                        </span>"containerPort": your_port2</p>
<p class="p5"><span class="Apple-converted-space">                     </span>},</p>
<p class="p5"><span class="Apple-converted-space">                     </span>{</p>
<p class="p5"><span class="Apple-converted-space">                        </span>"containerPort": your_port</p>
<p class="p5"><span class="Apple-converted-space">                     </span>}</p>
<p class="p5"><span class="Apple-converted-space">                  </span>]</p>
<p class="p5"><span class="Apple-converted-space">               </span>}</p>
<p class="p5"><span class="Apple-converted-space">            </span>]</p>
<p class="p5"><span class="Apple-converted-space">         </span>}</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p5"><span class="Apple-converted-space">   </span>}</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、kubectl apply コマンドでデプロイできる。</p>
<p class="p5">kubectl apply -f role.json</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>この時点でGKEのページからデプロイ済みの確認が取れた。ノードの詳細画面の一番下にデプロイされてるのを確認。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>role.jsonには次のようなパラメータをセットしてたんだけど、</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">   </span>"apiVersion": "extensions/v1beta1",</p>
<p class="p5"><span class="Apple-converted-space">   </span>"kind": "Deployment",</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これ、なんでextensions/v1beta1 とかになるんだろう。minikubeでやってたみたいにapps/v1ではいけないんだろうか？</p>
<p class="p3"><span class="Apple-tab-span">	</span>-&gt; ここの設定に則ってるっぽい。 k8s公式。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://kubernetes.io/docs/reference/generated/federation/extensions/v1beta1/definitions/">https://kubernetes.io/docs/reference/generated/federation/extensions/v1beta1/definitions/</a></p>
<p class="p2"><b></b><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p3"><b>デプロイ済みの要素にアクセスする</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>次に、外部からアクセスできるようにserviceを設定する。このへんもjson書いてやる。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p6"><span class="s2">kubectl create -f svc_role.json<span class="Apple-converted-space"> </span></span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>複数のポートの指定もできてると思うんだけど、アクセスができない。なんでだろ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>https以外でのアクセスができない + コンテナがそれに対応してない的な？</p>
<p class="p3"><span class="Apple-tab-span">	</span>-&gt; 違った。</p>
<p class="p2"><br></p>
<p class="p5">kubectl expose deployment -l app=role -p your_port --type "LoadBalancer"</p>
<p class="p3"><span class="Apple-tab-span">	</span>とかダイレクトにやったら接続できた。やったぜ！</p>
<p class="p3"><span class="Apple-tab-span">	</span>ということはファイルで書いたServiceの記述がまちがっている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>差</p>
<p class="p6"><span class="s2">x role<span class="Apple-converted-space">    </span>LoadBalancer <span class="Apple-converted-space">  </span>10.35.248.38 <span class="Apple-converted-space">  </span>104.199.151.125 <span class="Apple-converted-space">  </span>your_port2:30247/TCP,your_port:30368/TCP <span class="Apple-converted-space">  </span>12h</span></p>
<p class="p6"><span class="s2">o role-deployment <span class="Apple-converted-space">  </span>LoadBalancer <span class="Apple-converted-space">  </span>10.35.250.167 <span class="Apple-converted-space">  </span>35.229.178.174 <span class="Apple-converted-space">  </span>your_port:31518/TCP <span class="Apple-converted-space">  </span>2m</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なるほど、exposeしてる対象が異なるのか。さらになんか違いそう。</p>
<p class="p6"><span class="s2">kubectl expose deployment role-deployment --port=your_port,your_port2 --type="LoadBalancer"</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>とかだと複数portいけた。やったぜ。で、</p>
<p class="p3"><span class="Apple-tab-span">	</span>じゃあこれはどんなデータになってるんだろう、、、jsonにできないとつらいぞ、、</p>
<p class="p3"><span class="Apple-tab-span">	</span>-&gt; get svc 名前 -o yamlで取り出して云々して比較した。jsonでも取り出せる？ -&gt; 出せた。</p>
<p class="p7"><span class="s2"></span><br></p>
<p class="p6"><span class="s2">kubectl get svc role-deployment -o json</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ということで、一度コマンドラインで作ってからうまくいったらjsonにして云々みたいなテクを覚えた。</p>
<p class="p3"><span class="Apple-tab-span">	</span>いい感じに動くようになった～～わーい。</p>
<p class="p3"><span class="Apple-tab-span">	</span>最終的なサービスを作成するためのjsonはこれ</p>
<p class="p2"><br></p>
<p class="p3"><b>svc_role.json</b></p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>"apiVersion": "v1",</p>
<p class="p5"><span class="Apple-converted-space">    </span>"kind": "Service",</p>
<p class="p5"><span class="Apple-converted-space">    </span>"metadata": {</p>
<p class="p5"><span class="Apple-converted-space">        </span>"labels": {</p>
<p class="p5"><span class="Apple-converted-space">            </span>"app": "role"</p>
<p class="p5"><span class="Apple-converted-space">        </span>},</p>
<p class="p5"><span class="Apple-converted-space">        </span>"name": "role-deployment"</p>
<p class="p5"><span class="Apple-converted-space">    </span>},</p>
<p class="p5"><span class="Apple-converted-space">    </span>"spec": {</p>
<p class="p5"><span class="Apple-converted-space">        </span>"ports": [</p>
<p class="p5"><span class="Apple-converted-space">            </span>{</p>
<p class="p5"><span class="Apple-converted-space">                </span>"name": "p1",</p>
<p class="p5"><span class="Apple-converted-space">                </span>"port": your_port</p>
<p class="p5"><span class="Apple-converted-space">            </span>},</p>
<p class="p5"><span class="Apple-converted-space">            </span>{</p>
<p class="p5"><span class="Apple-converted-space">                </span>"name": "p2",</p>
<p class="p5"><span class="Apple-converted-space">                </span>"port": your_port2</p>
<p class="p5"><span class="Apple-converted-space">            </span>}</p>
<p class="p5"><span class="Apple-converted-space">        </span>],</p>
<p class="p5"><span class="Apple-converted-space">        </span>"selector": {</p>
<p class="p5"><span class="Apple-converted-space">            </span>"app": "role"</p>
<p class="p5"><span class="Apple-converted-space">        </span>},</p>
<p class="p5"><span class="Apple-converted-space">        </span>"type": "LoadBalancer"</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>教訓:</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>・deploymentにつける名前とserviceにつける名前で一致してないと行けない部分がある。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>・selectorについてもっと学ぶ必要がある。どんな指向性してるんだかをもっと把握しないとな＝～。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>ContainerBuilderを使ってコードからDockerImageをビルド(おまけ)</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ビルドリクエストを出してDocker imageを生成する。</p>
<p class="p3"><span class="Apple-tab-span">	</span>githubとかから引っ張り出して実行できる模様。</p>
<p class="p3"><span class="Apple-tab-span">	</span>このへんのパイプラインを構築しないとな。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>少なくともcontainerRegistryへのアップとかは手元からやるルートと自動化ルートの両方が欲しい。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
