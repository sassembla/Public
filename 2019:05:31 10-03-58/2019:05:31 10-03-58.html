<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>ARKitRemoteが使いづらかったのでA-npanRemoteというのを作った</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>発音は[あ～んぱんリモート]。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>リポジトリはこれ</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/A-npanRemote">https://github.com/sassembla/A-npanRemote</a></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>名前にハイフンが使えて大満足。Unity内でも問題なかった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>由来はARです。イニシャルが。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>原因</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity標準のARKitRemoteの、接続をする、ボタンを押す、動作する、、、みたいなのが本当に最悪の体験だった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>なんか切れたり落ちたりするし、接続自体に失敗するみたいなのまである。これではダメだ。こんなダメな体験で人生を無駄にしてはいけない。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ということで目指したのは以下</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・エディタ上でARKitを使うコードを書いたら自動的にARKitサーバが立ち上がるようにする</p>
<p class="p3"><span class="Apple-tab-span">	</span>・ARKitを動かすiOSアプリ側からいつでも、何回でも接続、再接続できる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・無線で接続できる。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>構造</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>まず、iOS ARKit実行機からはUnity Editorに接続することにした。</p>
<p class="p3"><span class="Apple-tab-span">	</span>これはまあ、エディタで動いてる時しか使わんでしょみたいな感じ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>接続にはWebSocketを使う。そのため、iOS側にはWSクライアント、エディタにはWSサーバが立つ。</p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>概念的に書くとこんな感じ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>iOS ARkit -ws-&gt; Unity Editor</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>WSサーバは結構軽量なんで、ユーザーがエディタのPlayを押したら起動、Stopを押したら落とす、みたいな感じにした。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>次にPlay中にARKitを使うところまできたら &amp;&amp;<span class="Apple-converted-space">  </span>iOS ARKitからのインプットが来ていたら、自動的にiOS ARKitのインプットをPlay中のアプリに流し込みたかった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>で、エディタとPlay中のアプリの接続には、やっぱりWebSocketを使った。</p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>概念的に書くとこんな感じ2</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>iOS ARkit -ws-&gt; Unity Editor &lt;-ws- Player</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>面白くなってきやがったぜ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>最終的なデータフローとしては、上記を実装した上で、iOS -&gt; Editorで中継してPlayerに流し込む という単純なものになっている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>この構造ならiOS側が切断しようがPlayer側が切断しようが、どちらかが復帰したタイミングでデータを流せる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>展望</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>現状はただARKitについて動くだけなんで、今後はOculus Questの視界とかコントローラとかをUnity Editorにほうり込めるようにする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>WebSocketサーバで自前のやつがあったんだけど権利の関係でちょっと改修が必要で、現在はFleckというMITライセンスのライブラリに依存している。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>MSの用意してるWebSocketサーバのAPI実装はリクエストヘッダ付きのモバイルからの通信に対してちゃんと動作しなかったので無視する。出来が悪い。</p>
<p class="p3"><span class="Apple-tab-span">	</span>みんなSocketを使って実装してるぞ。ハイレベルなAPIなんか使い物にならないから使われてないぞ。俺も使ってないが。君はどうだ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
