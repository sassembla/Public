<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.37">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'; color: #ff2500}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    span.s1 {font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.s2 {font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #000000}
    span.s3 {font: 12.0px Helvetica}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>TypeScriptでChromeのExtension書いてハマったとこメモ</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ChromeExtensionをTypeScriptで書いてみてた。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>TypeScript化しつつあるブツはこちら。</p>
<p class="p3"><span class="Apple-tab-span">	</span>SublimeSocketでのTypeScriptコンパイル機構</p>
<iframe src="http://player.vimeo.com/video/63188211" width="500" height="281" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe> <p><a href="http://vimeo.com/63188211">SublimeSocket TypeScript ChromeClient 0.5.0</a> from <a href="http://vimeo.com/user7525164">Vimeo</a>.</p>

<p class="p2"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span></b>ChromeExtensionsのJSをTypeScript化することのメリットは、今回の場合下記を目論みつつ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・クラス！！　クラス！！　クラスがホシイ！　デフォで！！</p>
<p class="p3"><span class="Apple-tab-span">	</span>・extendsを使った振る舞いの置き換えが簡単に素敵！</p>
<p class="p3"><span class="Apple-tab-span">	</span>・コンパイル時型チェックあるしミスに気付くチャンス増えてラク</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>既存のTypeScriptedなChromeExtensionはこちら。</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/SublimeSocket/tree/dev/tool/chromeClients/TypeScriptClient">https://github.com/sassembla/SublimeSocket/tree/dev/tool/chromeClients/TypeScriptClient</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Chromeで開いたファイルをtailして結果をWebSocketで投げるやつ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>とりあえず自分が欲しい機能と、各言語版への記述拡張のための要件は満たした。</p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>Coffeeじゃ駄目なの？</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>いんじゃね。</p>
<p class="p2"><br></p>
<p class="p3"><b>ハマったとこ列挙してく</b></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>1.chrome.*とのお付き合い</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>TypeScriptさんはchromeなにやらのことを知らないので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>declareで何が来ても吃驚せずコンパイルしてもらう事にします。</p>
<p class="p2"><br></p>
<p class="p4">declare var chrome;</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p4">chrome.browserAction.onClicked.addListener(function(tab) {};</p>
<p class="p4">chrome.windows.getAll (function(windows) {});</p>
<p class="p4">chrome.browserAction.setIcon({path:"images/icon-inactive.png"});</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>とかがTS内で使えるようになるので、他の、かっちり構造的にすべきところに注力する事が出来る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>他にはWIndow系とかがあるけどこの辺はもう普通のTSの使い方と変わらんす。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>d.tsを探せばどっかあるだろとか思ったんですが、なかなか変化しそう+使用するメソッドも関数渡しがメインだったので、今回は使ってないです。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ちなみにd.tsをつくった方、こちら。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b><span class="Apple-tab-span">	</span>borisyankov / DefinitelyTyped</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/borisyankov/DefinitelyTyped">https://github.com/borisyankov/DefinitelyTyped</a></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>の、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/borisyankov/DefinitelyTyped/pull/93/files">https://github.com/borisyankov/DefinitelyTyped/pull/93/files</a></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>あたり。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このひとすげーな。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>2.extendsとロード順</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ChromeのExtension、使用するjsをmanifest.jsonに定義するところについて。</p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>~中略</p>
<p class="p4"><span class="Apple-converted-space">    </span>"background": {</p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span><b>"scripts": [</b></p>
<p class="p5"><b><span class="Apple-converted-space">            </span>"Something.js"</b></p>
<p class="p5"><b><span class="Apple-converted-space">        </span>]</b></p>
<p class="p4"><span class="Apple-converted-space">    </span>},</p>
<p class="p4"><span class="Apple-tab-span">	</span>~中略~</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>とか書くわけだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>TypeScriptで、</p>
<p class="p3"><span class="Apple-tab-span">	</span>クラスParentとクラスChild(ChildはParentをextendsする、みたいなとき、</p>
<p class="p2"><br></p>
<p class="p4">class Child extends Parent {</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p4">class Parent {</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>scriptsのロード順（！）を気にする必要がある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>manifest.jsonファイル内のscripts配列の要素のアタマから順に読んでるんだと思うので、</p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>"background": {</p>
<p class="p4"><span class="Apple-converted-space">        </span>"scripts": [</p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">           </span><b> </b></span><b>"Parent.js", "Child.js"</b></p>
<p class="p4"><span class="Apple-converted-space">        </span>]</p>
<p class="p4"><span class="Apple-converted-space">    </span>},</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、実際のクライアント上でもちゃんと動く。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>読み込む順にv8に喰わせてるかなんかだと思うので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>順番をChild.js -&gt; Parent.js とかにすると、Parentなんか知らねーよ、とエラーで怒られる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>もちろんTS自体のコンパイル正否とは無関係に。</p>
<p class="p3"><span class="Apple-tab-span">	</span>複雑になってくると詰む。面倒くさくて。<span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>→extends関係を考慮して云々するより、concatnateしてしまえばいいじゃない！</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>と思ったんだけど、これはこれで下記3のカドに小指がぶつかる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>3.--outオプションによる死亡</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>コンパイル物を1ファイルに纏めるべく、tscに--outオプションを付けるなどすると、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Extension読み込み時に</p>
<p class="p6"><span class="s2"><span class="Apple-tab-span">	</span></span>Uncaught TypeError: Cannot read property 'prototype' of undefined</p>
<p class="p3"><span class="Apple-tab-span">	</span>が、出る。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>原因箇所はこんな感じ。<span class="Apple-tab-span">	</span></p>
<p class="p7"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202013-04-10%2023.57.02.png" alt="スクリーンショット 2013-04-10 23.57.02.png"></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>条件としては、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・extendsを使用している</p>
<p class="p3"><span class="Apple-tab-span">	</span>・--outで固める</p>
<p class="p3"><span class="Apple-tab-span">	</span>の組み合わせ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>一発で読んじゃえばいいじゃない→中身の順番でアバー　というパターンにハマった。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>extends自体の定義で問題が起きてる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ちゃんと読むとかすれば解決できると思うけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>manifest.json のscrptsの記述順番による解決の方がなんぼかラクだったので、日和って回避した。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ChromeExtensionsでのコードが大規模になった時(って来るの？　来ないでしょ)不味い。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>例では、class WS　が class WSControlBasement をextendsしてるので、そのための定義順だと思うが、</p>
<p class="p3"><span class="Apple-tab-span">	</span>extendsされるクラスが先に定義されてないから駄目なんじゃないかなあと思うなど。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>あっ名前については見逃してください、、あくまで仮です。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>他に、staticとかもヤバい予感がする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>順番指定して--out、とかもイヤな話だしなあ、、</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>オプションについては下記が自分の覚えてるすべてなので、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://sassembla.github.io/Public/2012:10:20%2022-46-41/2012:10:20%2022-46-41.html">http://sassembla.github.io/Public/2012:10:20%2022-46-41/2012:10:20%2022-46-41.html</a></p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>現行のオプションを試すともっといろいろ面白い事が出来るかもしれない。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>コレ書いてる時の最新、0.8.3では、tsc.jsの24502行目から先につらつら書いてある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>無くなってるオプションもけっこうあるような。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="s3"><b>4.chrome.*</b></span><b>で発生したエラーのデバッガでの表示位置が微妙にずれる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>chro<span class="s3">m</span>e.*系のメソッドは、TSからはdeclareしてるだけだと、特にそれらのメソッドについての型チェックが行われるわけではない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>chrome.*をd.tsで定義してればまともに出る、、かなあ、、　sourcemapの出番だよなー。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>いちおうどうズレるかの例として、</p>
<p class="p3"><span class="Apple-tab-span">	</span>chome.browderAction.onClicked に渡すパラメータを間違えると、下記エラーが出て、エラー行の表示が可能なのだが、</p>
<p class="p7"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202013-04-11%2017.36.24.png" alt="スクリーンショット 2013-04-11 17.36.24.png"></p>
<p class="p3"><span class="Apple-tab-span">	</span>正し、エラー行の表示は原因行から若干”上”の行になる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>下の画像では、console.logで出た事になってる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>このTips、ぶっちゃけts関係ない。</p>
<p class="p7"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202013-04-11%2017.36.34.png" alt="スクリーンショット 2013-04-11 17.36.34.png"></p>
<p class="p3"><b>以上！</b></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
</body>
</html>
