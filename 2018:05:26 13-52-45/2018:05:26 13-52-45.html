<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>AVAudioSessionCategoryPlayAndRecordと接続機器ごとの音量</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ハマっていたのではい。</p>
<p class="p3"><span class="Apple-tab-span">	</span>このモードだと出力される音量に制限がかかる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>その制限がいろいろ接続機器で変わるね～という話。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>要件</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.マイクを使って録音したい</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>→AVAudioSessionに対して AVAudioSessionCategoryPlayAndRecord をセットする</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>これは、Unityでmicrophoneクラスを使ってRecordとかやった場合も同じ挙動になる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このカテゴリーの最中、iOSから出力されるオーディオは、最大音量にしてだいたい70%カットくらいのキャップをセットされる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>理屈としてはまあそりゃそうで、録音してるはずなんでスピーカーから変な音出さんほうがええやろ、という。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>この状態で音が出るのは録音と同時に音が出る、プレイバック用途っぽい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>で、この状態だと、どんな出力装置が「どう」iPhoneに接続されているかで音量に対するキャップの挙動が変わる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>2.録音した音を別の端末で再生したい</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>したかった。1で録音、そんで別端末で再生。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>まずは、1の、どんな出力装置が「どう」AVAudioSessionCategoryPlayAndRecord カテゴリ中のiPhoneに接続されているかで、</p>
<p class="p3"><span class="Apple-tab-span">	</span>音量に対するキャップの挙動が変わる という話から。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>接続なんもなし</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>iPhoneに特別なんの出力装置も接続しない場合、iPhoneのスピーカーから出力される音量は、</p>
<p class="p3"><span class="Apple-tab-span">	</span>AVAudioSessionのカテゴリの影響 ＝ 音量キャップ を受ける。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>スピーカー、ヘッドフォンがプラグで刺されている場合</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>キャップなしの音量でサウンドが再生される。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・録音中な可能性もあるけど、別に出力装置をつないでそっちで音がでるくらいええやろ</p>
<p class="p3"><span class="Apple-tab-span">	</span>・オーディオアウトの処理に対してそのまま音を出す</p>
<p class="p3"><span class="Apple-tab-span">	</span>みたいな考慮がされてる気がする。</p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>スピーカー、ヘッドフォンが、Lightning端子、無線で接続されている場合</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>面白いのは、、これだ、、！！</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>LightningかBluetoothでヘッドフォンをつなぐ場合、そのスピーカー、ヘッドフォンから出る音量は、</p>
<p class="p3"><span class="Apple-tab-span">	</span>AVAudioSessionのカテゴリの影響 ＝ 音量キャップ を受ける。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なぜなのか。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>ドキュメント</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://developer.apple.com/documentation/avfoundation/avaudiosessioncategoryplayandrecord">https://developer.apple.com/documentation/avfoundation/avaudiosessioncategoryplayandrecord</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>特にそういう無線接続した場合のみうんぬんみたいなデフォルト挙動については特に書いてない。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AVAudioSessionCategoryOptionDefaultToSpeaker とかの、AVAudioSessionCategoryPlayAndRecordカテゴリの時だけ有効なオプションを追っていくと把握できそう。</p>
<p class="p3"><span class="Apple-tab-span">	</span>今回はデフォルト(オプションなし)だったので、この挙動だったぽい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>あとはまーー、、もう音声出力のプラグって新しいiPhone機種にはないので、無線出力も既存スピーカーといっしょくたに扱おう、みたいなのがデフォルトなのかも。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>要件１のまとめ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・AVAudioSessionCategoryPlayAndRecord カテゴリだと、音量にキャップがつく</p>
<p class="p3"><span class="Apple-tab-span">	</span>・接続機器が有線か無線かでキャップの処理に差がでる</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>有線プラグで接続して不意に爆音が出て死にかけた。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>つづいて要件2。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>2.録音した音を別の端末で再生したい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここでは、AVAudioSessionCategoryPlayAndRecord カテゴリで録音した音をファイルとかに吐き出して、</p>
<p class="p3"><span class="Apple-tab-span">	</span>別端末で受け取って再生する、みたいなことをする。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p3"><span class="Apple-tab-span">	</span>当然だけど、AVAudioSessionCategoryPlayAndRecord で録音した「音」それ自体には、同カテゴリ特有のキャップはかかっていない。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>再生側でばふつーに録音時の音量で再生される、ということがわかった。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
</body>
</html>
