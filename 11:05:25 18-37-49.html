<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1138.23">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    span.s1 {font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><span class="Apple-converted-space"> </span>asakusaDSL</p>
<p class="p2"><br></p>
<p class="p3">本気で中身を説明</p>
<p class="p3">コンパイラの流れ</p>
<p class="p2"><br></p>
<p class="p1">Github</p>
<p class="p1"><span class="Apple-tab-span">	</span>https://github.com/ashigeru/asakusafw/tree/SCR-01</p>
<p class="p2"><br></p>
<p class="p1">Gist</p>
<p class="p1"><span class="Apple-tab-span">	</span>https://gist.github.com/988810</p>
<p class="p2"><br></p>
<p class="p4"><br></p>
<p class="p3"><b>コンパイラ３種</b></p>
<p class="p1"><span class="Apple-tab-span">	</span>DataModelDefinitionLangage</p>
<p class="p1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>DMDL<span class="s1">は</span>RDBMS<span class="s1">からの</span>Model<span class="s1">を生成するのではなく、</span>Data Model Definition Language<span class="s1">から</span>Model<span class="s1">を生成するユーティリティ</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>OperatorDSL</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>演算子くらいの定義、中くらいのサイズ</p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>FlowDSL</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>データフローを作り、M/Rに流す</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p4"><b></b><br></p>
<p class="p3"><b>コンパイラの基礎</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span></b>ソースコードからターゲットコードを書く</p>
<p class="p3"><span class="Apple-tab-span">	</span>Source→Syntax→Semantic→Target</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>↑この辺に最適化</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>↑他のコードとの関連性を積込むのもこの辺。</p>
<p class="p4"><b></b><br></p>
<p class="p3"><b>Asakusaの構造</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>DMDL</p>
<p class="p3"><span class="Apple-tab-span">	</span>→OperatorDSL (Javaのアノテーション　JSR269)</p>
<p class="p3"><span class="Apple-tab-span">	</span>→FlowDSL(JavaDSL)　一度此処でJavaとして動かして、結線情報とか取得してる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>→(よくわからんかった)</p>
<p class="p4"><br></p>
<p class="p3">DMDL</p>
<p class="p3"><span class="Apple-tab-span">	</span>データモデル構造の、Obj-Cのカテゴリを使える</p>
<p class="p3"><span class="Apple-tab-span">	</span>(JSONの構造してる)ところに、プラスしたりとかされる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>＊+演算子とかを使ってるので、演算子の意味を解説する必要がある</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3">ソース</p>
<p class="p4"><br></p>
<p class="p3"><b>DMDL</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>DMDL.java</p>
<p class="p3"><span class="Apple-tab-span">	</span>https://github.com/ashigeru/asakusafw/blob/SCR-01/asakusa-dmdl-java/src/main/java/com/asakusafw/dmdl/java/Main.java</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>DMDLAnalyzerクラスに、modelを追加</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>→各モデルクラスで、参照を見る、依存性を見る</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>→TopologicalSort</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>依存関係に順位を降り、若い順位から解析する。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>JavaのServiceLoaderクラスをよく使ってる</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>外部に足を出せる</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ConcreteModelEmitter[1.10]</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p4"><br></p>
<p class="p3"><b>OperatorDSL</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Javaの制約でメソッドをオブジェクト化できないので、演算子のオブジェクトを生成するFacrotyを生成している。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>APTでつかってる、Java６のプリプロセッサ(アノテーションの解釈とかするやつ)がある。これは楽しそう。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>→特定のクラスを登録しておいて、起動前にクラスロードしてナンカする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>SPIとして登録して、<span class="Apple-tab-span">	</span>演算子の解決を行う。</p>
<p class="p3"><span class="Apple-tab-span">	</span>OperatorDSLとFlowDSLに足すと、演算子を足す事が出来る</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>→c++での演算子オーバーロードみたいな事をしてるのと、足せるって事、かな。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>*AsakusaFrameworkはEclipseでも使えるよ。</p>
<p class="p4"><br></p>
<p class="p3">エントリポイント</p>
<p class="p3"><b>OperatorCompiler[2.6]</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>注釈プロセッサでやる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>☆特定の注釈が着いてるメソッド一覧を取得出来たりする</p>
<p class="p4"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>OperatorDSL</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>→FlowDSL用のプログラムを作成する</p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>演算子等の、「そいつ自身のクラス化」を行うプログラムを生成する</p>
<p class="p3"><span class="Apple-tab-span">	</span>ファクトリで作られるクラスと、ファクトリを書き出す</p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>Flow部品の中でさらに別のFlow部品を使っていると、本来必要な筈の物が、<span class="Apple-tab-span">	</span>未だ無くて一度こける。</p>
<p class="p3"><span class="Apple-tab-span">	</span>注釈プロセッサのファイラーという機能がトリガーになって、出た物を纏めてコンパイルする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>(トポロジカルソートで検出すべきものが全て出切るまで、この行程が繰り返される)</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>jflexっていうなんかがある(演算子定義とか書けるやつ？　Cのlexと同じな構文)</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><b>FlowDSL</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>フローを並べて処理するやつ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>処理順等を踏まえたグラフを作成して、M/Rに切って、流す</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>FlowGraph→StageGraph→JobFlowModel→MRのJobを記述したJavaを作る</p>
<p class="p3"><span class="Apple-tab-span">	</span>→</p>
<p class="p3"><span class="Apple-tab-span">	</span>WorkFlowとして固めて、Java吐く</p>
<p class="p3"><span class="Apple-tab-span">	</span>→実行ェ、、、</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3">エントリポイントからテスト</p>
<p class="p3"><span class="Apple-tab-span">	</span>DirectBatchCompiler</p>
<p class="p3"><span class="Apple-tab-span">	</span>学べる事としては、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Mainはやっぱ避けた方が良い</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・assertの使い方がやっと判ったw</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>assert a != null;　とか。</p>
<p class="p4"><br></p>
<p class="p3">What is this:</p>
<p class="p3"><span class="Apple-tab-span">	</span>基幹系を抱える会社での、売り上げとかを総合するしくみ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>M/Rを、会社向けにインターフェース化する役割を持たされたもの。</p>
<p class="p3"><span class="Apple-tab-span">	</span>効率的な分配を、簡単な手続き(データを放り込む)に纏めている。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>いるかなーーーこれーーーーー。。。</p>
<p class="p4"><br></p>
<p class="p3">StagePlanner</p>
<p class="p3"><span class="Apple-tab-span">	</span>結線検査とか、グラフの書き換え(部分最適化？　プラグインで実装？)とか、</p>
<p class="p3"><span class="Apple-tab-span">	</span>多層化したFlowGraphの平坦化</p>
<p class="p3"><span class="Apple-tab-span">	</span>ステージ区切り（R→Rとかがあったら一度区切らないと、とか。）</p>
<p class="p4"><br></p>
<p class="p3">採番演算子→チェックポイントを</p>
<p class="p3"><span class="Apple-tab-span">	</span>volatile</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>一回しか呼ばれてはいけない</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>(一回でなければいけない処理)</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3">☆ホワイトボードに書くというのは、絵が足りないという事</p>
<p class="p4"><br></p>
<p class="p3">これは名言だなあ。</p>
<p class="p4"><br></p>
<p class="p3">MapSideJoin</p>
<p class="p3"><span class="Apple-tab-span">	</span>マッパーでの統合処理(振り分ける前に殺す)</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3">依存性がないアクションに対して、同じステージで良いように合成する（＝MRの重度を減らす）</p>
<p class="p4"><br></p>
<p class="p3">コードのコンパイル作業の再帰、っていう感じだな</p>
<p class="p3">これをイベントととらえられれば、もっとすっきり書けそうな気がする。</p>
<p class="p4"><br></p>
<p class="p3">処理を行う為の手順を因果関係から探り、</p>
<p class="p3">因果手順を"結果を求める手順の為に纏める処理を生成する為に、</p>
<p class="p3">生成する処理自体を生成する。</p>
<p class="p4"><br></p>
<p class="p3">聞けて良かった。という事は、こいつが解決しようとしているのは、</p>
<p class="p3">M/Rを使った、どういう順番でやったら良いか判らん処理を放り込むと</p>
<p class="p3">いい感じに答えを出してくれる、という処理なのね。</p>
<p class="p4"><br></p>
<p class="p3">自己組織化を行うコード。</p>
<p class="p3">自己組織化を行うコードは、コードからの意図の説明がしづらい。</p>
<p class="p4"><br></p>
<p class="p3">段階的関数化</p>
<p class="p4"><br></p>
</body>
</html>
