<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #ebebeb}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #bb2ca2; background-color: #ebebeb}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #d12f1b; background-color: #ebebeb}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #3d1d81; background-color: #ebebeb}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #ebebeb; min-height: 13.0px}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; color: #2b2f2f; min-height: 18.0px}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; color: #2b2f2f}
    span.s1 {font: 12.0px Helvetica}
    span.s2 {font-variant-ligatures: no-common-ligatures; color: #bb2ca2}
    span.s3 {font-variant-ligatures: no-common-ligatures}
    span.s4 {font-variant-ligatures: no-common-ligatures; color: #d12f1b}
    span.s5 {font-variant-ligatures: no-common-ligatures; color: #703daa}
    span.s6 {font-variant-ligatures: no-common-ligatures; color: #272ad8}
    span.s7 {font-variant-ligatures: no-common-ligatures; color: #3d1d81}
    span.s8 {font-variant-ligatures: no-common-ligatures; color: #000000}
    span.s9 {font-kerning: none; color: #bb2ca2}
    span.s10 {font-kerning: none}
    span.s11 {font-kerning: none; color: #d12f1b}
    span.s12 {font-kerning: none; color: #000000}
    span.s13 {font-kerning: none; color: #272ad8}
    span.s14 {font-kerning: none; color: #703daa}
    span.s15 {font: 12.0px 'Hiragino Sans'; font-kerning: none; background-color: transparent}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Unity5.3.2p2~3でAssetBundleがiCloudに入っちゃう暫定対策</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>このバージョンだけかどうかはわかんねーけどまとめる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ただ、検証方法がAppleの作ったGUIごしのものなのでリアルタイム性がすこし怪しく、鵜呑みにせず信じるために疑ってかかってほしい。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>症状</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>iOS用にAssetBundleビルドしてWWW.LoadCacheOrDownload で取得するとなんとデータがiCloudに載る</p>
<p class="p3"><span class="Apple-tab-span">	</span>具体的には、こうなる。</p>
<p class="p4"><span class="Apple-tab-span">	</span><img src="IMG_0816.PNG" alt="IMG_0816.PNG"></p>
<p class="p5"><br></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span></span>親にむかってなんだそのデータは！！！</p>
<p class="p3"><span class="Apple-tab-span">	</span>取得したAssetBundleが見事にiCloudに載っとる。これは死ぬぞ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>原因と解決法</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>AssetBundleをDLしたあと、iOSのアプリケーションキャッシュ内に保存する際のフラグ設定をおこなう内部APIがあったんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>その設定値がAssetBundle DL時 のみおかしかった。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Xcodeでのビルド時に、以下のファイルの関数を使っている。</p>
<p class="p2"><br></p>
<p class="p3">Filesystem.mm</p>
<p class="p6"><span class="s2">extern</span><span class="s3"> </span><span class="s4">"C"</span><span class="s3"> </span><span class="s2">int</span><span class="s3"> UnityUpdateNoBackupFlag(</span><span class="s2">const</span><span class="s3"> </span><span class="s2">char</span><span class="s3">* path, </span><span class="s2">int</span><span class="s3"> setFlag)</span></p>
<p class="p6"><span class="s3">{</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span></span><span class="s2">int</span><span class="s3"> result;</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span></span><span class="s2">if</span><span class="s3">(setFlag)</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span>{</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s5">u_int8_t</span><span class="s3"> b = </span><span class="s6">1</span><span class="s3">;</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>result = ::</span><span class="s7">setxattr</span><span class="s3">(path, </span><span class="s4">"com.apple.MobileBackup"</span><span class="s3">, &amp;b, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">);</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span>}</span></p>
<p class="p7"><span class="s8"><span class="Apple-tab-span">	</span></span><span class="s3">else</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span>{</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>result = ::</span><span class="s7">removexattr</span><span class="s3">(path, </span><span class="s4">"com.apple.MobileBackup"</span><span class="s3">, </span><span class="s6">0</span><span class="s3">);</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span>}</span></p>
<p class="p6"><span class="s3"><span class="Apple-tab-span">	</span></span><span class="s2">return</span><span class="s3"> result == </span><span class="s6">0</span><span class="s3"> ? </span><span class="s6">1</span><span class="s3"> : </span><span class="s6">0</span><span class="s3">;</span></p>
<p class="p6"><span class="s3">}</span></p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、このsetFlag、AssetBundleの保存以外にもいろいろな所からつかっているみたいなんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>AssetBundleを保存するタイミングのやつだけ、setFlag = 0 (Excludeしない)という感じで来てた。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity Japanに問い合わせたところめっちゃ早く返答がもらえて、「現状使用している方法が古いので、最新でこんなのどう？」っていうコードサンプルをもらった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>最終的に、関数を次のように書き換えると救われる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>とりあえずUnityでゲームつくっててiCloudの世話になることは無いので(暴言)</p>
<p class="p3"><span class="Apple-tab-span">	</span>固定値でexclude = YESを叩きつける。</p>
<p class="p2"><br></p>
<p class="p6"><span class="s9">extern</span><span class="s10"> </span><span class="s11">"C"</span><span class="s10"> </span><span class="s9">int</span><span class="s10"> UnityUpdateNoBackupFlag(</span><span class="s9">const</span><span class="s10"> </span><span class="s9">char</span><span class="s10">* path, </span><span class="s9">int</span><span class="s10"> setFlag)</span></p>
<p class="p6"><span class="s10">{</span></p>
<p class="p8"><span class="s12">    </span><span class="s7">NSLog</span><span class="s8">(</span><span class="s3">@"path:%s, setFlag:%d"</span><span class="s8">, path, setFlag);</span></p>
<p class="p6"><span class="s10">    </span><span class="s9">int</span><span class="s10"> FIXED_YES_NUM = </span><span class="s13">1</span><span class="s10">;</span></p>
<p class="p9"><span class="s10">    </span><span class="s9">return</span><span class="s10"> [[</span><span class="s14">NSURL</span><span class="s10"> fileURLWithPath:[</span><span class="s14">NSString</span><span class="s10"> stringWithUTF8String:path]] setResourceValue:[</span><span class="s14">NSNumber</span><span class="s10"> numberWithBool:FIXED_YES_NUM] forKey:</span><span class="s14">NSURLIsExcludedFromBackupKey</span><span class="s10"> error: </span><span class="s9">nil</span><span class="s10">] != </span><span class="s9">NO</span><span class="s10">;</span></p>
<p class="p6"><span class="s10">}</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>一応貼っておくと実行時のログは次のような感じ。</p>
<p class="p6"><span class="s10"><b>2016-02-19 17:11:39.513 ProductName[595:201891] path:/var/mobile/Containers/Data/Application/7D89FD21-A2D1-42B6-AE4C-F5559366E4B9/Library/UnityCache/Temp/f34e32a1dd7804da1921ba641bbdffb9, setFlag:1</b></span></p>
<p class="p10"><span class="s10"><b></b></span><br></p>
<p class="p6"><span class="s10"><b>2016-02-19 17:11:39.521 ProductName[595:201773] path:/var/mobile/Containers/Data/Application/7D89FD21-A2D1-42B6-AE4C-F5559366E4B9/Library/UnityCache/Temp/f34e32a1dd7804da1921ba641bbdffb9/__info, setFlag:1</b></span></p>
<p class="p10"><span class="s10"><b></b></span><br></p>
<p class="p6"><span class="s10"><b>2016-02-19 17:11:39.522 ProductName[595:201773] path:/var/mobile/Containers/Data/Application/7D89FD21-A2D1-42B6-AE4C-F5559366E4B9/Library/UnityCache/Shared/e540cdd1328b2b21e29a95405c301b9313b7c346, setFlag:0</b></span></p>
<p class="p10"><span class="s10"><b></b></span><br></p>
<p class="p6"><span class="s10"><b>2016-02-19 17:11:39.522 ProductName[595:201773] path:/var/mobile/Containers/Data/Application/7D89FD21-A2D1-42B6-AE4C-F5559366E4B9/Library/UnityCache/Temp/f34e32a1dd7804da1921ba641bbdffb9/__data, setFlag:1</b></span></p>
<p class="p10"><span class="s10"><b></b></span><br></p>
<p class="p6"><span class="s10"><b>2016-02-19 17:11:39.526 ProductName[595:201865] path:/var/mobile/Containers/Data/Application/7D89FD21-A2D1-42B6-AE4C-F5559366E4B9/Library/UnityCache/Shared/e540cdd1328b2b21e29a95405c301b9313b7c346/__info, setFlag:1</b></span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>setFlag = 0で来てるのが、AssetBundleの保存。</p>
<p class="p3"><span class="Apple-tab-span">	</span>どっかで逆転か初期値か初期値が入ってないか、な気がする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Unityへは報告ずみ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>結果</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Victory~~~~!!</p>
<p class="p4"><span class="Apple-tab-span">	</span><img src="IMG_0817.PNG" alt="IMG_0817.PNG"></p>
<p class="p5"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>追記</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>自分でも確認したい人向けに下記を用意した。</p>
<p class="p11"><span class="s10"></span><br></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>再現サンプルリポジトリ</span></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/ShaderKitchen/tree/assetbundle_debug_sorasu"><span class="s15">https://github.com/sassembla/ShaderKitchen/tree/assetbundle_debug_sorasu</span></a></span></p>
<p class="p11"><span class="s10"></span><br></p>
<p class="p11"><span class="s10"></span><br></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>プロジェクトを、ツールバーの Unidon &gt; Publish Site からビルドできる。</span></p>
<p class="p11"><span class="s10"></span><br></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>ビルド時に、Assetsフォルダと同じ階層に、UnidonWeb/AssetBundle というフォルダ+アセットバンドルが作成されるようになっている。</span></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>実機で動かす際は適当なCDNとかにそれらをアップ、DLするURLを書き換えてみてほしい。</span></p>
<p class="p11"><span class="s10"></span><br></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>アプリケーション実行時、実行時に自動的に１つのAssetBundleを取得しキャッシュしている。</span></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>キャッシュにはWWW.LoacFromCacheOrDownload を使っている。</span></p>
<p class="p11"><span class="s10"><span class="Apple-tab-span">	</span></span></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>現在までUnity5.3.2系で確認した結果おかしい感じなので、ほかのバージョンでも動かしたりしてみてほしい。</span></p>
<p class="p12"><span class="s10"><span class="Apple-tab-span">	</span>誰か。</span></p>
<p class="p11"><span class="s10"></span><br></p>
</body>
</html>
