<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>WebuSocket + nginx_luajit_WebSocket + Disque(RC)の限界値</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>時間単位でのメッセージ打ち込み量と負荷をメモまでに。</p>
<p class="p3"><span class="Apple-tab-span">	</span>テストが存在するリポジトリはこれ。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/WebuSocket">https://github.com/sassembla/WebuSocket</a></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ConnectionServerはMac内にたててある。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>環境</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>MacBook Mid2015</p>
<p class="p3"><span class="Apple-tab-span">	</span>CoreM 8GBなのでしょぼい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>クライアント: Unity Player</p>
<p class="p3"><span class="Apple-tab-span">	</span>サーバ: Unity Editor</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity 5.3.3p1</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Disque、どんな時にCPU負荷が上がるか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>serverから10,000 message / frame 以上の入力を受けた時。</p>
<p class="p3"><span class="Apple-tab-span">	</span>messageは20byte程度。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>どうも入力自体は一瞬で済むらしく、DisqueのCPU負荷が跳ね上がる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>WebSocket自体はちゃんとデータを送付できてるらしい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>100,000 message/ frame には耐えた。その際のDisqueの最大CPU使用率は65%ほど。</p>
<p class="p3"><span class="Apple-tab-span">	</span>一瞬で9%くらいまで負荷が下がるのすげーな。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>登り1,000 message/frame、下り10,000 message/frame 同時、できた</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>1クライアントに対してのupとdownを同時に行う試み。Disqueはこのへんに割と余裕で耐えた。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Disque 26%、 nginx 23% 。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>サーバ側は同期的にメッセージぶち込んでいるんで、これを定期 + 別スレッドに変えてみよう。</p>
<p class="p3"><span class="Apple-tab-span">	</span>より現実に即している。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ってわけでいろいろテストを書いてやってみた。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>突破できた事象</b></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>1.サーバから1frameで10,000通のメッセージを投げてクライアントへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Test_4_0_ReceiveManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>2.サーバから1frameで100,000通のメッセージを投げてクライアントへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_1_ReceiveManyManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>3.クライアントから1frameで1,000通のメッセージを投げてサーバ-&gt;クライアントへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_2_SendManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>4.クライアントから1frameで10,000通のメッセージを投げてサーバ-&gt;クライアントへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_3_SendManyManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>5.サーバから1frameで10,000通のメッセージを投げてクライアントへと脱落なく届ける</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>+ クライアントから1frameで1,000通のメッセージを投げてサーバへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_4_SendAndReceiveManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>6.サーバから1frameで100,000通のメッセージを投げてクライアントへと脱落なく届ける</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>+ クライアントから1frameで10,000通のメッセージを投げてサーバへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_5_SendAndReceiveManyManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>7.サーバから非同期で10,000通のメッセージを投げてクライアントへと脱落なく届ける</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>+ クライアントから非同期で10,000通のメッセージを投げてサーバへと脱落なく届ける</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>new Test_4_6_SendAndReceiveAsyncManyTimes(),</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>この間一切の切断、取りこぼし、メッセージの変質などが存在しない。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>うーんいいね～～。あとは重たい箇所のあぶり出しとか最適化を必要になったらやろう。</p>
<p class="p3"><span class="Apple-tab-span">	</span>時間を計るとかするかな、、フレーム数とかだと安定しそう。</p>
</body>
</html>
