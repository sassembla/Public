<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #8cd3fe; background-color: #000000}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; background-color: #000000}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #c27e65; background-color: #000000}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; min-height: 14.0px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; background-color: #000000; min-height: 14.0px}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #e6e6e6}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Menlo; color: #536579; background-color: #e6e6e6}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Menlo; color: #326d74}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d69a; background-color: #000000}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Menlo; color: #c41a16; background-color: #e6e6e6}
    span.s1 {font-kerning: none; color: #b76fb3}
    span.s2 {font-kerning: none; color: #cacaca}
    span.s3 {font-kerning: none; color: #4689cc}
    span.s4 {font-kerning: none}
    span.s5 {font-kerning: none; color: #d4d69a}
    span.s6 {font-kerning: none; color: #8cd3fe}
    span.s7 {font: 12.0px Menlo; font-kerning: none; color: #c27e65; background-color: #000000}
    span.s8 {font: 12.0px Menlo; font-kerning: none; color: #cacaca; background-color: #000000}
    span.s9 {font: 12.0px Menlo; font-kerning: none; color: #8cd3fe; background-color: #000000}
    span.s10 {color: #245256}
    span.s11 {color: #000000}
    span.s12 {color: #9b2393}
    span.s13 {color: #326d74}
    span.s14 {font: 12.0px 'Hiragino Sans'; color: #000000}
    span.s15 {background-color: #e6e6e6}
    span.s16 {font-kerning: none; color: #43c0a0}
    span.s17 {font-kerning: none; color: #c27e65}
    span.s18 {color: #643820}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>UnityのDebug.Logの話(IL2CPPでログを出したいみたいな話を添えて)</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>個人的にUnityでのLogが実機(iOSとかIL2CPPの果て)で最終的にどうなるか、という動作を追い切ったことがないんで、追った話。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>前提</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・UnityEditorのLogging設定では、ログは出る。stacktraceが止むだけ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・UnityEngine.Debug.unityLogger.logEnabled = false; では、実行時にこのコードを実行後、ログは出なくなる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここまででいうと、後者、 UnityEngine.Debug.unityLogger.logEnabled = false; いいじゃんってなると思うんだけど、まだ気になるポイントがあった。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>発端</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityEngine.Debug.unityLogger.logEnabled = false; を使っても、Debug.Logの中の実装が変わるだけで、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Debug.Log(“a:” + 1000);</p>
<p class="p3"><span class="Apple-tab-span">	</span>とかの中身が変わってログは出なくなるが、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>“a:” + 1000 の部分は、“a:” + 1000.ToString() みたいな処理が走る。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>処理が走るやんけ、というところで、ToStringは new string ~ みたいなのがその結果として発生するので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>結果としてログ関数の中身を無効化しても、無駄なnew発生してるやんけという話。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>before</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Debug.Log(“a:” + 1000);</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>after</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>UnityEngine.Debug.unityLogger.logEnabled = false;</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Debug.Log(“a:” + 1000);// 関数の中身がすげ変わってログは出なくなってるが、1000をstringに変える、という処理は残っている。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これはまあ、“a:” + 1000の部分で発生したToString()の成果が、GCの対象となる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、まあ、つまり、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・UnityEngine.Debug.unityLogger.logEnabled = false; をやっても、結局ログコード自体が残っていると無駄なnewが走る</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>というわけだ。俺はこの時点で結構絶望した。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なんでかというと、UnityEngine.Debug.Log類をglobalで上書きする、という、ヒューマンパワーを食ううえに不完全な方法しか解決策がないから。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>どう不完全か</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>この辺がわかりやすい。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>【Unity】リリース時にDebug.Logを出力しないようにする</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://noracle.jp/unity-no-debug/">https://noracle.jp/unity-no-debug/</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>この記事では、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・自前でUnityEngine.Debugを上書きして</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Conditional属性をつけることで、根こそぎ無効にできる</p>
<p class="p3"><span class="Apple-tab-span">	</span>という手法と、その手法がなお及ばない部分がある、と言うことを示してくれている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・using A=B とかやられてるやつは対処できない(ライブラリとかにめっちゃある)</p>
<p class="p3"><span class="Apple-tab-span">	</span>ということがそれ。コードならいいけど、dllなら？ 詰むが？</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そしてそれとは別に、まあ、自分はこっちの方が気になるんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・毎回誰かが同じ、Debug.Log*系のコードを書かないといけない</p>
<p class="p3"><span class="Apple-tab-span">	</span>これなんの罰ゲームだよ。被ったりするしみんなが同じことを毎回やる必要ないでしょ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そう、つまり不完全なのだよ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>完全な、デザインされた元栓が欲しいんだ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>こうであってほしい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・コンパイル時にUnityEngine.Debug.LogをConditionalで制御できるようにしてほしい</p>
<p class="p3"><span class="Apple-tab-span">	</span>・そしたらコンパイル時にUnityEngine.Debug.Logを呼んでる箇所は、たとえdllの中でも消えてくれると思うし、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・例えばログのためのローカル変数とかもunused扱いになってコンパイルで消せると思うので</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>みたいな感じ。ユーザーが書けるC#レイヤーでこういう問題に挑ませるの悪手だと思う。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>具体例を書こうか。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こういうコードがあったら、</p>
<p class="p4"><span class="s1">foreach</span><span class="s2"> (</span><span class="s3">var</span><span class="s2"> </span><span class="s4">path</span><span class="s2"> </span><span class="s1">in</span><span class="s2"> </span><span class="s4">deleteTargetPaths</span><span class="s2">)</span></p>
<p class="p5"><span class="s4">{</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s4">Directory</span><span class="s2">.</span><span class="s5">Delete</span><span class="s2">(</span><span class="s4">path</span><span class="s2">, </span><span class="s3">true</span><span class="s2">);</span></p>
<p class="p6"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s6">Debug</span><span class="s2">.</span><span class="s5">Log</span><span class="s2">(</span><span class="s4">"folder deleted:"</span><span class="s2"> + </span><span class="s6">path</span><span class="s2">);</span></p>
<p class="p5"><span class="s4">}</span></p>
<p class="p7"><span class="s4"></span><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>もし、Debug.LogがConditionalAttributeとかで実装してあれば、</p>
<p class="p4"><span class="s1">foreach</span><span class="s2"> (</span><span class="s3">var</span><span class="s2"> </span><span class="s4">path</span><span class="s2"> </span><span class="s1">in</span><span class="s2"> </span><span class="s4">deleteTargetPaths</span><span class="s2">)</span></p>
<p class="p5"><span class="s4">{</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s4">Directory</span><span class="s2">.</span><span class="s5">Delete</span><span class="s2">(</span><span class="s4">path</span><span class="s2">, </span><span class="s3">true</span><span class="s2">);</span></p>
<p class="p8"><span class="s4"></span><br></p>
<p class="p5"><span class="s4">}</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>コンパイル時にこうなったりするはずなんだよ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>するとどうだ、<span class="s7">"folder deleted:"</span><span class="s8"> + </span><span class="s9">path</span> が関数ごと消えるでしょ。こうなれば関数がどうなってようと関係ないじゃん。幸せでは。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>IL2CPP側はどうなっているのか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、まあ、自分の中での結論は↑の通り、UnityEngine.DebugにConditionalつけといてよ、なのだが、</p>
<p class="p3"><span class="Apple-tab-span">	</span>それはまあなんか言う機会を作って言えばいい話なので、なんならバグレポレベルだと思ってるしそれはそれとして。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>今できることはなんだろうか。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>例えば、IL2CPPへとコンパイルされた段階で、Debug.Log関数の元締めは世界で一個しかないはずだ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>だから、その関数をIL2CPP上から滅殺できる、みたいなマクロがもしラッパーとして定義されていれば、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>その部分をいじることでマクロとしてDebug.Logを消し、Log関数に読み込まれている各種string化処理とかconcat処理とかも、</p>
<p class="p3"><span class="Apple-tab-span">	</span>コンパイラが「お前これつかってないやんけ！！」パワーを発揮して滅殺してくれるのでは！？？？！？ という夢があった。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>結論から書くとそれは夢だった。マクロなんかなかった。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>IL2CPP世界のログの定義はこんな感じのところにある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>PROJECT/iOS/Classes/Native/Bulk_Assembly-CSharp_0.cpp</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>(行数に注目するとちょっとクスッとくると思う)</p>
<p class="p3"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-06-21%2018.10.44.png" alt="スクリーンショット 2019-06-21 18.10.44.png"></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>さあ、C# UnityEngine.Debug.Logが変換されて出てくるログの関数を探そう。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>該当の関数はこれ。</p>
<p class="p9">// System.Void UnityEngine.Debug::Log(System.Object)</p>
<p class="p9">extern "C" IL2CPP_METHOD_ATTR void <b>Debug_Log_m4051431634</b> (RuntimeObject * __this /* static, unused */, RuntimeObject * p0, const RuntimeMethod* method);</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>長えな。</p>
<p class="p3"><span class="Apple-tab-span">	</span>mなんちゃらの数値は、Unityのバージョンに関連なく固定っぽい。特にビルド対象によって変動はしなかった。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そしてこの関数はIL2CPP化されたコードの上で使われてるはずなので、使用箇所を探してみる。</p>
<p class="p2"><br></p>
<p class="p10"><span class="s10">Debug_Log_m4051431634</span><span class="s11">(</span><span class="s12"><b>NULL</b></span><span class="s11"> </span><i>/*static, unused*/</i><span class="s11">, </span><span class="s13">_stringLiteral223888751</span><span class="s11">, </span><i>/*hidden argument*/</i><span class="s12"><b>NULL</b></span><span class="s11">);</span><span class="s14"><span class="Apple-tab-span">	</span></span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんな感じに、そのままログ関数がコード上で使われている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>マクロとかでラップされてて、マクロを書き換えればあら不思議、なかったことに、、、！！ みたいな世界はこの世にはなかった。本当に残念だ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここで、「マクロで書かれてれば最悪でもIL2CPPレイヤーでなんとかできるのでは」という夢は霧散する。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>IL2CPPでDebug.Logを書こう</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>最後に、IL2CPPで好きなようにログを書く、という、この世の果てで使えそうなデバッグ手法を紹介しておく。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>IL2CPPで出力されたC++コードとは何か、っていうと、あれは、コンパイル結果だ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>断じて人間が何かを書き加えたり、変更を加えられる空間ではない。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、まあ、</p>
<p class="p2"><br></p>
<p class="p10"><span class="s10">Debug_Log_m4051431634</span><span class="s11">(</span><span class="s12"><b>NULL</b></span><span class="s11"> </span><i>/*static, unused*/</i><span class="s11">, </span><span class="s13">_stringLiteral223888751</span><span class="s11">, </span><i>/*hidden argument*/</i><span class="s12"><b>NULL</b></span><span class="s11">);</span><span class="s14"><span class="Apple-tab-span">	</span></span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>とかのコードでは、</p>
<p class="p11"><span class="s14"><span class="Apple-tab-span">	</span></span><span class="s15">_stringLiteral223888751</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>というポインタにIL2CPP string型みたいなのがあって、そこにC#で書いたC# stringが置かれている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>(実際にはバカでっかい文字列置き場があって、そこにすべての文言が連続する形でキュッと収められている。)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>さて、そのIL2CPP string、自力で作ることはできるのか。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>できる。<span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p5"><span class="s5">IL2CPP_RUNTIME_CLASS_INIT</span><span class="s4">(Debug_t3317548046_il2cpp_TypeInfo_var);</span></p>
<p class="p12"><span class="s16">String_t</span><span class="s2">* a = </span><span class="s4">il2cpp_codegen_string_new_wrapper</span><span class="s2">(</span><span class="s17">"comment here!!"</span><span class="s2">);</span></p>
<p class="p5"><span class="s5">Debug_Log_m4051431634</span><span class="s4">(</span><span class="s3">NULL</span><span class="s4">, (RuntimeObject *)a, </span><span class="s3">NULL</span><span class="s4">);</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんなふうにすれば、comment here!! っていう表示がXcodeとかに出る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>便利でっしゃろ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>IL2CPP世界ではXcodeのbreak pointを置くことでもちろんいい感じにステップ実行できるんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>ポインタのラッパーやラッパーのラッパーがあるせいで、さてここにどうやってジャンプしてきたんだろう、みたいなスタック情報がかき消えているケースが多い。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>つまり上から下は見やすいんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>下から上が超絶に見えない。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>となると最後の手段はログでしょって感じで、上記のコードが使える。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>前提としては、</p>
<p class="p13"><span class="s18">#include </span>"codegen/il2cpp-codegen.h"<span class="s14"><span class="Apple-tab-span">	</span></span></p>
<p class="p3"><span class="Apple-tab-span">	</span>をincludeしている必要があるが、IL2CPPで作成されたコードにはだいたいincludeされてる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>感想</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここまで読まれた人がいたら、ついででいいので読んでおいてほしい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>自分はこう思っている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Debug.Logを無効化する方法はいろいろあるが、いまだに完全なものはない。完全なものが欲しい。誰が書いたどんなコードにも適応できる、完全なものが。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・まあ別にstring concatとかToStringとか重たい関数をDebug.Log()のかっこの中で実行してGCがでるくらいいいじゃん、という発想は別にアリだと思っている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Debug.Logが一つでもコードに残っているのは悪だ、どんどん消すべき！みたいなのには別に同意しない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・そんなのは書いたやつの自由だし、なんで製品版ビルドなのにログで損をするんだよという感じ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・そして、それらとは関係なく、この文脈においてDebug.Logをユーザーに上書きさせることはやはり狂っている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>以上だ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>はい。</p>
</body>
</html>
