<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2022.1">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>この言語の標準API、特定のzipファイルが読めないんだが？</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ある言語でunzipできないzipファイルが見つかり、</p>
<p class="p3"><span class="Apple-tab-span">	</span>シグニチャにpk34って書いてあるんで確実にzipだと思うんだが、実際にunzipできるかというとできない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>この謎を追う。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>終わりのあたりにはpk78がある。うーん、他のヘッダは存在しないんだよなあ。なんなんだこれ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>-&gt; 先にネタバレしておくと言語側の標準ライブラリがうんこだった。データディスクリプタありのzipをunzipできないんだってさ。ふーん。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>解読</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="http://www.asahi-net.or.jp/~wr9k-oohs/Pages/Nigel%27s/Nigel57/nigel57.html">http://www.asahi-net.or.jp/~wr9k-oohs/Pages/Nigel%27s/Nigel57/nigel57.html</a> 曰く、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>pk34あるいはpk78がヘッダに入ることがある、、、？<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>よーわからんな、、</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://runicalp.hatenablog.com/entry/20100625/1277471095">https://runicalp.hatenablog.com/entry/20100625/1277471095</a> 曰く、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>データディスクリプタっつーのがつくことがある、と。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・ローカルヘッダシグネチャ pk34</p>
<p class="p3"><span class="Apple-tab-span">	</span>・データディスクリプタシグネチャ pk78</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>あーーーもしかしてzipだと思って接してたけどjarなのかこれ？馬鹿？</p>
<p class="p3"><span class="Apple-tab-span">	</span>ローカルファイルヘッダ(pk34)にcrcとサイズが未定義の場合、このヘッダが定義される。ほー。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://www.tnksoft.com/reading/zipfile/index.php?p=fmt5">https://www.tnksoft.com/reading/zipfile/index.php?p=fmt5</a> 曰く、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>pk78のあとに入っているものは</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・crc32 4byte</p>
<p class="p3"><span class="Apple-tab-span">	</span>・圧縮後サイズ 4byte</p>
<p class="p3"><span class="Apple-tab-span">	</span>・圧縮前サイズ 4byte</p>
<p class="p3"><span class="Apple-tab-span">	</span>が入ってると。なるほど。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>細かいフラグはここを参照するとして</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://gist.github.com/ysakasin/2edf8d3bf55c6ebf63f82851e302b030">https://gist.github.com/ysakasin/2edf8d3bf55c6ebf63f82851e302b030</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>っつーことで、RFCとかにも普通に書いてある事態だった。それなのに展開できないライブラリがあるのか。ふーん。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>とりあえず引き続き値を読んでいく。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>実際の値</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>50 4B 03 04<span class="Apple-tab-span">	</span>//4byte pk34</p>
<p class="p3"><span class="Apple-tab-span">	</span>14 00<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//2byte ver</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>08 08<span class="Apple-tab-span">	</span>//2byte general purpose bit flag</p>
<p class="p3"><span class="Apple-tab-span">	</span>08 00 <span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//2byte 圧縮方式 = deflated</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>xx xx<span class="Apple-tab-span">	</span>//2byte 更新日時</p>
<p class="p3"><span class="Apple-tab-span">	</span>xx xx<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//2byte 更新日</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>00 00<span class="Apple-tab-span">	</span>~</p>
<p class="p3"><span class="Apple-tab-span">	</span>00 00<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//4byte crc値</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>00 00<span class="Apple-tab-span">	</span>~</p>
<p class="p3"><span class="Apple-tab-span">	</span>00 00 <span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//4byte 圧縮後サイズ</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>00 00 ~</p>
<p class="p3"><span class="Apple-tab-span">	</span>00 00<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//4byte 圧縮前サイズ</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>xx xx<span class="Apple-tab-span">	</span>//2byte ファイル名長さ</p>
<p class="p3"><span class="Apple-tab-span">	</span>0000<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>//拡張データサイズ</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-converted-space">          </span>このへんからファイル名～</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>で、ビットフラグが0808なので、これは</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>0010 0010 で、3ビット目と7ビット目がたっている。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>3bit目が立っている場合、データディスクリプタが書かれている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>~</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>50<span class="Apple-tab-span">	</span>4B<span class="Apple-tab-span">	</span>07<span class="Apple-tab-span">	</span>08 //pk78</p>
<p class="p3"><span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx //crc</p>
<p class="p3"><span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx //圧縮後サイズ</p>
<p class="p3"><span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx<span class="Apple-tab-span">	</span>xx //圧縮前サイズ</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なるほど。まあうーん変わった仕様だとは思うけど末尾に書けるとうれしいもんな、っていう、はい。RFCにも書いてある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>んでこれが読めないライブラリがあると。なるほどなあ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ファイル名が書いてあってデータがあって長さは、、みたいなのが読めれば、あとはdeflateすればいいだけっぽいし。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>-&gt; できました。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">いい話。</p>
</body>
</html>
