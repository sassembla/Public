<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #042eee}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #d29d00; min-height: 18.0px}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #d29d00; background-color: #ebebeb; min-height: 18.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #669c35; background-color: #ebebeb}
    span.s1 {font: 22.0px 'Hiragino Kaku Gothic ProN'}
    span.s2 {font: 12.0px Helvetica}
    span.s3 {font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.s4 {color: #000000}
    span.s5 {text-decoration: underline}
    span.s6 {color: #00a3d7}
    span.s7 {color: #d58400}
    span.s8 {color: #e32400}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>SublimeText2</b><span class="s1"><b>アドベントカレンダー</b></span><b>2012</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>みんなだいすき<span class="s2">SublimeText2</span>、のアドカレ！</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="http://www.adventar.org/calendars/20">http://www.adventar.org/calendars/20</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span>3</span>日目です。</p>
<p class="p4"><span class="Apple-tab-span">	</span>written by <a href="https://twitter.com/toru_inoue">@toru_inoue</a> <span class="s3">。</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span>SublimeText2</span>でのプラグイン作りで、ハマりやすいところについて</p>
<p class="p3"><span class="Apple-tab-span">	</span>つらつら3点ほど、まとめつつ書きます。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>以前作り方的に悩んだ部分を纏めたのですが、</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="http://bit.ly/UaWF0u">http://bit.ly/UaWF0u</a></p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>身内からも、「羅列してある感じで良くワカんねぇッス！！」とか</p>
<p class="p3"><span class="Apple-tab-span">	</span>「★になれ！！　クマと戦え！！」とブワッ(´；ω；｀)な感じだったため</p>
<p class="p3"><span class="Apple-tab-span">	</span>Tipsとして転生します。</p>
<p class="p5"><b></b><br></p>
<p class="p5"><b></b><br></p>
<p class="p3"><b>1.Sublimeの command と python ファイルの連携について</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ST2には、command と呼ばれる概念なものがあります。</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p6"><span class="Apple-tab-span">	</span>{"id": "Gradle", "caption": "Build current project", <b>"command": "gbuild"</b> }</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>この command を実行すると、プラグインフォルダ中の <b>なんちゃら.py</b> <b>の中身が実行される</b>訳なんですが、</p>
<p class="p3"><span class="Apple-tab-span">	</span>実行されるメソッドは、下記のルールさえ守っていれば何でも良いみたいです。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>①なんちゃら.pyが存在する</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>②上記で言う、gbuild を先頭に含んでいるクラス定義がある</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ここが一番厄介。</p>
<p class="p5"><b></b><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>gbuild </b>はもちろんのこと、</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>gbuildCommand</b> とか</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>gbuildHyahhar</b> とかでもOK。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>さらに、一般的にはclass大文字で始めるんじゃねェの的な意味で、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>Gbuild </b>とかもOK。</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ただし、途中での大文字の扱いが歪で、</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>command の呼び出し定義を</p>
<p class="p6">"command": "<b>gbuildDependents</b>"</p>
<p class="p5"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>とか書いてしまって、</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>gbuildDependents</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>みたいなクラス名で定義しても、command が呼ばれません。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このへんは結構歪で、結局自分は command 定義部分はすべて小文字、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>クラス定義側は頭のみ大文字、にしました。</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>信じてたのに！！　最初の大文字はOKだから信じてたのに！！</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>はい。駄目です。</p>
<p class="p5"><br></p>
<p class="p5"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>③そのclassが sublime_plugin.TextCommand / sublime_plugin.WindowCommand / sublime_plugin.ApplicationCommand のどれかを継承している</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>微妙に用途が異なるST2プラグイン用のクラスが定義されてるので、継承します。</p>
<p class="p5"><b></b><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>それぞれの用途については下記参考。</p>
<p class="p7"><span class="s4"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b><a href="http://www.sublimetext.com/docs/api-reference#sublimeplugin.Plugin"><span class="s5">http://www.sublimetext.com/docs/api-reference#sublimeplugin.Plugin</span></a></span></p>
<p class="p8"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>④run メソッドが定義されている</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>⑤そのメソッドが継承したclass に対応する引数持ってる</b></p>
<p class="p8"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ふまえると、上記のcommand <b>gbuild</b><span class="Apple-converted-space">  </span>の定義はこんな感じになります。</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6">import</span> sublime</p>
<p class="p6"><span class="s6">import</span> sublime_plugin</p>
<p class="p9"><br></p>
<p class="p6"><span class="s7">class</span> <b>Gbuild</b>(sublime_plugin.TextCommand):</p>
<p class="p6"><span class="Apple-converted-space">  </span><span class="s7">def</span> <span class="s8">run</span> (self, edit) :</p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span># 何か処理</p>
<p class="p5"><b></b><br></p>
<p class="p5"><b></b><br></p>
<p class="p3"><b>2.いつの間にかショートカットがついてる場合</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>コレですコレ。</p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-02%2017.21.52.png" alt="スクリーンショット 2012-12-02 17.21.52.png"></p>
<p class="p3"><span class="Apple-tab-span">	</span>前出の command について、ショートカットを設定出来ます。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>設定は、プラグインパッケージ内の</p>
<p class="p3"><span class="Apple-tab-span">	</span><b>Default.sublime-keymap</b> ファイルから行えます。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ただ自分がモロにハマった事象があって、把握までちょっとかかったので共有までに。</p>
<p class="p5"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>・既にショートカットが定義されている command と同じ名前の command を定義してしまうと、</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Packageの壁を越えてショートカットマークが勝手に付く</b></p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>例えば、buid、って名前の command を定義しちゃったとしましょう。</p>
<p class="p3"><span class="Apple-tab-span">	</span>すると、CommandPalette とかに出る訳なんですが、</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>他のプラグインで <b>build って command が既に定義してあって</b>ですね。</p>
<p class="p3"><span class="Apple-tab-span">	</span>しかもショートカットも<b>既に書いてあった</b>んですね。</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>結果、自分が定義したcommandが表示されるべき箇所にも、ショートカットマークが出ちゃいます。</p>
<p class="p3"><span class="Apple-tab-span">	</span>最初、何故付いたんだろう、なんだろうなーってわからんかったっすわ。</p>
<p class="p5"><b></b><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>解決策としては、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・command の名前をユニークなものにする</p>
<p class="p3"><span class="Apple-tab-span">	</span>・キーボードショートカットは無かった事にする</p>
<p class="p3"><span class="Apple-tab-span">	</span>などです。</p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p3"><span class="Apple-tab-span">	</span>キーボードショートカットを簡単に定義できるのもST2のステキな所！　なのですが、</p>
<p class="p5"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>ぶっちゃけCommandPaletteがあるのでもう必要ないんじゃないでしょうか。</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>ショートカットは簡単に他のとぶつかるし。</b></p>
<p class="p5"><b></b><br></p>
<p class="p5"><b></b><br></p>
<p class="p3"><b>3.プラグインから外部プロセスを呼ぶ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>いろいろな方法が有るのですが、自分は</p>
<p class="p5"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span>subprocess.Popen</p>
<p class="p3"><span class="Apple-tab-span">	</span>を使っています。<span class="Apple-tab-span">	</span></p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんな感じ。</p>
<p class="p5"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span>self.process = subprocess.Popen(shlex.split(self.command.encode(<span class="s8">'utf8'</span>)), stdout=subprocess.PIPE, preexec_fn=os.setsid)</p>
<p class="p3"><span class="Apple-tab-span">	</span>引数には、shl<span class="s2">e</span>xで文字列をArrayに分割して放り込む、という風にしています。</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>一応Tipsとしては2つあり、</p>
<p class="p5"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>・stroutの内容を取得するために、PIPEを設定</b></p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こうする事で、</p>
<p class="p6"><span class="Apple-tab-span">	</span>self.process.stdout<span class="Apple-converted-space"> </span></p>
<p class="p3"><span class="Apple-tab-span">	</span>関連の標準出力が監視できます。</p>
<p class="p5"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>・このプロセスの処理に時間かかり過ぎたときにkillできるように、preexec_fn=os.setsid を設定</b></p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こうする事で、</p>
<p class="p6"><span class="Apple-tab-span">	</span>os.killpg(self.process.pid, signal.SIGTERM)</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>が通用します。</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ほんとは2.7以降ならもっと別の手法が有るっぽいのですが、ST2が使用するのはPython2.6 なので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>涙をのんでこんな所です。</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p3"><b>おしまい</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span></b>こんな所でしょうか。</p>
<p class="p3"><span class="Apple-tab-span">	</span>明日は4日目、 sada hirai さんです。</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
</body>
</html>
