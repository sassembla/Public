<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d4d4; -webkit-text-stroke: #d4d4d4; min-height: 14.0px}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #4ec9b0; -webkit-text-stroke: #4ec9b0; background-color: #000000}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d4d4; -webkit-text-stroke: #d4d4d4; background-color: #000000; min-height: 14.0px}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d4d4; -webkit-text-stroke: #d4d4d4; background-color: #000000}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #6a9955; -webkit-text-stroke: #6a9955; background-color: #000000}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #9cdcfe; -webkit-text-stroke: #9cdcfe; background-color: #000000}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px 'Hiragino Sans'; color: #6a9955; -webkit-text-stroke: #6a9955; background-color: #000000}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #d4d4d4}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #d4d4d4; min-height: 18.0px}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; -webkit-text-stroke: #d4d4d4}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; -webkit-text-stroke: #d4d4d4; min-height: 14.0px}
    p.p15 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #dcdcaa; -webkit-text-stroke: #dcdcaa; background-color: #000000}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #d4d4d4; background-color: #000000; min-height: 18.0px}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #9cdcfe; -webkit-text-stroke: #d4d4d4; background-color: #000000}
    p.p18 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Menlo; color: #9cdcfe; -webkit-text-stroke: #d4d4d4}
    span.s1 {font-kerning: none}
    span.s2 {font-kerning: none; color: #569cd6; -webkit-text-stroke: 0px #569cd6}
    span.s3 {font-kerning: none; color: #d4d4d4; -webkit-text-stroke: 0px #d4d4d4}
    span.s4 {font-kerning: none; color: #9cdcfe; -webkit-text-stroke: 0px #9cdcfe}
    span.s5 {font-kerning: none; color: #dcdcaa; -webkit-text-stroke: 0px #dcdcaa}
    span.s6 {font-kerning: none; color: #4ec9b0; -webkit-text-stroke: 0px #4ec9b0}
    span.s7 {font-kerning: none; color: #c586c0; -webkit-text-stroke: 0px #c586c0}
    span.s8 {font-kerning: none; color: #b5cea8; -webkit-text-stroke: 0px #b5cea8}
    span.s9 {font: 12.0px Menlo; font-kerning: none; color: #d4d4d4; -webkit-text-stroke: 0px #d4d4d4}
    span.s10 {font: 12.0px Menlo; font-kerning: none}
    span.s11 {font: 12.0px 'Hiragino Sans'; font-kerning: none}
    span.s12 {font-kerning: none; color: #6a9955; -webkit-text-stroke: 0px #6a9955}
    span.s13 {font: 12.0px 'Hiragino Sans'; font-kerning: none; color: #6a9955; -webkit-text-stroke: 0px #6a9955}
    span.s14 {font-kerning: none; color: #d4d4d4}
    span.s15 {font: 12.0px 'Hiragino Sans'; color: #000000}
    span.s16 {font-kerning: none; background-color: #000000}
    span.s17 {font-kerning: none; color: #ce9178; -webkit-text-stroke: 0px #ce9178}
    span.s18 {font: 12.0px 'Hiragino Sans'; font-kerning: none; color: #ce9178; -webkit-text-stroke: 0px #ce9178}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1">JobSystemまなび</p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>学ぶ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>途中経過</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんな感じのコードにしてみる</p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p5"><span class="s2">using</span><span class="s3"> </span><span class="s1">System</span><span class="s3">;</span></p>
<p class="p5"><span class="s2">using</span><span class="s3"> </span><span class="s1">System</span><span class="s3">.</span><span class="s1">Collections</span><span class="s3">;</span></p>
<p class="p5"><span class="s2">using</span><span class="s3"> </span><span class="s1">System</span><span class="s3">.</span><span class="s1">Collections</span><span class="s3">.</span><span class="s1">Generic</span><span class="s3">;</span></p>
<p class="p5"><span class="s2">using</span><span class="s3"> </span><span class="s1">Unity</span><span class="s3">.</span><span class="s1">Collections</span><span class="s3">;</span></p>
<p class="p5"><span class="s2">using</span><span class="s3"> </span><span class="s1">UnityEngine</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s2">public</span><span class="s3"> </span><span class="s2">class</span><span class="s3"> </span><span class="s1">JS</span><span class="s3"> : </span><span class="s1">MonoBehaviour</span></p>
<p class="p7"><span class="s1">{</span></p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span>[</span><span class="s1">SerializeField</span><span class="s3">] </span><span class="s1">Transform</span><span class="s3">[] </span><span class="s4">targets</span><span class="s3">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">float</span><span class="s1">[] </span><span class="s4">velocity</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s1">// Start is called before the first frame update</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s1"> </span><span class="s5">Start</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">velocity</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s2">float</span><span class="s3">[</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">];</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s1">// Update is called once per frame</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s1"> </span><span class="s5">Update</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commands</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastCommand</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">TempJob</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">results</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastHit</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">TempJob</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">targetPosition</span><span class="s3"> = </span><span class="s1">targets</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">position</span><span class="s3">;</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">direction</span><span class="s3"> = </span><span class="s1">Vector3</span><span class="s3">.</span><span class="s1">down</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">指定位置から下方向にレイキャストを行うコマンドをまとめる</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// RaycastCommand</span><span class="s11">型は、結果に</span><span class="s1">ReycastHit</span><span class="s11">型を返してくる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">command</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">RaycastCommand</span><span class="s3">(</span><span class="s1">targetPosition</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">commands</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s4">command</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s12">/*</span></p>
<p class="p8"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s11">コマンドを実行、結果は</span><span class="s1">results</span><span class="s11">に入る。</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s1"><span class="Apple-converted-space">            </span>RaycastCommand</span><span class="s11">で入力したコマンドは、</span><span class="s1">RaycastHit</span><span class="s11">を返してくる。</span></p>
<p class="p8"><span class="s1"><span class="Apple-converted-space">            </span>(</span><span class="s11">これは</span><span class="s1">raycastCommand</span><span class="s11">型の</span><span class="s1">ScheduleBatch</span><span class="s11">関数がそういう実装になってる</span><span class="s1">)</span></p>
<p class="p8"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// </span><span class="s1">完了まで待つ</span><span class="s10">(</span><span class="s1">ここでデッドロックしないのはなぜなんだろう、継続になってる？</span><span class="s10"> </span><span class="s1">それともそういうのを加味しないでいいくらい高速？</span><span class="s10">)</span></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// -&gt; </span><span class="s1">待ってる。十分に高速なら問題ないというロジック。</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// </span><span class="s11">最後の引数は</span><span class="s1">job</span><span class="s11">の最大分散数。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commandJobHandle</span><span class="s3"> = </span><span class="s1">RaycastCommand</span><span class="s3">.</span><span class="s5">ScheduleBatch</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s8">10</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// jobHandle</span><span class="s11">の終了を待つ</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">commandJobHandle</span><span class="s3">.</span><span class="s5">Complete</span><span class="s3">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s12">// </span><span class="s13">破棄</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">commands</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// </span><span class="s1">加速度をセット、速度がマイナス</span><span class="s10">(</span><span class="s1">下に移動</span><span class="s10">)</span><span class="s1">、かつレイキャストの距離が一定以下だったらぶつかったとみなす。</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">if</span><span class="s1"> (</span><span class="s4">velocity</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] &gt; </span><span class="s8">0</span><span class="s1"> &amp;&amp; </span><span class="s4">results</span><span class="s1">[</span><span class="s4">i</span><span class="s1">].</span><span class="s4">distance</span><span class="s1"> &lt; </span><span class="s8">0.5f</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">velocity</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = -</span><span class="s8">2</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">velocity</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] += </span><span class="s8">0.098f</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">results</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// </span><span class="s11">加速度分移動</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">targets</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">localPosition</span><span class="s3"> += </span><span class="s1">Vector3</span><span class="s3">.</span><span class="s1">down</span><span class="s3"> * </span><span class="s1">velocity</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p7"><span class="s1">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-tab-span">	</span></span></p>
<p class="p11"><span class="Apple-tab-span">	</span>前提として、targets配列にはエディタ上でcubeオブジェクトをセットしておく。</p>
<p class="p11"><span class="Apple-tab-span">	</span>あと、ヒット対象となる地面(Terrainとか)を用意しとく。</p>
<p class="p12"><br></p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p11"><b>結果</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>いい感じにMainと他3スレッド(マシンが4コアなので合計4)で分散できた。</p>
<p class="p11"><span class="Apple-tab-span">	</span>これワーカー数はコア数と一致するんだろうか、、</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-01-05%2022.33.15.png" alt="スクリーンショット 2019-01-05 22.33.15.png"></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>アップで見るとこんな感じで、</p>
<p class="p11"><span class="Apple-tab-span">	</span>・どれか一つのスレッドがResultJobを実行</p>
<p class="p11"><span class="Apple-tab-span">	</span>・メインスレッドのWaitForJobGroupIDがそれを受ける</p>
<p class="p11"><span class="Apple-tab-span">	</span>みたいな感じに見える。</p>
<p class="p13"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-01-05%2022.40.06.png" alt="スクリーンショット 2019-01-05 22.40.06.png"></p>
<p class="p14"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span></p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>ここまでで、Raycastを打つ部分はJob化できてる。で、次に</p>
<p class="p11"><span class="Apple-tab-span">	</span>・ヒットチェックして加速度を<span class="Apple-tab-span">	</span>制御する部分</p>
<p class="p11"><span class="Apple-tab-span">	</span>・移動させる部分</p>
<p class="p11"><span class="Apple-tab-span">	</span>をJob化してみる。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>この時点で100fps前後。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>ヒットチェック部分のJob化</b></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>グローバルに定義してあるvelocityはNativeArray&lt;float&gt;にしておく。</p>
<p class="p11"><span class="Apple-tab-span">	</span>このあとJobからアクセスする要素を生成する時に代入するため。</p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s1">NativeArray</span><span class="s3">&lt;</span><span class="s2">float</span><span class="s3">&gt; </span><span class="s4">velocity</span><span class="s3">;</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>んで、このインスタンスはOnEnableで生成、OnDisableで削除するようにする。</p>
<p class="p12"><br></p>
<p class="p15"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s3"> </span><span class="s1">OnEnable</span><span class="s3">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">velocity</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s2">float</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">Persistent</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">int</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">velocity</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s8">1</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p16"><br></p>
<p class="p15"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s3"> </span><span class="s1">OnDisable</span><span class="s3">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">velocity</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>そんでまずHitCheckJobを、IJobParallelFor structを拡張する形で定義。</p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">struct</span><span class="s3"> </span><span class="s1">HitCheckJob</span><span class="s3"> : </span><span class="s1">IJobParallelFor</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">        </span>[</span><span class="s1">ReadOnly</span><span class="s3">] </span><span class="s2">public</span><span class="s3"> </span><span class="s1">NativeArray</span><span class="s3">&lt;</span><span class="s1">RaycastHit</span><span class="s3">&gt; </span><span class="s4">hits</span><span class="s3">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">public</span><span class="s1"> </span><span class="s6">NativeArray</span><span class="s1">&lt;</span><span class="s2">float</span><span class="s1">&gt; </span><span class="s4">velocities</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">public</span><span class="s1"> </span><span class="s2">void</span><span class="s1"> </span><span class="s5">Execute</span><span class="s1">(</span><span class="s2">int</span><span class="s1"> </span><span class="s4">i</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">加速度をセット、速度がマイナス</span><span class="s10">(</span><span class="s1">下に移動</span><span class="s10">)</span><span class="s1">、かつレイキャストの距離が一定以下だったらぶつかったとみなす。</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">if</span><span class="s1"> (</span><span class="s4">velocities</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] &gt; </span><span class="s8">0</span><span class="s1"> &amp;&amp; </span><span class="s4">hits</span><span class="s1">[</span><span class="s4">i</span><span class="s1">].</span><span class="s4">distance</span><span class="s1"> &lt; </span><span class="s8">0.5f</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">                </span></span><span class="s10">// </span><span class="s1">ヒットしたので加速度を</span><span class="s10">-2</span><span class="s1">にセットして浮かび上がらせる。</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">velocities</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = -</span><span class="s8">2</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">velocities</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] += </span><span class="s8">0.098f</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>Jobを定義する際にパラメータに要素をセットすることで、後ほど実行 = Schedule関数を呼ぶ時に第一引数にセットした数だけExecuteが回ってくれる。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>hitsなどの要素のセットについては、このジョブのインスタンスを生成する時にhits = みたいな形にして渡す。</p>
<p class="p11"><span class="Apple-tab-span">	</span>hitsは参照オンリーなので、ReadOnlyをつけることができる。(velocityはR/W両方あるのでなんもできん)</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>次に、レイキャストコマンドを実行する部分の次に、HitCheckJobを生成する部分を追加する。</p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s1"> </span><span class="s5">Update</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commands</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastCommand</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">TempJob</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">results</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastHit</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">TempJob</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">targetPosition</span><span class="s3"> = </span><span class="s1">targets</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">position</span><span class="s3">;</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">direction</span><span class="s3"> = </span><span class="s1">Vector3</span><span class="s3">.</span><span class="s1">down</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">指定位置から下方向にレイキャストを行うコマンドをまとめる</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// RaycastCommand</span><span class="s11">型は、結果に</span><span class="s1">ReycastHit</span><span class="s11">型を返してくる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">command</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">RaycastCommand</span><span class="s3">(</span><span class="s1">targetPosition</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">commands</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s4">command</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// </span><span class="s11">ジョブの初期化をする</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">hitCheckJob</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">HitCheckJob</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">hits</span><span class="s1"> = </span><span class="s4">results</span><span class="s1">,</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">velocities</span><span class="s3"> = </span><span class="s1">velocity</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>ここまでで、次の状態のhitCheckJobのインスタンスが手に入る。</p>
<p class="p11"><span class="Apple-tab-span">	</span>・このあとRaycastの結果 = RaycastHitのNativeArrayを返してくるresultsの参照を、hitsに代入</p>
<p class="p11"><span class="Apple-tab-span">	</span>・速度が入るvelocityのNativeArrayの参照を、Job内部で値を入れるvelocitiesに代入</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>そんでjobを実行。</p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commandJobHandle</span><span class="s3"> = </span><span class="s1">RaycastCommand</span><span class="s3">.</span><span class="s5">ScheduleBatch</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s8">10</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">hitcheckHandle</span><span class="s3"> = </span><span class="s1">hitCheckJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s8">10</span><span class="s3">, </span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p17"><span class="s14"><span class="Apple-converted-space">        </span></span><span class="s1">hitcheckHandle</span><span class="s14">.</span><span class="s5">Complete</span><span class="s14">();</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>先ほどまでRaycastCommandの結果をそのままCompleteしていたのを、</p>
<p class="p11"><span class="Apple-tab-span">	</span>新たにhitcheckHandleインスタンスをhitCheckJob.Scheduleから生成し、そのjobの完了を待つように変更する。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>この際、まずレイキャストを打ってからヒットチェックがしたいため、hitcheckJobのSchedule関数にcommandJobHandleのインスタンスをセット、</p>
<p class="p11"><span class="Apple-tab-span">	</span>必ず</p>
<p class="p18"><span class="s15"><span class="Apple-tab-span">	</span>・</span><span class="s16">commandJobHandle</span></p>
<p class="p18"><span class="s15"><span class="Apple-tab-span">	</span>・</span><span class="s16">hitcheckHandle</span></p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>という順番で処理が実行されるようにする。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>ここまでで、ヒットチェックがjob化できた。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>移動もJob化する</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>あとは応用で、</p>
<p class="p11"><span class="Apple-tab-span">	</span>・加速度分移動する</p>
<p class="p11"><span class="Apple-tab-span">	</span>という処理をJob化する。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>まず位置(transform)をいじるので、transformに対してJob内から干渉できるJobを作成する。</p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">struct</span><span class="s3"> </span><span class="s1">ApplyPositionJob</span><span class="s3"> : </span><span class="s1">IJobParallelForTransform</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">        </span>[</span><span class="s1">ReadOnly</span><span class="s3">] </span><span class="s2">public</span><span class="s3"> </span><span class="s1">NativeArray</span><span class="s3">&lt;</span><span class="s2">float</span><span class="s3">&gt; </span><span class="s4">velocities</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">public</span><span class="s1"> </span><span class="s2">void</span><span class="s1"> </span><span class="s5">Execute</span><span class="s1">(</span><span class="s2">int</span><span class="s1"> </span><span class="s4">i</span><span class="s1">, </span><span class="s6">TransformAccess</span><span class="s1"> </span><span class="s4">transform</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">transform</span><span class="s3">.</span><span class="s1">localPosition</span><span class="s3"> += </span><span class="s1">Vector3</span><span class="s3">.</span><span class="s1">down</span><span class="s3"> * </span><span class="s1">velocities</span><span class="s3">[</span><span class="s1">i</span><span class="s3">];</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>こんな感じで、IJobParallelForTransform structを拡張したジョブを定義する。</p>
<p class="p11"><span class="Apple-tab-span">	</span>Executeの内部処理についてはちょっと特殊で、</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>・IJobOarallelForTransform関数のSchedule関数はTransformAccessArray(Transform[] transforms)という型を引数にとり</p>
<p class="p11"><span class="Apple-tab-span">	</span>・Execute実行時に transforms へのアクセスが可能なように引数に入っている</p>
<p class="p11"><span class="Apple-tab-span">	</span>という感じ。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>Transformそのままだと参照型になってしまっていて値型ではないのでJobからアクセスできない、というのがあるらしい。</p>
<p class="p11"><span class="Apple-tab-span">	</span>なので、</p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">transformAccess</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">TransformAccessArray</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">);</span></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>とか定義して、Schedule関数に対して渡す。<span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>さらにScheduleの第二引数としてヒットチェックのjobHandleを渡し、順番を制御する。</p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">applyPosHandle</span><span class="s3"> = </span><span class="s1">applyPositionJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">transformAccess</span><span class="s3">, </span><span class="s1">hitcheckHandle</span><span class="s3">);</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>これで、</p>
<p class="p11"><span class="Apple-tab-span">	</span>・レイキャスト</p>
<p class="p11"><span class="Apple-tab-span">	</span>・ヒットチェック</p>
<p class="p11"><span class="Apple-tab-span">	</span>・移動</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>の順番で処理が行われるようになっている。</p>
<p class="p11"><span class="Apple-tab-span">	</span>処理が終わったら</p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">transformAccess</span><span class="s3">.</span><span class="s5">Dispose</span><span class="s3">();</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>も忘れないようにする。ない場合エラー出してくれるんで便利。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>ここまででヒットチェックと移動のJob化ができた。やったぜ。</p>
<p class="p11"><span class="Apple-tab-span">	</span>この時点で100fps前後。まあ変わらん。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>Raycast、Hitcheck、ApplyPosがJob化できた図。</p>
<p class="p13"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-01-06%200.10.59.png" alt="スクリーンショット 2019-01-06 0.10.59.png"></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>ここからさらに高速化するには、「Completeをやめてメインスレッドのロックを外す」ということをする感じになる。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>Completeを次のフレームで実行する(WaitForJobGroupにかかる時間 = メインスレッドでの待ちを減らす)</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>Updateで行うコードを次のような感じにする。</p>
<p class="p12"><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s2">void</span><span class="s1"> </span><span class="s5">Update</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// applyPosHandle </span><span class="s11">の終了を待つ</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">applyPosHandle</span><span class="s3">.</span><span class="s5">Complete</span><span class="s3">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">targetPosition</span><span class="s3"> = </span><span class="s1">targets</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">position</span><span class="s3">;</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">direction</span><span class="s3"> = </span><span class="s1">Vector3</span><span class="s3">.</span><span class="s1">down</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">指定位置から下方向にレイキャストを行うコマンドをまとめる</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// RaycastCommand</span><span class="s11">型は、結果に</span><span class="s1">ReycastHit</span><span class="s11">型を返してくる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">command</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">RaycastCommand</span><span class="s3">(</span><span class="s1">targetPosition</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">commands</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s4">command</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// </span><span class="s11">ジョブの初期化をする</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">hitCheckJob</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">HitCheckJob</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">hits</span><span class="s1"> = </span><span class="s4">results</span><span class="s1">,</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">velocities</span><span class="s3"> = </span><span class="s1">velocity</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">applyPositionJob</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">ApplyPositionJob</span><span class="s3">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">velocities</span><span class="s3"> = </span><span class="s1">velocity</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// </span><span class="s1">レイキャスト、ヒットチェックまでは変わらず、</span><span class="s10">applyPos</span><span class="s1">のハンドルをグローバル変数に入れる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commandJobHandle</span><span class="s3"> = </span><span class="s1">RaycastCommand</span><span class="s3">.</span><span class="s5">ScheduleBatch</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s8">10</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">hitcheckHandle</span><span class="s3"> = </span><span class="s1">hitCheckJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s8">10</span><span class="s3">, </span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">applyPosHandle</span><span class="s3"> = </span><span class="s1">applyPositionJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">transformAccess</span><span class="s3">, </span><span class="s1">hitcheckHandle</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>applyPosHandleをグローバルに定義して、その終了待ち=CompleteをUpdateの先頭で行う。</p>
<p class="p11"><span class="Apple-tab-span">	</span>グローバル化に祭して、いままでUpdateの最後でDisposeしていたテンポラリなNativeArrayもすべてグローバルな定義に変わる必要がある。</p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>Jobのインスタンス生成(参照渡し)と、レイキャストコマンドの生成/セットは変わらず。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>この時点で103fpsくらいになった。ちょっと高速化。</p>
<p class="p11"><span class="Apple-tab-span">	</span>プロファイラを見てみると、Update関数が実行されてからJobが実行されている。やったぜ。</p>
<p class="p12"><br></p>
<p class="p13"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-01-06%200.35.45.png" alt="スクリーンショット 2019-01-06 0.35.45.png"></p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>あと、WaitForJobIDが消えた。(乗らないくらい短いか、見落としてるか。)</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>ちょっとBurst化してみる</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>JobをBurstCompiler任せにしてみる。</p>
<p class="p11"><span class="Apple-tab-span">	</span>Job定義のstructに BurstCompile のアノテーションをつけるだけ。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>-&gt; 爆速になった。</p>
<p class="p11"><span class="Apple-tab-span">	</span>110fpsくらい出てる。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>値を得られるようにする</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>IJobを拡張したstructを用意する。</p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s2">struct</span><span class="s3"> </span><span class="s1">IsHit</span><span class="s3"> : </span><span class="s1">IJob</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">        </span>[</span><span class="s1">ReadOnly</span><span class="s3">] </span><span class="s2">public</span><span class="s3"> </span><span class="s1">NativeArray</span><span class="s3">&lt;</span><span class="s1">RaycastHit</span><span class="s3">&gt; </span><span class="s4">hits</span><span class="s3">;</span></p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">        </span>[</span><span class="s1">WriteOnly</span><span class="s3">] </span><span class="s2">public</span><span class="s3"> </span><span class="s1">NativeArray</span><span class="s3">&lt;</span><span class="s2">int</span><span class="s3">&gt; </span><span class="s4">isHit</span><span class="s3">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">public</span><span class="s1"> </span><span class="s2">void</span><span class="s1"> </span><span class="s5">Execute</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">hits</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s1">// </span><span class="s11">距離が</span><span class="s1">1f</span><span class="s11">より小さかったら、ヒットしている</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s7">if</span><span class="s1"> (</span><span class="s4">hits</span><span class="s1">[</span><span class="s4">i</span><span class="s1">].</span><span class="s4">distance</span><span class="s1"> &lt; </span><span class="s8">1f</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s4">isHit</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] = </span><span class="s8">0</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s7">return</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">それ以外であればすべてのインスタンスがヒットしてない</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">isHit</span><span class="s1">[</span><span class="s8">0</span><span class="s1">] = </span><span class="s8">1</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>Update内でヒットのハンドルを生成、ここでサイズ1のNativeArray&lt;int&gt;を入れる。</p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">hitHandle</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">IsHit</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">hits</span><span class="s1"> = </span><span class="s4">results</span><span class="s1">,</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">isHit</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">NativeArray</span><span class="s1">&lt;</span><span class="s2">int</span><span class="s1">&gt;(</span><span class="s8">1</span><span class="s1">, </span><span class="s4">Allocator</span><span class="s1">.</span><span class="s4">TempJob</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// </span><span class="s1">レイキャスト、ヒットチェックまでは変わらず、</span><span class="s10">applyPos</span><span class="s1">のハンドルをグローバル変数に入れる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commandJobHandle</span><span class="s3"> = </span><span class="s1">RaycastCommand</span><span class="s3">.</span><span class="s5">ScheduleBatch</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s8">10</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">isHitHandle</span><span class="s3"> = </span><span class="s1">hitHandle</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">hitcheckHandle</span><span class="s3"> = </span><span class="s1">hitCheckJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s8">10</span><span class="s3">, </span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">applyPosHandle</span><span class="s3"> = </span><span class="s1">applyPositionJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">transformAccess</span><span class="s3">, </span><span class="s1">hitcheckHandle</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// </span><span class="s1">ヒット判定だけは即座に終了させる</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">isHitHandle</span><span class="s1">.</span><span class="s5">Complete</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">isHit</span><span class="s3"> = </span><span class="s1">hitHandle</span><span class="s3">.</span><span class="s1">isHit</span><span class="s3">[</span><span class="s8">0</span><span class="s3">];</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">if</span><span class="s1"> (</span><span class="s4">isHit</span><span class="s1"> != </span><span class="s8">1</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">Debug</span><span class="s1">.</span><span class="s5">Log</span><span class="s1">(</span><span class="s17">"</span><span class="s18">ヒットした</span><span class="s17">"</span><span class="s1">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">        </span></span><span class="s10">// hitHandle</span><span class="s1">の</span><span class="s10">isHit</span><span class="s1">はこのブロック内で生成しているパラメータなので、ここで消費する。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">hitHandle</span><span class="s3">.</span><span class="s1">isHit</span><span class="s3">.</span><span class="s5">Dispose</span><span class="s3">();</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p12"><span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="Apple-tab-span">	</span>isHitHandleを生成、レイキャストのあとに実行する。</p>
<p class="p11"><span class="Apple-tab-span">	</span>で、ヒット判定だけをCompleteにして値を受け取李判断に使う。便利。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p11"><b>コルーチン化する</b></p>
<p class="p11"><span class="Apple-tab-span">	</span>ちょっとは書きやすくなるか？</p>
<p class="p5"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s1">IEnumerator</span><span class="s3"> </span><span class="s5">Start</span><span class="s3">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commands</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastCommand</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">Persistent</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">results</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s6">RaycastHit</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">Persistent</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">transformAccess</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">TransformAccessArray</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">velocity</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">NativeArray</span><span class="s3">&lt;</span><span class="s2">float</span><span class="s3">&gt;(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s1">Allocator</span><span class="s3">.</span><span class="s1">Persistent</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">int</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">velocity</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s8">1</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">disposeAct</span><span class="s1"> = () =&gt;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">try</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">applyPosHandle</span><span class="s1">.</span><span class="s5">Complete</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">velocity</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">commands</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">results</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">transformAccess</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">catch</span><span class="s1"> { }</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s1">// </span><span class="s11">ジョブの初期化をする</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">hitCheckJob</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">HitCheckJob</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">hits</span><span class="s1"> = </span><span class="s4">results</span><span class="s1">,</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">velocities</span><span class="s3"> = </span><span class="s1">velocity</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">applyPositionJob</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">ApplyPositionJob</span><span class="s3">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">velocities</span><span class="s3"> = </span><span class="s1">velocity</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s7">while</span><span class="s1"> (</span><span class="s2">true</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">for</span><span class="s1"> (</span><span class="s2">var</span><span class="s1"> </span><span class="s4">i</span><span class="s1"> = </span><span class="s8">0</span><span class="s1">; </span><span class="s4">i</span><span class="s1"> &lt; </span><span class="s4">targets</span><span class="s1">.</span><span class="s4">Length</span><span class="s1">; </span><span class="s4">i</span><span class="s1">++)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">targetPosition</span><span class="s3"> = </span><span class="s1">targets</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">position</span><span class="s3">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">direction</span><span class="s1"> = </span><span class="s4">Vector3</span><span class="s1">.</span><span class="s4">down</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">                </span></span><span class="s10">// </span><span class="s1">指定位置から下方向にレイキャストを行うコマンドをまとめる</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s1">// RaycastCommand</span><span class="s11">型は、結果に</span><span class="s1">ReycastHit</span><span class="s11">型を返してくる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">command</span><span class="s3"> = </span><span class="s2">new</span><span class="s3"> </span><span class="s6">RaycastCommand</span><span class="s3">(</span><span class="s1">targetPosition</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">commands</span><span class="s1">[</span><span class="s4">i</span><span class="s1">] = </span><span class="s4">command</span><span class="s1">;</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">hitHandle</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">IsHit</span><span class="s1">()</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">hits</span><span class="s1"> = </span><span class="s4">results</span><span class="s1">,</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">isHit</span><span class="s1"> = </span><span class="s2">new</span><span class="s1"> </span><span class="s6">NativeArray</span><span class="s1">&lt;</span><span class="s2">int</span><span class="s1">&gt;(</span><span class="s8">1</span><span class="s1">, </span><span class="s4">Allocator</span><span class="s1">.</span><span class="s4">TempJob</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>};</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">レイキャスト、ヒットチェックまでは変わらず、</span><span class="s10">applyPos</span><span class="s1">のハンドルをグローバル変数に入れる。</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">commandJobHandle</span><span class="s3"> = </span><span class="s1">RaycastCommand</span><span class="s3">.</span><span class="s5">ScheduleBatch</span><span class="s3">(</span><span class="s1">commands</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s8">10</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">isHitHandle</span><span class="s3"> = </span><span class="s1">hitHandle</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s3"> </span><span class="s1">hitcheckHandle</span><span class="s3"> = </span><span class="s1">hitCheckJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">targets</span><span class="s3">.</span><span class="s1">Length</span><span class="s3">, </span><span class="s8">10</span><span class="s3">, </span><span class="s1">commandJobHandle</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p9"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">applyPosHandle</span><span class="s3"> = </span><span class="s1">applyPositionJob</span><span class="s3">.</span><span class="s5">Schedule</span><span class="s3">(</span><span class="s1">transformAccess</span><span class="s3">, </span><span class="s1">hitcheckHandle</span><span class="s3">);</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// </span><span class="s1">ヒット判定だけは即座に終了させる</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">isHitHandle</span><span class="s1">.</span><span class="s5">Complete</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s2">var</span><span class="s1"> </span><span class="s4">isHit</span><span class="s1"> = </span><span class="s4">hitHandle</span><span class="s1">.</span><span class="s4">isHit</span><span class="s1">[</span><span class="s8">0</span><span class="s1">];</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">if</span><span class="s1"> (</span><span class="s4">isHit</span><span class="s1"> != </span><span class="s8">1</span><span class="s1">)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">Debug</span><span class="s1">.</span><span class="s5">Log</span><span class="s1">(</span><span class="s17">"</span><span class="s18">ヒットした</span><span class="s17">"</span><span class="s1">);</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p10"><span class="s9"><span class="Apple-converted-space">            </span></span><span class="s10">// hitHandle</span><span class="s1">の</span><span class="s10">isHit</span><span class="s1">はこのブロック内で生成しているパラメータなので、ここで消費する。</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">hitHandle</span><span class="s1">.</span><span class="s4">isHit</span><span class="s1">.</span><span class="s5">Dispose</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">yield</span><span class="s1"> </span><span class="s7">return</span><span class="s1"> </span><span class="s2">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s1">// applyPosHandle </span><span class="s11">の終了を待つ</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">applyPosHandle</span><span class="s1">.</span><span class="s5">Complete</span><span class="s1">();</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p4"><span class="s1"></span><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>NativeArrayとか、jobHandleの生成を一度きりにできた。</p>
<p class="p11"><span class="Apple-tab-span">	</span>参照だけをなんとかできるのが良い。</p>
<p class="p12"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span>最後のjobHandleをIEnumの中に仕舞うのは、JobHandleがnullableでないのでできなかった。</p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p12"><br></p>
<p class="p12"><br></p>
</body>
</html>
