<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.47">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb; min-height: 18.0px}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>MoonSharp</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityでLuaが動かせるので、使ってみていた。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>MoonSharp</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://www.moonsharp.org">http://www.moonsharp.org</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>使い方次第では綺麗に自分の足が消し飛んだりすると思う。</p>
<p class="p3"><span class="Apple-tab-span">	</span>MODライクな使い方は考えていなくて、特にデバッグや自動テストのためのツールとして使おうと思っていた。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>結果的には2501というプロジェクトでとても役になった。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>ざっくりとできることまとめ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・luaをUnity上で実行できる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・実行するluaはstringからいける</p>
<p class="p3"><span class="Apple-tab-span">	</span>・特定のlua実行コンテキストを持ち回すことができる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・実行コンテキストのluaテーブルを好きに書き換えることができる(！)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・インスタンスを渡すこともできるので、好きにメソッドが呼べる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・luaのコルーチンも使える</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>やりにくいことまとめ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・当然だけど複雑な引数を持つ関数は実行しづらい</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>逆引きっぽいコンテンツ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>以下は、勉強しながら触ってたらいい感じに逆引きみたいになった学習ログ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>staticな実行コンテキストでluaを実行する</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>luaの中で定義した関数をluaの中で実行し、結果をC#側で得ることができる。</p>
<p class="p2"><br></p>
<p class="p4">double MoonSharpFactorial()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string script = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>function fact (n)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if (n == 0) then</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return 1</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>else</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return n*fact(n - 1)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return fact(5)";</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>DynValue res = Script.RunString(script);</b></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>Scriptの実行コンテキストを保持する</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>実行コンテキストはstaticではなく生成できる。</p>
<p class="p2"><br></p>
<p class="p4">double MoonSharpFactorial()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>function fact (n)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if (n == 0) then</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return 1</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>else</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return n*fact(n - 1)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return fact(5)";</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>Script script = new Script();</b></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.DoString(scriptCode);</p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Luaコードのコンテキストに干渉する</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>変数の値とかに干渉できる。</p>
<p class="p2"><br></p>
<p class="p4">double MoonSharpFactorial()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>function fact (n)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if (n == 0) then</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return 1</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>else</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return n*fact(n - 1)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return fact(mynumber)";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>script.Globals["mynumber"] = 7;</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.DoString(scriptCode);</p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>global値に干渉できる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>唐突だな～～。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>特定のメソッドを呼ぶ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>DoStringで評価してから、Call関数で関数名を指定して引数を渡す、ってことができる。</p>
<p class="p2"><br></p>
<p class="p4">double MoonSharpFactorial2()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>function fact (n)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if (n == 0) then</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return 1</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>else</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return n*fact(n - 1)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>DynValue res = script.Call(script.Globals["fact"], 4);</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>DynValue型は関数ポインタとして取り出せる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>別にC#側から自由に呼べるわけではない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>単にポインタとして保持できる、っていうだけ。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p4">double MoonSharpFactorial()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>function fact (n)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if (n == 0) then</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return 1</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>else</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return n*fact(n - 1)</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>end";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>DynValue luaFactFunction = script.Globals.Get("fact");</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.Call(<b>luaFactFunction</b>, 4);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>DynValueはTuple型にもなれる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>要素が三つのTupleで、indexアクセスができる。</p>
<p class="p2"><br></p>
<p class="p4">DynValue ret = Script.RunString("return true, 'ciao', 2*3");</p>
<p class="p5"><br></p>
<p class="p4">// prints "Tuple"</p>
<p class="p4">Console.WriteLine("{0}", ret.Type);</p>
<p class="p5"><br></p>
<p class="p4">// Prints:</p>
<p class="p4">// <span class="Apple-converted-space">  </span>Boolean = true</p>
<p class="p4">// <span class="Apple-converted-space">  </span>String = "ciao"</p>
<p class="p4">// <span class="Apple-converted-space">  </span>Number = 6</p>
<p class="p4">for (int i = 0; i &lt; ret.Tuple.Length; i++)</p>
<p class="p4"><span class="Apple-tab-span">	</span>Console.WriteLine("{0} = {1}", ret.Tuple[i].Type, ret.Tuple[i]);</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>関数を渡せる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>luaの中の関数定義を書き換えることで、C#の関数をluaから呼ぶことができる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>かなり無理やり。</p>
<p class="p2"><br></p>
<p class="p4"><b>private static int Mul(int a, int b)</b></p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-converted-space">    </span>return a * b;</p>
<p class="p4">}</p>
<p class="p5"><br></p>
<p class="p4">private static double CallbackTest()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-converted-space">    </span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-converted-space">        </span>-- defines a factorial function</p>
<p class="p4"><span class="Apple-converted-space">        </span>function fact (n)</p>
<p class="p4"><span class="Apple-converted-space">            </span>if (n == 0) then</p>
<p class="p4"><span class="Apple-converted-space">                </span>return 1</p>
<p class="p4"><span class="Apple-converted-space">            </span>else</p>
<p class="p4"><span class="Apple-converted-space">                </span>return Mul(n, fact(n - 1));</p>
<p class="p4"><span class="Apple-converted-space">            </span>end</p>
<p class="p4"><span class="Apple-converted-space">        </span>end";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-converted-space">    </span>script.Globals["Mul"] = (Func&lt;int, int, int&gt;)Mul;</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>DynValue res = script.Call(script.Globals["fact"], 4);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>置き換えなしにC#のメソッドを呼ぶ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>特定のAttrを付けたクラスのメソッドを、Luaから呼び出す。</p>
<p class="p3"><span class="Apple-tab-span">	</span>下記の例だと、MyClass クラスのcalcHyptenuseメソッドを、名前ベースでluaのグローバル変数にバインドすることなく呼び出している。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・実際にはUserData.RegisterAssemblyというメソッドでバインドしている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・クラスのインスタンスはバインドしてる</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>とかがある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>これstaticにしても呼べるのかな？</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p4">[MoonSharpUserData]</p>
<p class="p4">class MyClass</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>public double calcHypotenuse(double a, double b)</p>
<p class="p4"><span class="Apple-tab-span">	</span>{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return Math.Sqrt(a * a + b * b);</p>
<p class="p4"><span class="Apple-tab-span">	</span>}</p>
<p class="p4">}</p>
<p class="p5"><br></p>
<p class="p4">double CallMyClass1()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return obj.calcHypotenuse(3, 4);</p>
<p class="p4"><span class="Apple-tab-span">	</span>";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>// Automatically register all MoonSharpUserData types</p>
<p class="p4"><b><span class="Apple-tab-span">	</span>UserData.RegisterAssembly();</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>// Pass an instance of MyClass to the script in a global</p>
<p class="p4"><span class="Apple-tab-span">	</span>script.Globals["obj"] = new MyClass();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Attrつけなくても、クラス個別で受け付ける方法</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>クラスインスタンスに対して、thisとかも使えるのを確認した。</p>
<p class="p2"><br></p>
<p class="p4">class MyClass</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>public double CalcHypotenuse(double a, double b)</p>
<p class="p4"><span class="Apple-tab-span">	</span>{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return Math.Sqrt(a * a + b * b);</p>
<p class="p4"><span class="Apple-tab-span">	</span>}</p>
<p class="p4">}</p>
<p class="p5"><br></p>
<p class="p4">static double CallMyClass2()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return obj.calcHypotenuse(3, 4);</p>
<p class="p4"><span class="Apple-tab-span">	</span>";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>// Register just MyClass, explicitely.</p>
<p class="p4"><b><span class="Apple-tab-span">	</span>UserData.RegisterType&lt;MyClass&gt;();</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>// create a userdata, again, explicitely.</p>
<p class="p4"><b><span class="Apple-tab-span">	</span>DynValue obj = UserData.Create(new MyClass());// この部分thisでもいける。</b></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>script.Globals.Set("obj", obj);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>luaからstaticなメソッドを呼ぶ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>いくつか方法があるが、以下が楽。</p>
<p class="p2"><br></p>
<p class="p4">double MyClassStaticThroughPlaceholder()</p>
<p class="p4">{</p>
<p class="p4"><span class="Apple-tab-span">	</span>string scriptCode = @" <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>return obj.calcHypotenuse(3, 4);</p>
<p class="p4"><span class="Apple-tab-span">	</span>";</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>// Automatically register all MoonSharpUserData types</p>
<p class="p4"><span class="Apple-tab-span">	</span>UserData.RegisterAssembly();</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>Script script = new Script();</p>
<p class="p5"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>script.Globals["obj"] = typeof(MyClassStatic);// Set関数は使えない。</b></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>DynValue res = script.DoString(scriptCode);</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>return res.Number;</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>使用感</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>2501では、これらを利用して、lua沼にbackboneというデバッグ用にnewしたインスタンスを沈めていた。</p>
<p class="p3"><span class="Apple-tab-span">	</span>するとluaからbackboneのインスタンスとそのpublicメソッドがぶったたけるので、とても便利、っていう。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>メモリ計測、ログ送付、スクリーンショット送付とかをやっている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>さらに、ユーザーのインスタンス(実行中のみ存命なインスタンス)を沈めることで、外部からリアルタイムでのメソッド着火を可能にしている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>これはとても柔軟で、登録されているaliveなインスタンス一覧、またpublicかつluaから渡せるインスタンスで動かせるメソッドを全部実行可能。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
