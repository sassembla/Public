<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1504.83">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    span.s1 {font: 12.0px Helvetica}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>AutoyaでのappVersion/resVersionの変化と挙動について</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span>Autoya</span>では、主に2つのバージョン値を使ってユーザーの手元のゲームを管理できるようになっている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span></span>特に<span class="s1">resVersion</span>がこれ超かっこいい機構なので解説する。</p>
<p class="p3"><span class="Apple-tab-span">	</span>まだ上書きの予約の実装みたいなのが終わってないんだけど。</p>
<p class="p4"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>よくあるアプリケーションの運用概念</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・最新版を配布しだしたのでユーザーに最新Appを取得してほしい</p>
<p class="p3"><span class="Apple-tab-span">	</span>・DLリソースを追加したのでDLのための事前情報をAppに与えて最新リソースをDLさせたい</p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>など。このへんはまあ最低限。</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><b>最新版を配布しだしたのでユーザーに最新Appを取得してほしい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Autoyaでは、appVersionというパラメータを使ってこれを実現できる。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・Assets/Autoya/Settings/AutoyaBuildManifestObject.csのappVerionにアプリケーションバージョン値を入れる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・AutoyaのHttpモジュールを経由した通信では、requestHeaderにappversion=“1.0.0”のようなパラメータが入る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・サーバ側でその値を確認し、アップデートしてほしいバージョンだった場合、responseHeaderにappversion=“1.0.1”などと返すと、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>クライアント側はその要求を受け、OverridePoints.cs/OnNewAppRequested メソッドが着火される。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>このメソッド内で「新しいAppがあるのでDLしてね！」って書いたりするといいと思う。</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>要は、次の3ポイントでアプリケーション更新が実装できる。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1. AutoyaBuildManifestObject.csにいい感じのappVersionを書く</p>
<p class="p3"><span class="Apple-tab-span">	</span>2.サーバ側から適当なタイミングでresponseHeaderにappversion=”X.Y.Z”とかを返す</p>
<p class="p3"><span class="Apple-tab-span">	</span>3. OverridePoints.cs/OnNewAppRequested メソッドにアプリケーション更新UIを出したり、ストアに遷移するコードを書く</p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><b>DLリソースを追加したのでDLのための事前情報をAppに与えて最新リソースをDLさせたい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Autoyaでは、resVersionというパラメータとAssetBundle関連の機構でこれらを実現している。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・Assets/Autoya/Settings/AutoyaRuntimeManifestObject.csのresVerionにリソースバージョン値を入れる</p>
<p class="p3"><span class="Apple-tab-span">	</span>・AutoyaのHttpモジュールを経由した通信では、requestHeaderにresversion=“1.0.0”のようなパラメータが入る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・サーバ側でその値を確認し、アップデートしてほしいバージョンだった場合、responseHeaderにresversion=“1.0.1”などと返すと、<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>クライアント側はその要求を受け、OverridePoints.cs/OnRequestNewAssetBundleList メソッドが着火される。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このメソッドには、今すぐ最新リソースリストをDLするか否か、YesかNoで返すことができる。</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Yesと答えるとバックグラウンドで新しいリソースリストのDLが開始される。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Noと答えるとリクエストは発生しない。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>バトル中など、リストが更新されても特に影響のない、横槍を受けたくない箇所ではNoを返すといいと思う。</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ちなみにYesを返してもNoを返してもゲーム側に何かデータ処理を要求することはない。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>使用しているAssetBundleにも影響はない。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・Yesと答えて新しいリソースリストのDLが完了すると、OverridePoints.cs /ShouldUpdateToNewAssetBundleList メソッドが着火される。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このメソッドには、DLが完了したリソースリストを今すぐ適応するか否か、true/falseで返すことができる。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>trueを返すと、リソースリストが更新される。現在使っているAssetは次回ロード時に自動的に最新のものを取得してくるようになる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>falseを返すと、リストの更新は延期される。新リストのデータはメモリ上にキャッシュされているため、次回以降のDLは発生しない。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ちなみにtrueを返してもfalseを返してもゲーム側に何かデータ処理を要求することはない。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>使用しているAssetBundleにも影響はない。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・リスト更新後、AutoyaのHttpモジュールを経由した通信では、requestHeaderにresversion=“1.0.1”など、更新後のパラメータが入る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・これ以降、ゲーム中でロードされる素材が自動的に最新のリストに記載されているものになる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>端末内に最新データが存在しない場合、使用するタイミングでダウンロードが発生するので、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>そういった形式になるのが困る場合はPrelaod機構を使うことをお勧めする。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>(preload機構は事前DLさせるリソースをサーバ側で変更できる。)</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>要は、次の4ポイントでアプリケーション更新が実装できる。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.Assets/Autoya/Settings/AutoyaRuntimeManifestObject.csのresVerionにリソースバージョン値を入れる</p>
<p class="p3"><span class="Apple-tab-span">	</span>2.サーバから適当なタイミングでresponseHeaderにresversion=“X.Y.Z”とかを返す</p>
<p class="p3"><span class="Apple-tab-span">	</span>3.OverridePoints.cs/OnRequestNewAssetBundleList メソッドでYesかNoを返す</p>
<p class="p3"><span class="Apple-tab-span">	</span>4.OverridePoints.cs /ShouldUpdateToNewAssetBundleList メソッドでtrueかfalseを返す</p>
<p class="p4"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span></p>
</body>
</html>
