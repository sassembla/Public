<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1504.83">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>現状のNAT越え</b></p>
<p class="p2"><br></p>
<p class="p3"><b>モチベーション</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span></b>tcpの到達が遅いケースを認識してる。なんとかしてサーバ -&gt; クライアントの情報伝達を高速にしたい。</p>
<p class="p2"><b></b><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>実現してあること</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>プレイヤー &lt;-&gt; サーバ間のP2P。udpとws(tcp)でのpushが可能になった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>nginx_luaで、udpとhttp + wsを受けられるようにして実現している。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>手順</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>1.udpをサーバに送る(upstreamの経路作成)</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>2.サーバからudpでレスポンス(downstreamの経路作成、ここでクライアントのグローバルIP:ポートを返す)</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>3.udpレスポンスを受け取ったら、クライアントからws接続、udp用グローバルポートをパラメータとして渡す(これでfull cone、address restricted cone, port restricted cone NATを突破できる。)</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>4.サーバからのudp pushが可能になる/wsでのtcpのpushが可能になる</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>まだある課題</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>wifiルータとかで接続できない(まだ最後のudp pushに失敗する)のがよくわかってない。多分wifiルータ側の設定とかだと思うんだけど。</p>
<p class="p3"><span class="Apple-tab-span">	</span>自宅の光回線でも同じことが起きてるんで、公共網以外は突破できてない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>symmetric NAT？ なんかどこかミスってるだけな気がする。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>クライアントへとポート番号を渡すくだり、サーバの固定キーで暗号化してもいいのかもしれない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>グローバルなポート番号はころころ変わる + 終端しか知り得ない情報なので、暗号化しても破れなそう。また、破ったところでudpが届かなくなるだけ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>要件</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>tcp pushが再送とかやってる間にudp pushが届くといいな～みたいな魂胆で、ネットワーク的な部分で次のような要件を満たしたい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.downstreamでの、tcp pushのついでにudp pushも行うことで、到達性、到達速度を高めたい</p>
<p class="p3"><span class="Apple-tab-span">	</span>2.接続の寿命管理を一括で行いたい</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>udp pushを成立させる条件</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>サーバからクライアントへとudpを送付する際、クライアントがudpをlistenしているIP:ポートに対してそのまま送っても、4G網ではデータが届かない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>これは、まあ、途中にNATがあって、そもそもクライアントにudpが到達できるマッピング状態がNAT上になかったり、NATでIP:ポートを変換させている場合があるため。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>au、softbankとかでは、port restricted cone NAT(IPもポートも変換するよ的なやつ)がある。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、サーバからudpを送りつけるために、お膳立て(NAT越え)をする必要がある。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.udpの経路をサーバ &lt;-&gt; クライアント間で作成する(一旦udpでのラウンドトリップを行えばOK)</p>
<p class="p3"><span class="Apple-tab-span">	</span>2.udpが来た経路へとudp pushする or グローバルIP:ポートに対してudp pushする(この2つの意味は、送信元のプロセスが違う以外、経路が全く一緒。)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>現状のサーバ構成</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>AWS micro上で、docker内にnginx-lua + disque</p>
<p class="p3"><span class="Apple-tab-span">	</span>inboundで解放してあるポートは8080/udpとtcpのみ。 udpとtcpのポートを合わせているが、違っても問題ないはず。</p>
<p class="p3"><span class="Apple-tab-span">	</span>outboundは無制限。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>通信の寿命</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>今回の構成では、1.udpでの経路作成後、ws接続 + 維持を行うタイミングで、グローバルIP:ポートに対してudpを送れるようにしてある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>通信の寿命はws接続が持っており、切断された場合、udpの情報送付もws(tcp)での情報送付/受信も不可能になる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-converted-space"> </span>なんでudpサーバで全部やらないのか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>現状では、udpの経路作成 + 同一サーバへとws接続、ということをやっている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>フローはともかく通信回数はおそらく最小で、これ以上小さくならない(udpをpushするためにはどうしてもクライアントからの送付が必要)。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>nginx streamっていうのがわりと新しめのnginxに入ってて、nginxでダイレクトにudp/tcpのロードバランシングができるんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>nginx-luaでの<b>ws構成</b>が現状でもhttpからのアップグレードで使用できるんで、そちらを優先した。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>切断検知とかpingとかのイベントがいい感じに整理されていて楽なので。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>じゃあnginx streamは使ってないのか、というとそうでもなくて、利用している。</p>
<p class="p3"><span class="Apple-tab-span">	</span>udpでのdownstream/upstream経路をNAT上に作り出すために、nginx streamでのudp受付 + グローバルIP:ポートを返す、という機構を使っている。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ダイレクトなtcp + udp接続を基礎にするなら、やはり切断検知ができるtcp接続を主にして、udpサーバとtcpサーバを1プロセスに根付く形にして、</p>
<p class="p3"><span class="Apple-tab-span">	</span>・tcp接続 -&gt; tcpサーバ起動(ポート一個消費してudpレシーバを拘束) + udpサーバ起動(ポート一個消費してudpレシーバを拘束) -&gt; tcp経由でクライアント側にudpを送らせて、udpのpushができる条件を整える</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>とかをやると思う。で、atomicなudpでのポート消費、tcpでのポート消費が面倒くさそうで、挫けた。nginx unit使ってgoとかで書くとよさげな気がする。動くかどうかは知らないけど。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>なんでupstreamもudpでやらないのか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>udpサーバをnginx_lua上に作るのが難しい。</p>
<p class="p3"><span class="Apple-tab-span">	</span>upstreamでもws(tcp)よりもudpを使った方が高速なのはまあありそうなので、できるといいなあとは思う。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>まずはdownstream pushさえ速ければいいのかなあという慢心がある。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>wsのライフサイクル上でudpをサーブする機構を実験中。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>-&gt; udpの接続受けのポートを接続単位でユニークかつ素敵にしないといけないんだけどそれやるにはportがユーザー数ぶんさらに減る + udpポート全開けでないといけない感じがしてアレ。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>また、nginx_lua上でudpを恒常的に受ける機構が無い。(upstream udp receiverのプルリクが途中で放置されてる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>もしupstreamもudpでやるのであれば、quicとかを視野に入れるのがいいのかなあと思ったりしている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>その場合はlibquicをluaから叩いて接続ごとに成立させる。udpなのでサーバからのpushのためにはクライアントからのudpでの接続が必要。</p>
<p class="p3"><span class="Apple-tab-span">	</span>もしくは、nginx unit goとかでgoquicを実行するのが良さそう。サーバ負荷が全く読めないのだが。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://devsisters.github.io/goquic/">http://devsisters.github.io/goquic/</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
