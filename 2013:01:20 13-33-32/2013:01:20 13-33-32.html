<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; background-color: #ebebeb; min-height: 15.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #4e9072; background-color: #ebebeb}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #727aff; background-color: #ebebeb}
    span.s1 {color: #931a68}
    span.s2 {text-decoration: underline}
    span.s3 {color: #0326cc}
    span.s4 {color: #727aff}
    span.s5 {color: #3933ff}
    span.s6 {color: #000000}
    span.s7 {text-decoration: underline ; color: #727aff}
    span.s8 {font: 11.0px 'Hiragino Kaku Gothic ProN'}
    span.s9 {font: 11.0px 'Hiragino Kaku Gothic ProN'; color: #000000}
    span.s10 {font: 12.0px Helvetica}
    span.s11 {background-color: transparent}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>AkkaのActorでBroadcast</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>AkkaのActorは、ScalaのActorsと異なり、ActorSystemという根幹システムを持っている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これによって、Actor間を跨いだコントロールや、システム同士のコントロールが可能になっている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Actors(2.9.x以前のScalaのActor)だと、この辺が無かったので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Broadcast = メッセージが全Actorに届く　とかしたい場合、自前でobject置くとかして対処してた。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>要は、機構として、Centralみたいなものが無くて、自前で実装しなきゃいけなかった、と。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>その辺、1WくらいでざっとJavaから使えるようにしたのがこの辺</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/ScalaMessengerPrototype">https://github.com/sassembla/ScalaMessengerPrototype</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、Akkaで書き直してJava?なにそれ？な感じになったものを使ってはや三ヶ月。</p>
<p class="p3"><span class="Apple-tab-span">	</span>月日が経つのは速い。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>もうActorsに関しては何もかも無かった事にしていいと思う。</p>
<p class="p3"><span class="Apple-tab-span">	</span>で、</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>AkkaのActorでBroadcastな仕組みを作ってみる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>例として今回のお題、複数のActor間でメッセージを解釈したい場合、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AkkaのActorでは、EventBusを使ってpub-subが実装できる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>参考：<a href="http://doc.akka.io/docs/akka/2.1-M2/scala/event-bus.html">http://doc.akka.io/docs/akka/2.1-M2/scala/event-bus.html</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>(Akka Router のBroadcastはこれとは異なった用途に使用する)</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>参考：<a href="http://doc.akka.io/docs/akka/snapshot/scala/routing.html">http://doc.akka.io/docs/akka/snapshot/scala/routing.html</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんな感じ。</p>
<p class="p3">SampleBroadcasterMain.scala</p>
<p class="p4"><span class="s1">import</span> akka.actor._</p>
<p class="p5"><br></p>
<p class="p4"><span class="s1">case</span> <span class="s1">class</span> Message<span class="s2">(</span><span class="s3">body</span>:String)</p>
<p class="p5"><br></p>
<p class="p4"><span class="s1">class</span> SampleActor <span class="s1">extends</span> Actor {</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> java.util.UUID</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">val</span> <span class="s3">myId</span> = UUID.randomUUID.toString</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">def</span> receive = {</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> <span class="s4">message</span>:Message =&gt; println(<span class="s5">"I am "</span>+<span class="s3">myId</span>+<span class="s5">" /message:"</span>+<span class="s4">message</span>.<span class="s3">body</span>) <span class="Apple-converted-space">   </span></p>
<p class="p4"><span class="Apple-converted-space">  </span>}</p>
<p class="p4">}</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p4"><span class="s1">object</span> SampleBroadcasterMain {</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">def</span> main(args: Array[String]) = {</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">   </span></span>//<span class="s2">Genereate</span> system</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">val</span> <span class="s4">system</span> = ActorSystem(<span class="s5">"namespace"</span>)</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">    </span></span>//Create actor</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">val</span> <span class="s4">sub1</span> = <span class="s4">system</span>.actorOf(Props[SampleActor])</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">    </span></span>//add actor to system-subscriber's network</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s4">system</span>.eventStream.subscribe(sub1, classOf[Message])</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">    </span></span>//add another one -the 2nd</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s4">system</span>.eventStream.subscribe(system.actorOf(Props[SampleActor]), classOf[Message])</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">    </span></span>//and add another one -the 3rd</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s4">system</span>.eventStream.subscribe(system.actorOf(Props[SampleActor]), classOf[Message])</p>
<p class="p5"><br></p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">    </span></span>//publish <span class="s2">messeage</span> from here to the all subscribers.</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s4">system</span>.eventStream.publish(Message(<span class="s5">"hereComes! subscrivers!!"</span>))</p>
<p class="p4"><span class="Apple-converted-space">  </span>}</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>実行すると</b></p>
<p class="p7">17:06:50.341 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] I am 77175ffd-9823-4444-96ac-7dc6e7d250e4 /message:hereComes! subscrivers!!</p>
<p class="p7">17:06:50.342 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] I am 6166563a-c421-4ae4-a820-8fbdec895e2e /message:hereComes! subscrivers!!</p>
<p class="p7">17:06:50.343 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] I am 88b7d855-b0fa-4706-87fd-558760876024 /message:hereComes! subscrivers!!</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>見事に、登録したactorすべてにMessageオブジェクトが投げられている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>らっくーーー。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>eventBusは、既存の用途としてDeadLetterとかに使っている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>それを外側からも使えるように、参加可能なようにしてある、という。</p>
<p class="p3"><span class="Apple-tab-span">	</span>なるほど的な感じ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>他にも何が楽か</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Logとかが楽になっています。</p>
<p class="p3"><span class="Apple-tab-span">	</span>たとえばLoggerみたいなものを個別に積んだり、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>LoggerActorみたいなのを作ってCentralPointみたいなものを自前で作ったりしてたのですが、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Akkaになると、ActorSystemに対してのLoggingの受け皿が取り付け可能なので、あとからLogをつけたり外したりがとても容易になりました。</p>
<p class="p3"><span class="Apple-tab-span">	</span>全体像としては、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・LogActorをActorへとmixin + log出力するコードをActorの中に書く</p>
<p class="p3"><span class="Apple-tab-span">	</span>・systemへと</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>systemへとlogListenerを追加</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">val</span> <span class="s3">logListener</span> = system.actorOf(Props[SampleLogListener])</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>と、</p>
<p class="p3"><span class="Apple-tab-span">	</span>logを入力したいActorへとtraitをmixim</p>
<p class="p4"><span class="s1">class</span> SampleActor <span class="s1">extends</span> Actor <span class="s1">with</span> ActorLogging {</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> java.util.UUID</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">val</span> <span class="s3">myId</span> = UUID.randomUUID.toString</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">def</span> receive = {</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> <span class="s4">message</span>:Message =&gt; {</p>
<p class="p4"><span class="Apple-converted-space">      </span>println(<span class="s5">"I am "</span>+myId+<span class="s5">" /message:"</span>+<span class="s7">message</span><span class="s2">.body</span>)</p>
<p class="p4"><span class="Apple-converted-space">      </span><span class="s3">log</span>.info(<span class="s5">"I am "</span>+myId+<span class="s5">" /message:"</span>+<span class="s7">message</span><span class="s2">.body</span>)</p>
<p class="p4"><span class="Apple-converted-space">    </span>}</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s2">}</span></p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、LogListenerの本体はこんな感じ</p>
<p class="p4"><span class="s1">class</span> SampleLogListener <span class="s1">extends</span> Actor {</p>
<p class="p6"><span class="s6"><span class="Apple-converted-space">  </span></span>//log</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.InitializeLogger</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.LoggerInitialized</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.Error</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.Warning</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.Info</p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">import</span> akka.event.Logging.Debug</p>
<p class="p5"><span class="Apple-converted-space">  </span></p>
<p class="p4"><span class="Apple-converted-space">  </span><span class="s1">def</span> receive = {</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> InitializeLogger(_)<span class="Apple-converted-space">                        </span><span class="s8">⇒</span> print(<span class="s5">"initilaized"</span>)</p>
<p class="p8"><span class="s6"><span class="Apple-converted-space">    </span></span><span class="s1">case</span><span class="s6"> Error(</span>cause<span class="s6">, </span>logSource<span class="s6">, </span>logClass<span class="s6">, </span>message<span class="s6">) </span><span class="s9">⇒</span><span class="s6"> print(</span><span class="s5">"Err<span class="Apple-converted-space">  </span>"</span><span class="s6"> + </span>message<span class="s6">)</span></p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> Warning(<span class="s4">logSource</span>, <span class="s4">logClass</span>, <span class="s4">message</span>)<span class="Apple-converted-space">      </span><span class="s8">⇒</span> print(<span class="s5">"War<span class="Apple-converted-space">  </span>"</span> + <span class="s4">message</span>)</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> Info(<span class="s4">logSource</span>, <span class="s4">logClass</span>, <span class="s4">message</span>) <span class="Apple-converted-space">        </span><span class="s8">⇒</span> print(<span class="s5">"Inf<span class="Apple-converted-space">  </span>"</span> + <span class="s4">message</span>)</p>
<p class="p4"><span class="Apple-converted-space">    </span><span class="s1">case</span> Debug(<span class="s4">logSource</span>, <span class="s4">logClass</span>, <span class="s4">message</span>)<span class="Apple-converted-space">        </span><span class="s8">⇒</span> print(<span class="s5">"Deb<span class="Apple-converted-space">  </span>"</span> + <span class="s4">message</span>)</p>
<p class="p4"><span class="Apple-converted-space">  </span>}</p>
<p class="p4">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ってな感じなので、後付けもらくちん。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ログはこんな感じにでます。</p>
<p class="p7">18:25:55.925 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] [INFO] [01/20/2013 18:25:55.845] [namespace-akka.actor.default-dispatcher-4] [akka://namespace/user/$b] I am 77175ffd-9823-4444-96ac-7dc6e7d250e4 /message:hereComes! subscrivers!!</p>
<p class="p7">18:25:55.926 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] [INFO] [01/20/2013 18:25:55.849] [namespace-akka.actor.default-dispatcher-2] [akka://namespace/user/$d] I am 6166563a-c421-4ae4-a820-8fbdec895e2e /message:hereComes! subscrivers!!</p>
<p class="p7">18:25:55.926 [INFO] [org.gradle.api.internal.project.ant.AntLoggingAdapter] [ant:java] [INFO] [01/20/2013 18:25:55.850] [namespace-akka.actor.default-dispatcher-3] [akka://namespace/user/$c] I am 88b7d855-b0fa-4706-87fd-558760876024 /message:hereComes! subscrivers!!</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここに<span class="s10">flu</span>entdとかへのつなぎ込みのコードを書けば、、、</p>
<p class="p3"><span class="Apple-tab-span">	</span>あとは、、、わかるな、、？</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>おまけ ActorSystemへようこそ</b></p>
<p class="p7"><span class="s11"><span class="Apple-tab-span">	</span>logの中に、</span>akka://namespace/user/<span class="s11"> とかが出ました。</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そう、このへんは、ActorSystemの名称なんです。さっき決めたやつ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>userから先に、actorが設置されている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Supervisorとかの話につながる、ActorSystemの全体像が、この辺に関わる感じ。</p>
<p class="p3"><span class="Apple-tab-span">	</span>詳しくは</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="http://doc.akka.io/docs/akka/2.0/general/actor-systems.html">http://doc.akka.io/docs/akka/2.0/general/actor-systems.html</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>サンプルとか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>サンプルは下記にupしますた。</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/AkkaSampleBroadcaster">https://github.com/sassembla/AkkaSampleBroadcaster</a></p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>フォルダで、</p>
<p class="p3"><span class="Apple-tab-span">	</span>gradlew runJar -d とかやると、稼働する筈。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
