<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1504.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb; min-height: 18.0px}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ffffff; min-height: 18.0px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ffffff}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.3px Courier; background-color: #ffffff}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.3px 'Hiragino Sans'; background-color: #ffffff}
    span.s1 {font: 22.0px Helvetica}
    span.s2 {font: 12.0px Helvetica}
    span.s3 {font: 12.0px 'Hiragino Sans'}
    span.s4 {font-kerning: none}
    span.s5 {font: 13.3px Courier; font-kerning: none}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><span class="s1"><b>RFC</b></span><b>に準拠した</b><span class="s1"><b>HTTP</b></span><b>ヘッダ比較について</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>RFCに反してるライブラリ使ってハマってた。</p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><b>何が起こったか</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>httpのヘッダのキーに大文字小文字でフル一致できる文字列が入っているはず、という</p>
<p class="p3"><span class="Apple-tab-span">	</span>謎の期待をするクライアント実装があって、</p>
<p class="p3"><span class="Apple-tab-span">	</span>それを知らずに使っていたため通信結果が失敗に終わるという感じで、なかなか真相に気づかずにハマった。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>対象のライブラリはこちら。</p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>websocket-sharp</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sta/websocket-sharp">https://github.com/sta/websocket-sharp</a></p>
<p class="p4"><br></p>
<p class="p4"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>困ってた部分のコードはこんな感じになっている。</p>
<p class="p4"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>WebSocket.cs</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sta/websocket-sharp/blob/ad563fa46c688094048fe3ed7a1df292e7bbe5d3/websocket-sharp/WebSocket.cs#L779">https://github.com/sta/websocket-sharp/blob/ad563fa46c688094048fe3ed7a1df292e7bbe5d3/websocket-sharp/WebSocket.cs#L779</a></p>
<p class="p5"><span class="Apple-converted-space">      </span>var headers = response.Headers;</p>
<p class="p5"><span class="Apple-converted-space">      </span>if (!validateSecWebSocketAcceptHeader (headers["<b>Sec-WebSocket-Accept</b>"])) {</p>
<p class="p5"><span class="Apple-converted-space">        </span>message = "Includes no Sec-WebSocket-Accept header, or it has an invalid value.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">      </span>if (!validateSecWebSocketProtocolServerHeader (headers["<b>Sec-WebSocket-Protocol</b>"])) {</p>
<p class="p5"><span class="Apple-converted-space">        </span>message = "Includes no Sec-WebSocket-Protocol header, or it has an invalid value.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">      </span>if (!validateSecWebSocketExtensionsServerHeader (headers["<b>Sec-WebSocket-Extensions</b>"])) {</p>
<p class="p5"><span class="Apple-converted-space">        </span>message = "Includes an invalid Sec-WebSocket-Extensions header.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">      </span>if (!validateSecWebSocketVersionServerHeader (headers["<b>Sec-WebSocket-Version</b>"])) {</p>
<p class="p5"><span class="Apple-converted-space">        </span>message = "Includes an invalid Sec-WebSocket-Version header.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">      </span>}</p>
<p class="p7"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>この内容と大文字小文字がジャストマッチしてないと、WebSocket接続のハンドシェイクが失敗に終わる。</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>対して、WebSocketのRFCの基準はこちら</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://tools.ietf.org/html/rfc6455#section-2.1">https://tools.ietf.org/html/rfc6455#section-2.1</a></p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p8"><span class="Apple-tab-span">	</span>…</p>
<p class="p7"><br></p>
<p class="p9"><span class="s3"><span class="Apple-tab-span">	</span></span><span class="s4">Comparing two strings in an _ASCII case-insensitive_ manner means</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">   </span>comparing them exactly, code point for code point, except that the</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">   </span>characters in the range U+0041 to U+005A (i.e., LATIN CAPITAL LETTER</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">   </span>A to LATIN CAPITAL LETTER Z) and the corresponding characters in the</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">   </span>range U+0061 to U+007A (i.e., LATIN SMALL LETTER A to LATIN SMALL</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">   </span>LETTER Z) are considered to also match.</span></p>
<p class="p7"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>…</p>
<p class="p7"><span class="Apple-tab-span">	</span></p>
<p class="p10"><span class="s3"><span class="Apple-tab-span">	</span>文字列比較について、特に</span><span class="s5">_ASCII case-insensitive_</span><span class="s4">って書いてあるところはこうすべきだよ～みたいな但し書きがあって、</span></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span><span class="s4">・大文字だろうが小文字だろうがマッチすること</span></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span><span class="s4">という感じになっている。</span></p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>というわけで、修正したものをプルリク済み。</p>
<p class="p8"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sta/websocket-sharp/pull/315">https://github.com/sta/websocket-sharp/pull/315</a></p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p8"><span class="Apple-tab-span">	</span>ちなみに一切テストコードが存在しないんで、まあ、なんだ、、一度手元で動かしたけど確証はないので、つらい。</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
</body>
</html>
