<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.39">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'; min-height: 17.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'; color: #d12f1b; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px 'Hiragino Kaku Gothic ProN'; color: #d12f1b; min-height: 17.0px}
    span.s1 {font: 11.0px Helvetica}
    span.s2 {color: #d12f1b}
    span.s3 {color: #000000}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>expect + ssh + tail で嵌った話</b></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>expect を人から薦めてもらう機会があったので、やりたいこと一つ叶えてみてた。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>sshでサーバに入って特定の語句を捉えてなんかする、、的なことが出来るので、</p>
<p class="p3"><span class="Apple-tab-span">	</span><b>sshで入って</b><span class="s1"><b>ta</b></span><b>ilしたサーバのファイル更新内容をローカルへの標準入力に吐き出す</b>みたいなのを作った。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>EnteringOrbit</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/EnteringOrbit/tree/master">https://github.com/sassembla/EnteringOrbit/tree/master</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>困った事</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>expectでのssh後に素直に<span class="s1">ex</span>pectでいろんなトラブルを待って、解消したらあきらめるとかtailするとかで良いと思ってたんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>expect + ssh + tail なのがどうも良く無い。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>予定だと、sshでログイン後に実行するのがtailで、これは本来は勝手には終了しないはずなのに、</p>
<p class="p3"><span class="Apple-tab-span">	</span>expectコマンドで使うとtailでロックせずすっぽ抜けて、expectそのものが終了してしまう。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>→(本来なら、tailは成立した瞬間からファイルの更新シグナルを待ち構える)</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、すっぽ抜けるので、どうしようかなーと思っていた。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>なんとかなって、</p>
<p class="p3"><span class="Apple-tab-span">	</span>結論としてはinteractで、expectで待ってくれないコマンドでもロックを効かせることができる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>下記のコマンドでOKだった。</p>
<p class="p2"><br></p>
<p class="p4">expect -c <span class="s2">"</span></p>
<p class="p4">spawn ssh someone@somewhere;</p>
<p class="p5"><span class="s3">send \</span>"tail -f ./some.txt\n\";</p>
<p class="p4">interact<span class="s2">"</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これで、ちゃんとtailが実行され続ける。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>代償として、擬似的になんらかの入力を行わないと、Terminalにsshプロセスの残骸が残ったりするようだった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>アプリケーション側ではfileのcloseを入力する事でちゃんと閉じるようにしてある。</p>
<p class="p2"><br></p>
<p class="p6"><br></p>
<p class="p3"><b>(メモ)README.mdに書くべき事</b></p>
<p class="p4"><b><span class="Apple-tab-span">	</span></b>EnteringOrbit -s someone@somewhere -t ./some.txt | nnotif</p>
<p class="p3"><span class="Apple-tab-span">	</span>で、サーバにsshで入ってsome.txtをtailした結果をMacのローカルなNotificationに放流できたりする。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これでサーバのログを見ながらコード上にエラー表示したりするのが楽になる。みたいな。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>nnotif は標準入力からMacのNSDistributedNotificationを発行するやつ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>nnotif</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/nnotif">https://github.com/sassembla/nnotif</a></p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>やー　やっぱりコマンドラインは柔軟だけど面倒くさいですね。あとでラップしちゃうからいいけど。</p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
</body>
</html>
