<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1265.21">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Courier; color: #87165e}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Courier; color: #394251}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Courier; color: #394251; min-height: 14.0px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; color: #394251; min-height: 16.0px}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; color: #394251}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #394251}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #394251; min-height: 18.0px}
    span.s1 {font: 22.0px 'Hiragino Kaku Gothic ProN'}
    span.s2 {font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.s3 {color: #394251}
    span.s4 {color: #87165e}
    span.s5 {font: 12.0px Courier}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Datomic</b><span class="s1"><b>の始め方</b></span></p>
<p class="p2"><br></p>
<p class="p3">DL</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3">memory database<span class="s2"> を動かす</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>フォルダを適当なところに移動</p>
<p class="p3">bin/shell</p>
<p class="p4">実行</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p5"><span class="s3">uri = </span>"datomic:mem://hello"<span class="s3">;</span></p>
<p class="p6">Peer.createDatabase(uri);</p>
<p class="p6">conn = Peer.connect(uri);</p>
<p class="p6"><span class="Apple-tab-span">	</span>&lt;datomic.peer.LocalConnection@473fae05&gt;</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p6">datom = Util.list(<span class="s4">"db/add"</span>,<span class="Apple-converted-space"> </span></p>
<p class="p6"><span class="Apple-converted-space">                  </span>Peer.tempid(<span class="s4">"db.part/user"</span>),<span class="Apple-converted-space"> </span></p>
<p class="p6"><span class="Apple-converted-space">                  </span><span class="s4">"db/doc"</span>,</p>
<p class="p6"><span class="Apple-converted-space">                  </span><span class="s4">"hello world"</span>);</p>
<p class="p8"><br></p>
<p class="p9">resp = conn.transact(Util.list(datom));</p>
<p class="p7"><br></p>
<p class="p6">db = conn.db();</p>
<p class="p7"><br></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span>クエリを打ってみる</p>
<p class="p5"><span class="s3">Peer.q(</span>"[:find ?entity :where [?entity :db/doc \"hello world\"]]"<span class="s3">, db);<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span>&lt;[[17592186045417]]&gt;</p>
<p class="p7"><br></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span>なんか値っぽい物が帰ってきた。</p>
<p class="p7"><br></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span>別のクエリを打ってみる</p>
<p class="p5"><span class="s3">Peer.q(</span>"[:find ?entity :where [?entity :db/doc \"hello\"]]"<span class="s3">, db);<span class="Apple-converted-space"> </span></span></p>
<p class="p7"><br></p>
<p class="p6"><span class="Apple-tab-span">	</span>&lt;[]&gt;</p>
<p class="p7"><br></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span>空が帰ってきた。</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p10"><span class="s5"><span class="Apple-tab-span">	</span></span>インメモリなDBですよ、っと。</p>
<p class="p10"><span class="Apple-tab-span">	</span>次に、Transactorを組んでみる</p>
<p class="p11"><br></p>
<p class="p10"><b>Transactor</b></p>
<p class="p10">bin/transactor config/samples/free-transactor-template.properties</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>で、</p>
<p class="p10">Starting datomic:free://localhost:4334/&lt;DB-NAME&gt;, storing data in: data ...</p>
<p class="p10"><span class="Apple-tab-span">	</span>とか言われるので、</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>この名前をuriとして、</p>
<p class="p10"><span class="Apple-tab-span">	</span>先ほどのインメモリDBを用意してみる。</p>
<p class="p10"><span class="Apple-tab-span">	</span>名前は、helloにした。</p>
<p class="p11"><br></p>
<p class="p10"><span class="s5">uri = "</span>datomic:free://localhost:4334/hello<span class="s5">";</span></p>
<p class="p6">Peer.createDatabase(uri);</p>
<p class="p6">conn = Peer.connect(uri);</p>
<p class="p7"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>&lt;{:db-id "hello-50e71742-772f-4487-9169-9a7e3c7fb196", :unsent-updates-queue 0, :pending-txes 0, :next-t 1000, :basis-t 62, :index-rev 0, :index-root {:rev 0, :key "50e7174a-8435-4d54-b9d6-715ced46eb45"}, :log-root {:rev 0, :key "50e7174a-2ad4-4091-a276-a8e41758d15e"}}&gt;</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>こんなん帰ってきた。先ほど作成したtransactorが動いていて、そこに接続できたみたいだ。</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>引き続き再現</p>
<p class="p11"><br></p>
<p class="p10">datom = Util.list("db/add",<span class="Apple-converted-space">  </span>Peer.tempid("db.part/user"),<span class="Apple-converted-space">  </span>"db/doc", "hello world");</p>
<p class="p9">resp = conn.transact(Util.list(datom));</p>
<p class="p11"><br></p>
<p class="p10">db = conn.db();</p>
<p class="p11"><br></p>
<p class="p10">Peer.q("[:find ?entity :where [?entity :db/doc \"hello world\"]]", db);</p>
<p class="p10"><span class="Apple-tab-span">	</span>これは、もちろん式なので変形可能</p>
<p class="p10">Peer.q("[:find ?entity :where [?entity :db/doc \"hello world\"]]", conn.db());</p>
<p class="p10"><span class="Apple-tab-span">	</span>値として取得したければ、</p>
<p class="p11"><br></p>
<p class="p10">results = Peer.q("[:find ?entity :where [?entity :db/doc \"hello world\"]]", conn.db());</p>
<p class="p11"><br></p>
<p class="p10">System.out.println(results.size());</p>
<p class="p10">1</p>
<p class="p10"><span class="Apple-tab-span">	</span>とか、扱える。</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>値を取得するには、まずIDを取得</p>
<p class="p10">id = (results.iterator().next()).get(0);</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>の、あと、</p>
<p class="p10">entity = conn.db().entity(id);</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>で、entityが取得できる。</p>
<p class="p10"><span class="Apple-tab-span">	</span>そこから、entityに対するkey-valueで、</p>
<p class="p10">name = entity.get(":db/doc");<span class="Apple-converted-space"> </span></p>
<p class="p10"><span class="Apple-tab-span">	</span>とか書くと、</p>
<p class="p10">&lt;hello world&gt;</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>が帰ってきた。</p>
<p class="p11"><br></p>
<p class="p10"><span class="Apple-tab-span">	</span>簡単なインメモリDB→Transactorで世界中のどこかへ。</p>
<p class="p10"><span class="Apple-tab-span">	</span>協調的な仕組みだなあ。</p>
<p class="p11"><br></p>
<p class="p11"><span class="Apple-tab-span">	</span></p>
<p class="p11"><br></p>
<p class="p10">http://docs.datomic.com/integrating-peer-lib.html</p>
</body>
</html>
