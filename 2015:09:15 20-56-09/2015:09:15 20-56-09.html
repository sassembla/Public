<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1348.17">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 17.0px 'Hiragino Kaku Gothic ProN'}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb; min-height: 18.0px}
    span.s1 {font: 22.0px 'Hiragino Kaku Gothic ProN'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>UnityEditor</b><span class="s1"><b>の</b></span><b>Undo/Redo</b><span class="s1"><b>システムについて【解決編】【最新】</b></span></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityEditorのUndo/Redoを管理するシステムについて、</p>
<p class="p3"><span class="Apple-tab-span">	</span>ScriptableObjectとかを使わないでも後付けで割と楽にUndo管理できるかんじになった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>採点してほしい。</p>
<p class="p2"><br></p>
<p class="p4"><b><span class="Apple-tab-span">	</span>☆この記事に書いてある内容は古くなった。もっともっともっと楽にUndo/Redo実現できた。</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>以下を見ような。</p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>サンプル</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/UndoSample">https://github.com/sassembla/UndoSample</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>ScriptableObjectをEditorで使った場合の欠点</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.以下のタイミングでnullになる</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>・UnityEditor起動時にInstance作成していた場合、UpdateやOnGUIが2~3回走ったあとにnullになる</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>・EditorのPlay -&gt; nullになる -&gt; Stop -&gt; nullになる</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>たとえばEditorWindowを使っていて、そこのOnEnableでScriptableObject派生のインスタンスを初期化した場合、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>OnEnableが発生したあと、特定の秒数後にすべてのScriptableObjectがnullになる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ちなみにこのときOnDestroyとかは発生しない。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>なんだかEditorの挙動と連動しているっぽい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>2.生成 -&gt; Undo -&gt; 消える -&gt; Redo -&gt; 復活 の際に、identityを失って困る</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>下記で詳しく書く</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>1.ScriptableObjectをEditorで使うとnullになるケースへの対処</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>たとえばScriptableObjectを避ける</p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p3"><span class="Apple-tab-span">	</span>正確には、「ScriptableObjectやその拡張を自分で作成して使う」のを避ける。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>EditorWindowのインスタンスなんかはScriptableObjectを拡張して作られているが、こいつらは突然nullになったりしない。</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>なのでUndo/Redo記録にはEditorWindowのインスタンスを使うといい。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>2.復活の際に困るケースの紹介とその解</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>要約すると、「Undo/Redoするとidentityを失ってRedoで関係再構築ができなくなる」問題。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>次のような場合を想定する。</p>
<p class="p2"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>オブジェクトid Aを生成</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bを生成、Bはオブジェクトid Aの下にぶら下がるような関係</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Undo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bが消える</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Undo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Aが消える</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Redo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Aが復活(<b>この際呼ばれるのはデフォルトコンストラクタ</b>)</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>出来上がるのはオブジェクトid A’</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Redo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bを生成、、、するんだけど、オブジェクトAは存在してなくて、呼ばれちゃうのはデフォルトコンストラクタで、、、</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>出来上がるのはオブジェクトid B’</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>オブジェクトid BをRedoしたつもりが、Bの生成にはデフォルトコンストラクタが呼ばれてしまい、</p>
<p class="p3"><span class="Apple-tab-span">	</span>またその要素をセットするのも難しい(ていうかセットする値を覚えているやつが居ない)</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>「Undo/Redoするとidentityを失ってRedoで関係再構築ができなくなる」</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>さてどうしよう、っていう。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Undo -&gt; Redoの流れで、非常に困る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>特にリストでものを扱ったりする際に困る。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Undo/Redo対象がScriptableObjectでもScriptableObjectでなくても困る。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Q.なんでこうなってるんだろう？</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>推測A.<span class="Apple-converted-space"> </span></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>前提として、MonoBehaviourとかComponentとか、そのへんを扱う前提だからじゃねーかな、、</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Componentへの干渉とかも特別にトラックしてるくらいだし。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>たとえばGameObjectとかを扱う場合だとすごくスッキリ動くんだけど、Editor側で利用するにはnull化とかがあって正直無理。</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>んで解</b></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>解決を考える。</p>
<p class="p3"><span class="Apple-tab-span">	</span>生成時にフックになるような情報(ここではindexと生成idを組み合わせた辞書)を持っておく。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>あるリストがあるとき、その要素は</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>[0,1,2,3,,,]　みたいなindexで表される。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これは<b>要素の途中削除を行わない限り</b>、Undoしたら最大1項目減り、Redoすれば最大1項目増える、という形になる。</p>
<p class="p2"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>こんなリストがあったとして、</p>
<p class="p5"><span class="Apple-tab-span">	</span>[] (empty</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>このリストに何かを足す(Do</p>
<p class="p5"><span class="Apple-tab-span">	</span>[0]</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>このリストにさらに何かを足す(Do</p>
<p class="p5"><span class="Apple-tab-span">	</span>[0,1]</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>このリストに足したのをUndoする</p>
<p class="p5"><span class="Apple-tab-span">	</span>[0]</p>
<p class="p6"><span class="Apple-tab-span">	</span></p>
<p class="p5"><span class="Apple-tab-span">	</span>このリストに足したのをUndoしたのをRedoする</p>
<p class="p5"><span class="Apple-tab-span">	</span>[0,1]</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>というかんじに、<b>indexの値と動作の内容は完全に一致させて記録することができる。</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span>この関係は増えたり減ったりするのが連続した1次元的な事象である限り崩れない。</b></p>
<p class="p6"><b></b><br></p>
<p class="p5"><span class="Apple-tab-span">	</span>要素の途中削除を避ける方法としては、論理削除とかがありえる。(要素からは消さず、ただ見えないことにする等。)</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>この特性を利用して、</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p5"><span class="Apple-tab-span">	</span>オブジェクトid Aを生成</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>生成時にint index_of_A(たとえば0)をキー、id値 Aをvalueとして持つ。</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bを生成、Bはオブジェクトid Aの下にぶら下がるような関係</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>生成時にint index_of_B(ここではAのindexが0なので、0 + 1 = 1)をキー、id値 Bをvalueとして持つ。</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Undo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bが消える</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Undo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Aが消える</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>このあたりの動作では生成時の記録は干渉されず、消えない。</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Redo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Aが復活(<b>この際呼ばれるのはデフォルトコンストラクタ</b>)</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>出来上がるのはオブジェクトid A’</p>
<p class="p6"><br></p>
<p class="p5"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ここで、Redoをトリガーに、A’(indexは0)の内容を、記録をもとに過去存在した A に書き換える。</b></p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; Redo</p>
<p class="p5"><span class="Apple-tab-span">	</span> -&gt; オブジェクトid Bを生成、、、するんだけど、オブジェクトAは存在してなくて、呼ばれちゃうのはデフォルトコンストラクタで、、、</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>出来上がるのはオブジェクトid B’</p>
<p class="p6"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><b>ここで、Redoをトリガーに、B’(indexは0)の内容を、記録をもとに過去存在した B に書き換える。</b></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>という感じで、コンストラクタの役割を持たせることができる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>「途中のオブジェクトを消してはならない」という制約はつくが、安定して動く。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Undoで消えるぶんには、新しい記録が作られるかRedoされるかの2択しかないので、問題ない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>新しい記録を作った際にはRedo履歴も消えるので。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>嘘</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>実際には上記の説明では端折りがあり、もっと厄介なことが起きている。そして自動的に解決される。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>あるScriptableObjectの下に、List&lt;Content&gt; contents があった時、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>contentsに対してnew Contentを足したりすると、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>Undo時にcontentsが一件消え、</p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>Redo時にcontentsの内容すべてが再生成される</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>(サンプルをUndo/Redoしたりしてみてびっくりしてほしい。)</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ドラマチックゥ～～。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ただし、contentsの内容のすべてが再生成される際、その内部のパラメータは「オリジナルがある場合引っ張ってくる」みたいなのが発生しているらしく、</p>
<p class="p3"><span class="Apple-tab-span">	</span>全く問題ない状態を維持する。不思議だ。まあインスタンスの内容をまるっと覚えておいて反映させる、っていう機構なので、さもありなん。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>よって、問題にはならない。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Undo/Redoをあとから設置しやすくなる指針</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ガチでやらんかぎりそんなにないとは思うが。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・Redoでのリジェネレーション時にできることを明確にしておく</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>コンストラクタはデフォルトをつかう、とか。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Inspector表示用にはScriptableObjectが使える(時々勝手にnullになるが)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Inspector表示用以外にScriptableObjectまたは派生物を扱うのはやめる(スッゲーめんどいので)</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>まとめ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>EditorWindowにUndo/Redoを積んで、new -&gt; Undo -&gt; Redoさえ追跡できるようになればUndo/Redoめっちゃ簡単だぞ！！</p>
<p class="p3"><span class="Apple-tab-span">	</span>私は悟りを開いた。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>一巡した世界の果てで「えっそうなの」って叫ぶ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ということで中の方に読んでいただいたところ、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>・ScriptableObjectがnullになるのは、ScriptableObject 内で hideFlags = HideFlags.DontSave; とかやるとnullにならなくなるよ</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>って教えてもらった。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>うおーーー素敵。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>んで、あとは、</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ScriptableObjectをガンガン作る</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span> or<span class="Apple-converted-space"> </span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>上位に一個記録媒体みたいな役割を置いて下位を自動的に監視する、の2択。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>個人的には上位集約させるほうが枝葉にUndo書くとかがなくなってくれるので好き。</p>
<p class="p3"><span class="Apple-tab-span">	</span>一定の共通の意味の処理を上位に集約できると、挙動変えたり直すの楽なので、、</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>各ScriptableObjectでRecordObject書くのはヤダなあ、、まあ郷に入っては郷に従え。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>そして3週目の世界へ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>この記事に書いてある内容は古い。<b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>以下を見て欲しい。</p>
</body>
</html>
