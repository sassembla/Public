<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Kaku Gothic ProN'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #4f8187; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #31595d; background-color: #ebebeb}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #ebebeb}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #78492a}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #78492a; min-height: 13.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #ebebeb; min-height: 13.0px}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #78492a; background-color: #ebebeb}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #d6d6d6}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #008400; background-color: #d6d6d6}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #78492a; background-color: #d6d6d6}
    p.p15 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #4f8187; background-color: #d6d6d6}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; background-color: #d6d6d6; min-height: 13.0px}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #4f8187}
    p.p18 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #d12f1b; background-color: #ebebeb}
    p.p19 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #008400; background-color: #ebebeb}
    p.p20 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Menlo; color: #3d1d81; background-color: #ebebeb}
    p.p21 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #ff4013}
    span.s1 {color: #000000}
    span.s2 {color: #4f8187}
    span.s3 {color: #3d1d81}
    span.s4 {color: #78492a}
    span.s5 {color: #bb2ca2}
    span.s6 {color: #703daa}
    span.s7 {font: 12.0px 'Hiragino Kaku Gothic ProN'; color: #000000}
    span.s8 {color: #31595d}
    span.s9 {font: 11.0px 'Hiragino Kaku Gothic ProN'}
    span.s10 {color: #008400}
    span.s11 {color: #d12f1b}
    span.s12 {color: #272ad8}
    span.s13 {font: 11.0px Menlo; color: #4f8187}
    span.s14 {font: 11.0px Menlo}
    span.s15 {font: 12.0px Helvetica}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>UnityAppのViewの上にUIViewとかを置く</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity advent calendar 22日目です。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://qiita.com/advent-calendar/2012/unity">http://qiita.com/advent-calendar/2012/unity</a></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>iOS用に出力したUnityのパッケージを、Xcodeで作ったプロジェクトから呼ぶ(超手前味噌)</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://sassembla.github.com/Public/2012:12:04%201-29-54/2012:12:04%201-29-54.html">http://sassembla.github.com/Public/2012:12:04%201-29-54/2012:12:04%201-29-54.html</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>の発展系で、任意のUIViewをaddし、イベントをハンドルする、っつーことをしてみました。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>つまり、</p>
<p class="p3"><b><span class="Apple-tab-span">	</span>プラグインを全く書かずに、Obj-CでUnity上にいろいろ置いたりできるよね、っつー話です。</b></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>今回の内容は</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>・UnityのViewの上に安全にUIViewを置いて、いろいろ動作するか確認<span class="Apple-converted-space"> </span></b></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>動画</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.Unityのプロジェクトつくって、UnityConnector DLしてきて、プロジェクトにUnityApp組み込んで、シミュレータで動かす直前まで</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://youtu.be/pmQjZwvxl-o">http://youtu.be/pmQjZwvxl-o</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>2.それをSimulatorでビルドするまで</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://youtu.be/HDlol7y6npY">http://youtu.be/HDlol7y6npY</a></p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>見た目</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span></b>まず通常のiOSアプリが起動、この時の起動スプラッシュはUnityのものなことに注目</p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.21.png" alt="スクリーンショット 2012-12-23 0.06.21.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>すぐにボタンが一つセットされた画面が表示。</b></p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.18.png" alt="スクリーンショット 2012-12-23 0.06.18.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>ボタンを押すと、Unityが起動(2度目のスプラッシュ)</b></p>
<p class="p4"><img src="1__%23$!@%25!%23__%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.21.png" alt="1__#$!@%!#__スクリーンショット 2012-12-23 0.06.21.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>一定時間後に</b></p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.23.png" alt="スクリーンショット 2012-12-23 0.06.23.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>Unityの上に、NativeコードからUIViewを追加</b></p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.31.png" alt="スクリーンショット 2012-12-23 0.06.31.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>View上のボタンを押すと、ダイアログ表示</b></p>
<p class="p4"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202012-12-23%200.06.34.png" alt="スクリーンショット 2012-12-23 0.06.34.png"></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>このへんのコードは、下記にupしてあります。</b></p>
<p class="p2"><b></b><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>コード</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>githubにupしてあります。 Unityのアプリ部分は含んでいないので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>自分でUnity用のプロジェクトを生成して、iOSUnityApp　フォルダに放り込んでね！</p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/UnityConnector">https://github.com/sassembla/UnityConnector</a></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>解説</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>アプリケーション内で、どんなことをしているのか</p>
<p class="p3"><span class="Apple-tab-span">	</span>ステップに分けて紹介。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.タイトルを表示</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>2.ボタンが押されたらUnityを起動</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>3.Unityが起動したらUnity上にUIを置く</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>4.Unity上UIのボタンを押したらアラート</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>1.タイトルを表示</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>アプリケーション起動時、ボタンのあるUIを表示</p>
<p class="p3"><span class="Apple-tab-span">	</span>ここはまあ、ただ単に表示してるだけ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AppDelegate.h</p>
<p class="p5">SampleTitleViewController<span class="s1"> * sampleVCont;</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AppDelegate.m</p>
<p class="p6"><span class="s2">sampleVCont</span><span class="s1"> = [[</span><span class="s2">SampleTitleViewController</span><span class="s1"> </span><span class="s3">alloc</span><span class="s1">]</span>initSampleTitleViewControllerWithMasterName<span class="s1">:</span><span class="s4">CONNECTOR_MASTER</span><span class="s1">];</span></p>
<p class="p5"><span class="s1">[</span><span class="s5">self</span><span class="s1">.</span>window<span class="s1"> </span><span class="s3">addSubview</span><span class="s1">:</span>sampleVCont<span class="s1">.</span><span class="s6">view</span><span class="s1">];</span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ボタンが押されたときのコードは、ただ単にDelegateにそのイベントをぶん投げるもの。</p>
<p class="p3"><span class="Apple-tab-span">	</span>NSNotificationをラップした自作のメッセージングライブラリを使っている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>さらに、AppDelegate.mでは、</p>
<p class="p7"><span class="Apple-converted-space">    </span><span class="s2">m_application</span> = application;</p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span></span>m_launchOptions<span class="s1"> = [[</span><span class="s6">NSDictionary</span><span class="s1"> </span><span class="s3">alloc</span><span class="s1">]</span><span class="s3">init</span><span class="s1">];</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>みたいな感じで、UIApplicationのインスタンスと</p>
<p class="p3"><span class="Apple-tab-span">	</span>起動時オプションの辞書(こちらは適当に空)</p>
<p class="p3"><span class="Apple-tab-span">	</span>の２つを保持している。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>UIApplicationのインスタンスも、起動時オプションも、別に必ずここでとらないといけない訳じゃない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>説明しやすい感じに、起動時に保持するようにしてみただけ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>値は、今後のUnityAppの起動やコントロールに使用する。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>2.ボタンが押されたらUnityを起動</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>自作ライブラリで、ボタンが押された際のイベントが、下記receiverメソッドに飛んでくる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ボタンが押されると、</p>
<p class="p8"><span class="s7"><span class="Apple-tab-span">	</span></span>SAMPLE_TITLEVIEWCONT_EXEC_UNITY_ON_TAPPED</p>
<p class="p3"><span class="Apple-tab-span">	</span>という名前のイベントがかっ飛んでくる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>コードに①、②とかの番号振っておいたので、それ見つつ解説する。</p>
<p class="p9"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AppDelegate.m</p>
<p class="p7">- (<span class="s5">void</span>)receiver:(<span class="s6">NSNotification</span> * )notif {</p>
<p class="p7"><span class="Apple-converted-space">    </span><span class="s6">NSString</span> * exec = [<span class="s2">messenger</span> <span class="s8">getExecFromNotification</span>:notif];</p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s6">NSDictionary</span><span class="s1"> * dict = [</span><span class="s2">messenger</span><span class="s1"> </span>getTagValueDictionaryFromNotification<span class="s1">:notif];</span></p>
<p class="p10"><span class="Apple-converted-space">    </span></p>
<p class="p11"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s5">if</span><span class="s1"> ([exec </span><span class="s3">isEqualToString</span><span class="s1">:</span>SAMPLE_TITLEVIEWCONT_EXEC_UNITY_ON_TAPPED<span class="s1">]) {</span></p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p12"><span class="Apple-tab-span">	</span><span class="s9">①</span><span class="Apple-tab-span">	</span><span class="s10">/*</span></p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> ignite Unity</p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> */</p>
<p class="p14"><span class="s1"><span class="Apple-converted-space">        </span>[</span><span class="s2">messenger</span><span class="s1"> </span><span class="s8">call</span><span class="s1">:</span>KS_UNITYBOOTER<span class="s1"> </span><span class="s8">withExec</span><span class="s1">:</span>KS_UNITYBOOTER_EXEC_INITIALIZE<span class="s1">,</span></p>
<p class="p15"><span class="s1"><span class="Apple-converted-space">         </span>[</span>messenger<span class="s1"> </span><span class="s8">tag</span><span class="s1">:</span><span class="s11">@"application"</span><span class="s1"> </span><span class="s8">val</span><span class="s1">:</span>m_application<span class="s1">],</span></p>
<p class="p15"><span class="s1"><span class="Apple-converted-space">         </span>[</span>messenger<span class="s1"> </span><span class="s8">tag</span><span class="s1">:</span><span class="s11">@"launchOptions"</span><span class="s1"> </span><span class="s8">val</span><span class="s1">:</span>m_launchOptions<span class="s1">],</span></p>
<p class="p12"><span class="Apple-converted-space">         </span><span class="s5">nil</span>];</p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p10"><span class="Apple-tab-span">	</span></p>
<p class="p12"><span class="Apple-tab-span">	</span><span class="s9">②</span><span class="Apple-tab-span">	</span><span class="s10">/*</span></p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> generate pinView(back button inside.)</p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> */</p>
<p class="p15"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>SamplePinViewControler<span class="s1"> * samplePinViewCont = [[</span>SamplePinViewControler<span class="s1"> </span><span class="s3">alloc</span><span class="s1">]</span><span class="s3">init</span><span class="s1">];</span></p>
<p class="p16"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p13"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>/*</p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> set pinView to Unity-window after some seconds.(this is for experimental.)</p>
<p class="p13"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> */</p>
<p class="p14"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>[</span><span class="s2">messenger</span><span class="s1"> </span><span class="s8">callMyself</span><span class="s1">:</span>CONNECTOR_MASTER_EXEC_SET_VIEW_TO_UNITYWINDOW<span class="s1">,</span></p>
<p class="p12"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> [<span class="s2">messenger</span> <span class="s8">tag</span>:<span class="s11">@"view"</span> <span class="s8">val</span>:samplePinViewCont.<span class="s6">view</span>],</p>
<p class="p15"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> [</span>messenger<span class="s1"> </span><span class="s8">withDelay</span><span class="s1">:</span><span class="s12">5.0</span><span class="s1">],</span></p>
<p class="p12"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span> <span class="s5">nil</span>];</p>
<p class="p7"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>①Unity起動</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Unityの起動クラスをラップしているKSUnityBooterのインスタンス（こちらも自作のライブラリ使用）に、</p>
<p class="p3"><span class="Apple-tab-span">	</span>メッセージを送る。</p>
<p class="p2"><br></p>
<p class="p17"><span class="s7"><span class="Apple-tab-span">	</span>値として</span>m_application<span class="s7">と</span>m_launchOptions<span class="s7">を送付。</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>通信する先は、KSUnityBooter.mm。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ライブラリによって、receiverメソッドへと、イベントが届く。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>KSUnityBooter.mmは、UnityAppそれ自体のmain.mmの内容を模している。</p>
<p class="p3"><span class="Apple-tab-span">	</span>必要なimportがあり、intがある。</p>
<p class="p3"><span class="Apple-tab-span">	</span>AppControllerクラスのインスタンスとして、 unityAppという名前のインスタンスを保持するようにしている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>KSUnityBooter.mm</p>
<p class="p18"><span class="s4">#import </span>"AppController.h"</p>
<p class="p18"><span class="s4">#import </span>"RegisterClasses.h"</p>
<p class="p18"><span class="s4">#import </span>"RegisterMonoModules.h"</p>
<p class="p10"><br></p>
<p class="p10"><br></p>
<p class="p7"><span class="s5">static</span> <span class="s5">const</span> <span class="s5">int</span> constsection = <span class="s12">0</span>;</p>
<p class="p7"><span class="s5">bool</span> UnityParseCommandLine(<span class="s5">int</span> argc, <span class="s5">char</span> *argv[]);</p>
<p class="p2"><br></p>
<p class="p5">AppController<span class="s1"> * unityApp;</span></p>
<p class="p2"><br></p>
<p class="p7">- (<span class="s5">void</span>) receiver:(<span class="s6">NSNotification</span> * )notif {</p>
<p class="p7"><span class="Apple-converted-space">    </span><span class="s6">NSString</span> * exec = [<span class="s2">messenger</span> <span class="s8">getExecFromNotification</span>:notif];</p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s6">NSDictionary</span><span class="s1"> * dict = [</span><span class="s2">messenger</span><span class="s1"> </span>getTagValueDictionaryFromNotification<span class="s1">:notif];</span></p>
<p class="p10"><span class="Apple-converted-space">    </span></p>
<p class="p10"><span class="Apple-converted-space">    </span></p>
<p class="p19"><span class="s1"><span class="Apple-converted-space">    </span></span>//unity-app wrapper with UIApplicationDelegate</p>
<p class="p7"><span class="Apple-converted-space">    </span><span class="s10">/*</span></p>
<p class="p19"><span class="Apple-converted-space">     </span>o <span class="Apple-converted-space">    </span>- (void)applicationDidFinishLaunching:(UIApplication *)application;</p>
<p class="p19">(<span class="s9">中略</span>)</p>
<p class="p19"><span class="Apple-converted-space">     </span>o <span class="Apple-converted-space">    </span>- (NSUInteger)application:(UIApplication *)application supportedInterfaceOrientationsForWindow:(UIWindow *)window<span class="Apple-converted-space">  </span>NS_AVAILABLE_IOS(6_0);</p>
<p class="p19"><span class="Apple-converted-space">     </span>*/</p>
<p class="p10"><span class="Apple-converted-space">    </span></p>
<p class="p11"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s5">if</span><span class="s1"> ([exec </span><span class="s3">isEqualToString</span><span class="s1">:</span>KS_UNITYBOOTER_EXEC_INITIALIZE<span class="s1">]) {</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">NSAssert</span><span class="s1">([dict </span><span class="s3">valueForKey</span><span class="s1">:</span>@"application"<span class="s1">],</span>@"application required"<span class="s1">);</span></p>
<p class="p18"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">NSAssert</span><span class="s1">([dict </span><span class="s3">valueForKey</span><span class="s1">:</span>@"launchOptions"<span class="s1">], </span>@"launchOptions required"<span class="s1">);</span></p>
<p class="p10"><span class="Apple-converted-space">        </span></p>
<p class="p7"><span class="Apple-converted-space">        </span><span class="s6">UIApplication</span> * application = [dict <span class="s3">valueForKey</span>:<span class="s11">@"application"</span>];</p>
<p class="p7"><span class="Apple-converted-space">        </span><span class="s6">NSDictionary</span> * launchOptions = [dict <span class="s3">valueForKey</span>:<span class="s11">@"launchOptions"</span>];</p>
<p class="p10"><span class="Apple-converted-space">        </span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span>RegisterMonoModules<span class="s1">();</span></p>
<p class="p10"><span class="Apple-converted-space">        </span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">        </span></span>unityApp<span class="s1"> = [[</span>AppController<span class="s1"> </span><span class="s3">alloc</span><span class="s1">]</span><span class="s3">init</span><span class="s1">];</span></p>
<p class="p20"><span class="s1"><span class="Apple-converted-space">        </span>[</span><span class="s2">unityApp</span><span class="s1"> </span>application<span class="s1">:application </span>didFinishLaunchingWithOptions<span class="s1">:launchOptions];</span></p>
<p class="p7"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここで、UnityAppの中に入ってる、<span class="s13">AppController</span>クラスのインスタンス<span class="s13">unityApp</span>を初期化。</p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityAppそれ自体が起動したのと同じ挙動にするために、</p>
<p class="p3"><span class="Apple-tab-span">	</span>AppDelegateから送付してきた<span class="s13">m_application</span>と<span class="s13">m_launchOptions</span>をパラメータに使う。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これで、Unityの起動が開始。</p>
<p class="p3"><span class="Apple-tab-span">	</span>アプリの画面にUnityのスプラッシュが表示されるようになる。</p>
<p class="p2"><br></p>
<p class="p21"><b><span class="Apple-tab-span">	</span>ちなみに、非プロ版時のみ表示されるスプラッシュだけど、用意されたファイルを使わないようにすると</b></p>
<p class="p21"><b><span class="Apple-tab-span">	</span>きちんとエラーで落ちる。</b></p>
<p class="p21"><b><span class="Apple-tab-span">	</span>悪いことをしてはいけない。</b></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、UinityApp自体は点火できたので、次はUnity上にiOSのUIを置く。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>②Unity上にUIを置く</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここでは、</p>
<p class="p3"><span class="Apple-tab-span">	</span>アラートをセットしてあるボタンが置いてあるUIViewの<span class="s13">SamplePinViewControler</span>をインスタンス化。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>そのviewを、5.0秒後にそのインスタンスを自分自身(<span class="s14">AppDelegate.m</span><span class="s9">のインスタンス</span>)へと送る。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>3.Unityが起動したらUnity上にUIを置く</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityAppの起動完了 = Unityのスプラッシュが消える、なのだけれど、UnityAppに手を加えないと</p>
<p class="p3"><span class="Apple-tab-span">	</span>それが察知できない。</p>
<p class="p3"><span class="Apple-tab-span">	</span>(書いてて気づいたけどもしかしたらNSNotificationでAccelの開始とかをハンドルすればわかるかもしれない。)</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なので、だいたいで5秒たったら、起動してるものとする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>そのタイミングで、下記コードが呼ばれる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>AppDelegate.m</p>
<p class="p7">- (<span class="s5">void</span>)receiver:(<span class="s6">NSNotification</span> * )notif {</p>
<p class="p10"><br></p>
<p class="p7">(<span class="s9">中略</span>)</p>
<p class="p10"><span class="Apple-tab-span">	</span></p>
<p class="p11"><span class="s1"><span class="Apple-tab-span">	</span></span><span class="s5">if</span><span class="s1"> ([exec </span><span class="s3">isEqualToString</span><span class="s1">:</span>CONNECTOR_MASTER_EXEC_SET_VIEW_TO_UNITYWINDOW<span class="s1">]) {</span></p>
<p class="p18"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s3">NSLog</span><span class="s1">(</span>@"m_application %@"<span class="s1">,<span class="Apple-tab-span">	</span>[</span><span class="s2">m_application</span><span class="s1"> </span><span class="s3">windows</span><span class="s1">]);</span></p>
<p class="p18"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s4">NSAssert</span><span class="s1">([dict </span><span class="s3">valueForKey</span><span class="s1">:</span>@"view"<span class="s1">], </span>@"view required"<span class="s1">);</span></p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p19"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>//get the view what want to append to Unity.</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s6">UIView</span> * testView = [dict <span class="s3">valueForKey</span>:<span class="s11">@"view"</span>];</p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p19"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>//get window array of this app</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s6">NSArray</span> * windowArray = [<span class="s2">m_application</span> <span class="s3">windows</span>];</p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p19">//<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>for (UIWindow * window in [m_application windows]) {</p>
<p class="p19">//<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>NSLog(@"[window subviews]<span class="Apple-tab-span">	</span>%@", [window subviews]);</p>
<p class="p19">//<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>}</p>
<p class="p10"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p19"><span class="s1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span>//append view onto Unity-window</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s5">if</span> (<span class="s12">1</span> &lt; [windowArray <span class="s3">count</span>]) {</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>[[windowArray <span class="s3">objectAtIndex</span>:<span class="s12">1</span>] <span class="s3">addSubview</span>:testView];</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>}</p>
<p class="p7"><span class="Apple-tab-span">	</span>}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>UnityのViewが作られたあと、Unityが稼働しているAppには、UIWindowが2つある。</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>旧来の、App起動時からあるUIWindowは実際の画面から引きはがされている(でもnilとかではない、、)</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>ここでは、<span class="s15">2</span>つめのUIWindowを適当に検出して、そこに先ほどの<span class="s15">view</span>をaddSubviewしている。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>このUnity用のWIndowは、Unityのインスタンス生成直後から存在はしてるんだけど、</p>
<p class="p3"><span class="Apple-tab-span">	</span>いきなりaddSubviewすると、Unityの起動完了時にremoveされる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>4.Unity上UIのボタンを押したらアラート</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>UnityのUIWindow上に乗っけている<span class="s13">SamplePinViewControler</span>は、こんな感じ。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>SamplePinViewControler.m</p>
<p class="p7">- (<span class="s5">IBAction</span>)tapped:(<span class="s5">id</span>)sender {</p>
<p class="p20"><span class="s1"><span class="Apple-tab-span">	</span></span><span class="s6">UIAlertView</span><span class="s1"> * alertView = [[</span><span class="s6">UIAlertView</span><span class="s1"> </span>alloc<span class="s1">]</span>initWithTitle<span class="s1">:</span><span class="s11">@"active"</span><span class="s1"> </span>message<span class="s1">:</span><span class="s11">@"can react UI-something"</span><span class="s1"> </span>delegate<span class="s1">:</span><span class="s5">self</span><span class="s1"> </span>cancelButtonTitle<span class="s1">:</span><span class="s11">@"DONE"</span><span class="s1"> </span>otherButtonTitles<span class="s1">:</span><span class="s5">nil</span><span class="s1">];</span></p>
<p class="p7"><span class="Apple-tab-span">	</span>[alertView <span class="s3">show</span>];</p>
<p class="p7">}</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>xibで単純に組んでいて、ボタンが押されたら(touchUpInside) アラートを表示するだけ。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">以上！</p>
</body>
</html>
