<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #43c0a0; -webkit-text-stroke: #43c0a0; background-color: #000000}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; background-color: #000000}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #c27e65; -webkit-text-stroke: #c27e65; background-color: #000000}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #cacaca; -webkit-text-stroke: #cacaca; background-color: #000000; min-height: 14.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #598a43; -webkit-text-stroke: #598a43; background-color: #000000}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #d4d69a; -webkit-text-stroke: #d4d69a; background-color: #000000}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.0px Menlo; color: #8cd3fe; -webkit-text-stroke: #8cd3fe; background-color: #000000}
    p.p13 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca; min-height: 18.0px}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; -webkit-text-stroke: #cacaca}
    span.s1 {font: 22.0px Helvetica}
    span.s2 {font: 12.0px Helvetica}
    span.s3 {font-kerning: none; color: #cacaca; -webkit-text-stroke: 0px #cacaca}
    span.s4 {font-kerning: none}
    span.s5 {font-kerning: none; color: #d4d69a; -webkit-text-stroke: 0px #d4d69a}
    span.s6 {font-kerning: none; color: #4689cc; -webkit-text-stroke: 0px #4689cc}
    span.s7 {font-kerning: none; color: #8cd3fe; -webkit-text-stroke: 0px #8cd3fe}
    span.s8 {font-kerning: none; color: #b76fb3; -webkit-text-stroke: 0px #b76fb3}
    span.s9 {font-kerning: none; color: #c27e65; -webkit-text-stroke: 0px #c27e65}
    span.s10 {font-kerning: none; color: #43c0a0; -webkit-text-stroke: 0px #43c0a0}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><span class="s1"><b>Autoya</b></span><b>内から</b><span class="s1"><b>AssetBundle</b></span><b>がらみの部分だけを抜き出したモジュールの紹介</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>これ。</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/Autoya/blob/master/Autoya.AssetBundles.unitypackage">https://github.com/sassembla/Autoya/blob/master/Autoya.AssetBundles.unitypackage</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span>Autoya</span>はログインから課金まですべからく俺が欲しい機能がいっぱい入っていて、まあ、薄いけどでかい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>そんなにたくさんの機能いらないよ！というのは正直わかる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>なので、まあ、<span class="s2">Autoya</span>は実は複数の機能単位でのモジュールと、それを中央制御するレイヤー(Backyard)でできている。</p>
<p class="p3"><span class="Apple-tab-span">	</span>今回はそれらのモジュールのうち、AssetBundleに関わるものを抜粋したよ、という話。</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p3"><b>Autoya AssetBundle Module</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ABを生成する部分は含んでいないが、</p>
<p class="p3"><span class="Apple-tab-span">	</span>ABの情報一覧を取得する機構、</p>
<p class="p3"><span class="Apple-tab-span">	</span>AB情報を使って取り出したいAssetを依存関係とか全部みてなんとかする機構、</p>
<p class="p3"><span class="Apple-tab-span">	</span>ABの一覧を更新する機構、</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>などが入っている。</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p3"><b>使い方</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>1.この世のどこかでABとABListを作ります</p>
<p class="p3"><span class="Apple-tab-span">	</span>2.App内でABListを取得します</p>
<p class="p3"><span class="Apple-tab-span">	</span>3.App内でABに含まれているAssetをロードします</p>
<p class="p5"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>以上！ Unloadとかもあるよ。</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p3"><b>サンプル</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/Autoya/blob/master/Assets/Packager/AssetBundles/AssetBundlesLoadSample.cs">https://github.com/sassembla/Autoya/blob/master/Assets/Packager/AssetBundles/AssetBundlesLoadSample.cs</a></p>
<p class="p5"><br></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">    </span></span><span class="s4">IEnumerator</span><span class="s3"> </span><span class="s5">Start</span><span class="s3">()</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">LIST_DOWNLOAD_URL</span><span class="s3"> = </span><span class="s4">"https://raw.githubusercontent.com/sassembla/Autoya/master/AssetBundles/main_assets/OSX/1.0.0/main_assets.json"</span><span class="s3">;</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">ASSET_NAME</span><span class="s3"> = </span><span class="s4">"Assets/AutoyaTests/RuntimeData/AssetBundles/MainResources/textureName.png"</span><span class="s3">;</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s4">// Download AssetBundle List from web.</span></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">listDownloader</span><span class="s3"> = </span><span class="s6">new</span><span class="s3"> </span><span class="s4">AssetBundleListDownloader</span><span class="s3">();</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s4">AssetBundleList</span><span class="s3"> </span><span class="s7">list</span><span class="s3"> = </span><span class="s6">null</span><span class="s3">;</span></p>
<p class="p11"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">cor</span><span class="s3"> = </span><span class="s7">listDownloader</span><span class="s3">.</span><span class="s4">DownloadAssetBundleList</span><span class="s3">(</span></p>
<p class="p12"><span class="s3"><span class="Apple-converted-space">            </span></span><span class="s4">LIST_DOWNLOAD_URL</span><span class="s3">,</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>(</span><span class="s7">url</span><span class="s4">, </span><span class="s7">newList</span><span class="s4">) =&gt;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                </span></span><span class="s7">list</span><span class="s4"> = </span><span class="s7">newList</span><span class="s4">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>},</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>(</span><span class="s7">code</span><span class="s4">, </span><span class="s7">reason</span><span class="s4">, </span><span class="s7">status</span><span class="s4">) =&gt;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s7">Debug</span><span class="s3">.</span><span class="s5">LogError</span><span class="s3">(</span><span class="s4">"list download error, code:"</span><span class="s3"> + </span><span class="s7">code</span><span class="s3"> + </span><span class="s4">" reason:"</span><span class="s3"> + </span><span class="s7">reason</span><span class="s3">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s8">while</span><span class="s4"> (</span><span class="s7">cor</span><span class="s4">.</span><span class="s5">MoveNext</span><span class="s4">())</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s8">yield</span><span class="s4"> </span><span class="s8">return</span><span class="s4"> </span><span class="s6">null</span><span class="s4">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s4">// Load Asset from your AssetBundle.</span></p>
<p class="p6"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">loader</span><span class="s3"> = </span><span class="s6">new</span><span class="s3"> </span><span class="s4">AssetBundleLoader</span><span class="s3">(</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s7">bundleName</span><span class="s4"> =&gt;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s6">var</span><span class="s3"> </span><span class="s7">path</span><span class="s3"> = </span><span class="s4">"https://raw.githubusercontent.com/sassembla/Autoya/master/AssetBundles/"</span><span class="s3"> +</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                    </span></span><span class="s7">list</span><span class="s4">.</span><span class="s7">identity</span><span class="s4"> + </span><span class="s9">"/"</span><span class="s4"> +</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                    </span></span><span class="s7">list</span><span class="s4">.</span><span class="s7">target</span><span class="s4"> + </span><span class="s9">"/"</span><span class="s4"> +</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                    </span></span><span class="s7">list</span><span class="s4">.</span><span class="s7">version</span><span class="s4"> + </span><span class="s9">"/"</span><span class="s4">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                </span></span><span class="s8">return</span><span class="s4"> </span><span class="s7">path</span><span class="s4">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p10"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s4">// set list to AssetBundleLoader.</span></p>
<p class="p11"><span class="s3"><span class="Apple-converted-space">        </span></span><span class="s7">loader</span><span class="s3">.</span><span class="s4">UpdateAssetBundleList</span><span class="s3">(</span><span class="s7">list</span><span class="s3">);</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s6">var</span><span class="s4"> </span><span class="s7">loadCor</span><span class="s4"> = </span><span class="s7">loader</span><span class="s4">.</span><span class="s5">LoadAsset</span><span class="s4">&lt;</span><span class="s10">Texture2D</span><span class="s4">&gt;(</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s7">ASSET_NAME</span><span class="s4">,</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>(</span><span class="s7">name</span><span class="s4">, </span><span class="s7">tex</span><span class="s4">) =&gt;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">                </span></span><span class="s7">Debug</span><span class="s4">.</span><span class="s5">Log</span><span class="s4">(</span><span class="s9">"asset loaded! tex:"</span><span class="s4"> + </span><span class="s7">tex</span><span class="s4">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>},</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>(</span><span class="s7">name</span><span class="s4">, </span><span class="s7">error</span><span class="s4">, </span><span class="s7">reason</span><span class="s4">, </span><span class="s7">status</span><span class="s4">) =&gt;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>{</span></p>
<p class="p8"><span class="s3"><span class="Apple-converted-space">                </span></span><span class="s7">Debug</span><span class="s3">.</span><span class="s5">LogError</span><span class="s3">(</span><span class="s4">"asset load failed. error:"</span><span class="s3"> + </span><span class="s7">error</span><span class="s3"> + </span><span class="s4">" reason:"</span><span class="s3"> + </span><span class="s7">reason</span><span class="s3">);</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>);</span></p>
<p class="p9"><span class="s4"></span><br></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s8">while</span><span class="s4"> (</span><span class="s7">loadCor</span><span class="s4">.</span><span class="s5">MoveNext</span><span class="s4">())</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>{</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s8">yield</span><span class="s4"> </span><span class="s8">return</span><span class="s4"> </span><span class="s6">null</span><span class="s4">;</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s4"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span>MonoBehaviourのStartメソッドを使って、</p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ABListダウンローダーの初期化 -&gt;<span class="Apple-converted-space"> </span></p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ABListのダウンロード -&gt;<span class="Apple-converted-space"> </span></p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ABローダーの初期化 -&gt;<span class="Apple-converted-space"> </span></p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ローダーへのABListのセット -&gt;<span class="Apple-converted-space"> </span></p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ローダーで欲しいAsset名、型を指定して、データをロード</p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span>と、こういう感じでできる。</p>
<p class="p13"><br></p>
<p class="p13"><br></p>
<p class="p14"><b>ABListの作り方</b></p>
<p class="p14"><span class="Apple-tab-span">	</span>これはまだちょっとまどろっこしい。</p>
<p class="p14"><span class="Apple-tab-span">	</span>Autoya+AssetGraphパッケージには、ABListのジェネレータも入っているが、その部分はAssetBundle.unitypackageには入っていない。</p>
<p class="p13"><span class="Apple-tab-span">	</span></p>
<p class="p14"><span class="Apple-tab-span">	</span>なので、次のフォルダをゴソッとgithubからダウンロードして、ABを作成したいプロジェクトに含む必要がある。</p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/Autoya/tree/master/Assets/Editor">https://github.com/sassembla/Autoya/tree/master/Assets/Editor</a><span class="Apple-tab-span">	</span></p>
<p class="p14"><span class="Apple-tab-span">	</span>中にはAssetGraphとAssetBundleListGeneratorのコードが入っている。</p>
<p class="p14"><span class="Apple-tab-span">	</span>この状態でAssetGraphを起動し、適当にABを作るグラフを組み立ててビルドを行うと、プロジェクトフォルダにAssetBundlesフォルダが勝手に作られ、ABが生成され、</p>
<p class="p14"><span class="Apple-tab-span">	</span>自動的にABListが生成される。</p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span>一度AssetGraphでビルドしたら、ABListにはバージョンという値が振られる。</p>
<p class="p14"><span class="Apple-tab-span">	</span>バージョン値は、Unity上で Window &gt; Autoya &gt; AssetBundle List Version Editor というので変えられる。</p>
<p class="p13"><br></p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span><span class="s2"><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202019-04-13%2021.16.09.png" alt="スクリーンショット 2019-04-13 21.16.09.png"></span></p>
<p class="p14"><span class="Apple-tab-span">	</span>変えた後でAssetGraphのグラフをビルドすると、そのverのABとかABListが出力される。</p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span>生成されたABが入っているフォルダを、どこか、、github上とかにでも置くと、物事が解決できるぞ。</p>
<p class="p13"><br></p>
<p class="p14"><span class="Apple-tab-span">	</span>やばくなったらCDNとかでググって。</p>
</body>
</html>
