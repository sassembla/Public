<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1187.34">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    span.s1 {font: 22.0px 'Hiragino Kaku Gothic ProN'}
    span.s2 {font: 12.0px Helvetica}
    span.s3 {font: 12.0px 'Hiragino Kaku Gothic ProN'}
    span.s4 {font: 12.0px 'Lucida Grande'}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Mac</b><span class="s1"><b>で</b></span><b>JDK6</b><span class="s1"><b>以降の</b></span><b>stdout</b><span class="s1"><b>が</b></span><b>SJIS</b><span class="s1"><b>になる現象の根源</b></span></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>Tさんに粘着して教えていただいたので、纏めておく。</p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>Tさんすいませんでした。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>参考</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://happygiraffe.net/blog/2009/09/24/java-platform-encoding/">http://happygiraffe.net/blog/2009/09/24/java-platform-encoding/</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>参考の意訳</b></p>
<p class="p3">不運にも、コマンドラインで<span class="s2">Java</span>を実行する際、<span class="s2">UTF-8</span>文字列<span class="s2">(U+00A9 COPYRIGHT SIGN[?])</span>を渡したものを<span class="s2">print</span>したら、二重にエンコードされてしまった。</p>
<p class="p2"><br></p>
<p class="p4"><span class="s3">とりあえず</span>-Dfile.encoding=UTF-8<span class="s3">で対処していたんだけど、</span></p>
<p class="p3">自動リスタートとかしてたら、反映されない。これは不味い。</p>
<p class="p3">で、私たちは問題をさらに調査した。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2">-D</span>つけてれば適応されるんだし、きっと<span class="s2">LANG</span>環境変数が欠如している事と関係があるだろうな、とあたりをつけた。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">試しに、システムプロパティ一覧を表示するアプリケーションを作って、結果を<span class="s2">grep</span>してみた。</p>
<p class="p3">おなじみの<span class="s2">file.encoding</span>がある。さらに内部に、<span class="s2">sun.jnu.encoding</span>っていうのが有るのを見つけた。</p>
<p class="p2"><br></p>
<p class="p3">で、<span class="s2">-Dfile.encoding</span>をつけての挙動を試してみた。</p>
<p class="p4">sun.jnu.encoding <span class="s3">が変わってない！</span></p>
<p class="p2"><br></p>
<p class="p3">このプロパティに関するドキュメントは、探してみたけど知る限りどこにも無いみたいだ。</p>
<p class="p3">実際の挙動を知る為に、<span class="s2">JDK6</span>のソースコードを読むしか無い。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2">main</span>関数は<span class="s2">java.c</span>にあった。実際に使われている<span class="s2">JavaMain()</span>関数の中身をみると、</p>
<p class="p3"><span class="s2">NewPlatformStringArray()</span>関数が定義されていて、コマンドラインからの入力行ごとに実行されている。</p>
<p class="p4"><span class="s3">その中では、</span> new String(byte[], encoding)<span class="s3">が呼ばれている。</span></p>
<p class="p4"><span class="s3">さらにその中で呼ばれている</span> getPlatformEncoding() <span class="s3">関数で、</span></p>
<p class="p2"><br></p>
<p class="p4">System.getProperty("sun.jnu.encoding")</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">が呼ばれている。</p>
<p class="p3">このプロパティはどこでセットされているんだ？</p>
<p class="p4">System.c<span class="s3">だ。</span></p>
<p class="p2"><br></p>
<p class="p4"><span class="s3">その中の</span> Java_java_lang_System_initProperties() <span class="s3">関数の中で、</span></p>
<p class="p4">PUTPROP(props, "sun.jnu.encoding", sprops-&gt;sun_jnu_encoding);</p>
<p class="p3">という行があり、</p>
<p class="p2"><br></p>
<p class="p4">sprops-&gt; sun_jnu_encoding<span class="s3">は、</span><span class="Apple-converted-space">  </span>java_props_md.c <span class="s3">ファイル中の、</span></p>
<p class="p4">GetJavaProperties() <span class="s3">関数でセットされている。</span></p>
<p class="p2"><br></p>
<p class="p3">こいつは、いろいろな環境変数を含んでいる。ロケールをコントロールするものも含めて。</p>
<p class="p2"><br></p>
<p class="p3">「入力されるいろんなもの」から、<span class="s2">sun_jnu_encoding</span>を取得する為に設定されているみたいだ。</p>
<p class="p2"><br></p>
<p class="p3">ちぇっ。</p>
<p class="p3">判った事として、次のパラメータが、<span class="s2"> sun_jnu_encoding </span>の定義に使われる。</p>
<p class="p2"><br></p>
<p class="p4">Command line <span class="s3">引数</span></p>
<p class="p3">メインクラス名</p>
<p class="p3">環境変数</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">で、このパラメータは<span class="s2">override</span>できる。</p>
<p class="p4">$ LANG= java -Dsun.jnu.encoding=UTF-8 -Dfile.encoding=UTF-8</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>訳終わり</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>という訳で</b></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>初期エンコーディングの可能性は、この<span class="s2"> java_props_md.c </span>らへんを見れば判る、と。</p>
<p class="p4"><span class="Apple-tab-span">	</span><a href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/file/536cbf2d9d0e/src/solaris/native/java/lang/java_props_md.c">http://hg.openjdk.java.net/jdk6/jdk6/jdk/file/536cbf2d9d0e/src/solaris/native/java/lang/java_props_md.c</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>GetJavaProperties <span class="s3">メソッドの所には、</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>"Determine the language, country, variant, and encoding from the host"</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>って書いてある。これが元か。<span class="s2">JDK5</span>との比較しなきゃだけど、なぜこんな仕様になったんだろう。</p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>インストーラの仕事サボった？</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>上からファイル追っていくと、<span class="s2">sun.jnu.encoding</span>の候補は、環境とか<span class="s2">locale</span>とかによってころころと変わっていく。</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s3">最終的に</span> sun.jnu.encoding <span class="s3">は</span> std_encoding <span class="s3">の値を代入されるのだけれど、</span></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>std_encoding <span class="s3">の値が下記のように変わる。</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4">ISO8859-15<span class="Apple-tab-span">	</span><span class="s4">←</span><span class="s3">これは</span>US-ASCII</p>
<p class="p2"><br></p>
<p class="p4">nl_langinfo(CODESET)<span class="Apple-tab-span">	</span><span class="s4">←</span><span class="s3">こいつは</span> langinfo.h <span class="s3">/</span> langinfo.c <span class="s3">で定義されてる。</span> CODESET<span class="s3">は環境によって異なる。</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>#ifdef __linux__</p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>#define CODESET _NL_CTYPE_CODESET_NAME</p>
<p class="p4"><span class="Apple-tab-span">	</span>#else</p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>#ifdef ALT_CODESET_KEY</p>
<p class="p4"><span class="Apple-tab-span">	</span>#define CODESET ALT_CODESET_KEY</p>
<p class="p4"><span class="Apple-tab-span">	</span>#endif</p>
<p class="p2"><br></p>
<p class="p4"><span class="Apple-tab-span">	</span>#endif</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4">ISO646-US<span class="Apple-tab-span">	</span><span class="s4">←</span><span class="s3">下記</span>URL<span class="s3">に色々載ってる。</span></p>
<p class="p4"><span class="Apple-tab-span">	</span><a href="http://www.asahi-net.or.jp/~yw3t-trns/code/iso646.html">http://www.asahi-net.or.jp/~yw3t-trns/code/iso646.html</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4">ISO8859-1<span class="Apple-tab-span">	</span><span class="s4">←</span>Latin-1</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>さらに各環境の場合、下記がセットされる。</p>
<p class="p2"><br></p>
<p class="p4">//en_UK <span class="s3">だったら</span></p>
<p class="p4">ISO8859-1</p>
<p class="p2"><br></p>
<p class="p4">//linux<span class="s3">だったら系</span></p>
<p class="p4">EUC-JP-LINUX<span class="Apple-converted-space"> </span></p>
<p class="p4">eucJP-open</p>
<p class="p4">Big5_Solaris</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>で！</p>
<p class="p3"><span class="Apple-tab-span">	</span>langinfo.c を探してみると、</p>
<p class="p3"><span class="Apple-tab-span">	</span>すいませんよくわかりません。どこに有るんや。</p>
<p class="p2"><br></p>
<p class="p3"><span class="s2"><span class="Apple-tab-span">	</span></span>下記適当に見つけてきた <span class="s2">langinfo.c </span>だと、<span class="s2">locale</span>が<span class="s2">jp</span>だったら<span class="s2">SJIS</span>返してる。</p>
<p class="p4"><span class="Apple-tab-span">	</span><a href="http://www.cl.cam.ac.uk/~mgk25/ucs/langinfo.c">http://www.cl.cam.ac.uk/~mgk25/ucs/langinfo.c</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3">続く。</p>
<p class="p2"><br></p>
</body>
</html>
