<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.47">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb; min-height: 18.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Kaku Gothic ProN'; background-color: #ebebeb}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>locust使ってみる</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="http://locust.io">http://locust.io</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>install</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>pipでも入れられるんだけど、大変な量のエラーが出るので諦めてeasy_install。</p>
<p class="p2"><br></p>
<p class="p4">sudo easy_install locustio</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で</p>
<p class="p2"><br></p>
<p class="p4">sudo locust -f job.py --host 127.0.0.1:80<span class="Apple-converted-space">  </span>--port 8000</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>で、サンプル的なjob.pyはこんなの。</p>
<p class="p4">from locust import HttpLocust, TaskSet, task</p>
<p class="p5"><br></p>
<p class="p4">class WebsiteTasks(TaskSet):</p>
<p class="p4"><span class="Apple-converted-space">    </span>def on_start(self):</p>
<p class="p4"><span class="Apple-converted-space">        </span>pass</p>
<p class="p4"><span class="Apple-converted-space">        </span># self.client.get("http:127.0.0.1:80/"</p>
<p class="p4"><span class="Apple-converted-space">        </span># <span class="Apple-converted-space">    </span>, {</p>
<p class="p4"><span class="Apple-converted-space">        </span># <span class="Apple-converted-space">    </span>"username": "test_user",</p>
<p class="p4"><span class="Apple-converted-space">        </span># <span class="Apple-converted-space">    </span>"password": ""</p>
<p class="p4"><span class="Apple-converted-space">        </span># })</p>
<p class="p5"><span class="Apple-converted-space">    </span></p>
<p class="p4"><span class="Apple-converted-space">    </span>@task</p>
<p class="p4"><span class="Apple-converted-space">    </span>def index(self):</p>
<p class="p4"><span class="Apple-converted-space">        </span>self.client.get("http:127.0.0.1:80/")</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span># @task</p>
<p class="p4"><span class="Apple-converted-space">    </span># def about(self):</p>
<p class="p4"><span class="Apple-converted-space">    </span># <span class="Apple-converted-space">    </span>print("b")</p>
<p class="p4"><span class="Apple-converted-space">    </span># <span class="Apple-converted-space">    </span>self.client.get("/")</p>
<p class="p4"><span class="Apple-converted-space">    </span># <span class="Apple-converted-space">    </span># self.client.get("/about/")</p>
<p class="p5"><br></p>
<p class="p4">class WebsiteUser(HttpLocust):</p>
<p class="p4"><span class="Apple-converted-space">    </span>task_set = WebsiteTasks</p>
<p class="p4"><span class="Apple-converted-space">    </span>min_wait = 1000</p>
<p class="p4"><span class="Apple-converted-space">    </span>max_wait = 15000</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>コマンドライン実行後、ブラウザで開く。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>WebSocketを使いたい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>easy_installでWebSocketのライブラリを足す<span class="Apple-tab-span">	</span></p>
<p class="p6">sudo easy_install websocket-client</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>jobファイルはこんな感じで。</p>
<p class="p4">from locust import HttpLocust, TaskSet, task</p>
<p class="p5"><br></p>
<p class="p4">class WebsiteTasks(TaskSet):</p>
<p class="p4"><span class="Apple-converted-space">    </span>def on_start(self):<span class="Apple-converted-space"> </span></p>
<p class="p4"><span class="Apple-converted-space">        </span>ws = create_connection('ws://127.0.0.1:80/websocket_entrypoint')</p>
<p class="p4"><span class="Apple-converted-space">        </span>self.ws = ws</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">        </span>def _receive():</p>
<p class="p4"><span class="Apple-converted-space">            </span>while True:</p>
<p class="p4"><span class="Apple-converted-space">                </span>res = ws.recv()</p>
<p class="p4"><span class="Apple-converted-space">                </span>print("res", res)</p>
<p class="p4"><span class="Apple-converted-space">                </span># data = json.loads(res)</p>
<p class="p4"><span class="Apple-converted-space">                </span># end_at = time.time()</p>
<p class="p4"><span class="Apple-converted-space">                </span># response_time = int((end_at - data['start_at']) * 1000000)</p>
<p class="p4"><span class="Apple-converted-space">                </span># request_success.fire(</p>
<p class="p4"><span class="Apple-converted-space">                </span># <span class="Apple-converted-space">    </span>request_type='WebSocket Recv',</p>
<p class="p4"><span class="Apple-converted-space">                </span># <span class="Apple-converted-space">    </span>name='test/ws/echo',</p>
<p class="p4"><span class="Apple-converted-space">                </span># <span class="Apple-converted-space">    </span>response_time=response_time,</p>
<p class="p4"><span class="Apple-converted-space">                </span># <span class="Apple-converted-space">    </span>response_length=len(res),</p>
<p class="p4"><span class="Apple-converted-space">                </span># )</p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">        </span>gevent.spawn(_receive)</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>def on_quit(self):</p>
<p class="p4"><span class="Apple-converted-space">        </span>self.ws.close()</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p4"><span class="Apple-converted-space">    </span>@task</p>
<p class="p4"><span class="Apple-converted-space">    </span>def index(self):</p>
<p class="p4"><span class="Apple-converted-space">        </span># print("passing. ")</p>
<p class="p4"><span class="Apple-converted-space">        </span>self.ws.send_binary("body")</p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p5"><br></p>
<p class="p4">class WebsiteUser(HttpLocust):</p>
<p class="p4"><span class="Apple-converted-space">    </span>task_set = WebsiteTasks</p>
<p class="p4"><span class="Apple-converted-space">    </span>min_wait = 1000</p>
<p class="p4"><span class="Apple-converted-space">    </span>max_wait = 15000</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
