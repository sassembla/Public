<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1404.47">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Mackerelのハンズオン</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Mackerelハンズオン</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://mackerelio.connpass.com/event/38331/">http://mackerelio.connpass.com/event/38331/</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>当選したので行ってきた。</p>
<p class="p3"><span class="Apple-tab-span">	</span>本来は別の日だったんだけど、台風でズレて9/5になった。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>はてな、東京のはわりとぬる舗から近いということがわかった。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>資料</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ひこうかい。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Mackerel概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>push型。監視対象サービスにインストールされたエージェントがデータをpushする。</p>
<p class="p3"><span class="Apple-tab-span">	</span>zabbixとかnagiosはpull型。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>デザイナー専属でいるので一貫性があって素敵。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>GUI、CLI、CLIからAPI経由で制御、とかいろんなインターフェースがある。</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>やってみる系</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>AWSに仮の監視対象を用意してくれてた。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Makerelにおけるグルーピングとか用語</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>オーガニゼーション x N</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>サービス x M</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>ロール x L</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>みたいな並び。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>エージェントを監視対象サーバにインストール</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>下記コマンドを実行後、インストールコマンドがサジェストされるんで、それを入れる。</p>
<p class="p2"><br></p>
<p class="p4">curl -fsSL https://mackerel.io/assets/files/scripts/setup-yum.sh | sh</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>APIKeysをエージェントに登録</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>MakerelのユーザーページからAPIKeysが取得できるんで、それを監視対象のエージェントに入れる。</p>
<p class="p2"><br></p>
<p class="p4">sudo mackerel-agent init -apikey="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</p>
<p class="p2"><br></p>
<p class="p2"><b></b><br></p>
<p class="p3"><b>エージェントの起動</b></p>
<p class="p2"><br></p>
<p class="p4">sudo /etc/init.d/mackerel-agent start</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>サービスとロールの設定</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>サービス、そこに所属するロールを作成</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>作成したサービス/ロールと、ホスト(エージェントをインストールしたとこ)との連携</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Hosts から、すでにMackerelのエージェントを入れたマシンが表示されてるので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>そこに先ほど作成したサービス/ロールを割り当てることができる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>モニタリングからアラート設定の流れ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Monitors &gt; New Monitor とかで作成。</p>
<p class="p3"><span class="Apple-tab-span">	</span>GUIから設定できる。便利だ。<span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>アラートが出たらどうなるの？</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>時系列で可視化される。</p>
<p class="p3"><span class="Apple-tab-span">	</span>と同時に、「チケット」が作成される。</p>
<p class="p3"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202016-09-05%2016.12.49.png" alt="スクリーンショット 2016-09-05 16.12.49.png"></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202016-09-05%2016.14.57.png" alt="スクリーンショット 2016-09-05 16.14.57.png"></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>かなり素敵。</p>
<p class="p3"><span class="Apple-tab-span">	</span>メールも届く。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202016-09-05%2016.21.04.png" alt="スクリーンショット 2016-09-05 16.21.04.png"></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>原因を排除すれば、アラートは消えて、チケットも消化される。</p>
<p class="p3"><span class="Apple-tab-span">	</span>あと解消しましたメールも届く。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span><img src="%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202016-09-05%2016.21.28.png" alt="スクリーンショット 2016-09-05 16.21.28.png"></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>特定のミドルウェアに関してのプラグインをエージェントに入れる</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>MySQLとかApacheとかの監視ができるプラグインを入れてみる。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>プラグインはここで公開されてる。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/mackerelio/mackerel-agent-plugins">https://github.com/mackerelio/mackerel-agent-plugins</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>プラグイン集はこれスクリプトで、下記コマンドでエージェントが入ってるPeerにインストールできる。</p>
<p class="p4">sudo yum install -y mackerel-agent-plugins</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>あとは名指しで、起動するプラグインを指定してエージェント再起動。</p>
<p class="p4">/etc/mackerel-agent/mackerel-agent.conf を編集</p>
<p class="p4">sudo /etc/init.d/mackerel-agent restart</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>プラグインはstdoutを適当なフォーマットで吐ければいい</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>プラグインは単体でも実行できて、stdoutにstringを吐くことができればOKなのか。</p>
<p class="p3"><span class="Apple-tab-span">	</span>フォーマットはタブで区切られてて改行があればいいぽい。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>なるほどな～～～</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>サービスメトリックについて</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>ホストをまとめたもの = サービスに対してのメトリック。</p>
<p class="p3"><span class="Apple-tab-span">	</span>ようはユーザーが自由に定義していいメトリック。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>公式ヘルプ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><a href="https://mackerel.io/ja/docs/">https://mackerel.io/ja/docs/</a></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>fluentdでMackerelに送り込む方法とかが書いてあって面白い。</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://mackerel.io/ja/docs/entry/advanced/fluentd">https://mackerel.io/ja/docs/entry/advanced/fluentd</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>Q&amp;A</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Q.Mackerel自体の死活監視ってどうなるの？</p>
<p class="p3"><span class="Apple-tab-span">	</span>A.mackerel.status.io あるよ</p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="http://mackerel.status.io">http://mackerel.status.io</a></p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
