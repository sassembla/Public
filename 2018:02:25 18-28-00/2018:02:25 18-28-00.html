<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1504.83">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 17.0px 'Hiragino Sans'}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; background-color: #ebebeb; min-height: 18.0px}
    span.s1 {color: #ff2600}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Autoyaチェックリスト</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>OverridePointsのこの項目をいい感じに改変できると良いと思う。特にセキュリティ的な部分で。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>authentication handlers.</b></p>
<p class="p2"><br></p>
<p class="p3"><b>1.初回通信に使うバイナリキー、良い感じの形式のものを良い感じの</b><span class="s1"><b>暗号化して</b></span><b>送るべき。</b></p>
<p class="p5">private IEnumerator OnBootAuthRequest(Action&lt;Dictionary&lt;string, string&gt;, string&gt; setHeaderAndDataToRequest)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>// set boot body data for Http.Post to server.(if empty, this framework use Http.Get for sending data to server.)</p>
<p class="p5"><span class="Apple-converted-space">    </span>var data = "some boot data";</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>// set boot authentication header.</p>
<p class="p5"><span class="Apple-converted-space">    </span>var bootKey = AuthSettings.AUTH_BOOT;</p>
<p class="p5"><span class="Apple-converted-space">    </span>var base64Str = Base64.FromBytes(bootKey);</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>var bootRequestHeader = new Dictionary&lt;string, string&gt; {</p>
<p class="p5"><span class="Apple-converted-space">        </span>{"Authorization", base64Str}</p>
<p class="p5"><span class="Apple-converted-space">    </span>};</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>setHeaderAndDataToRequest(bootRequestHeader, data);</p>
<p class="p5"><span class="Apple-converted-space">    </span>yield break;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>2.初回起動時のサーバからの通信に対して、クライアント側でチェックし、validかどうか判断すべき。validだったら、</b><span class="s1"><b>暗号化して</b></span><b>tokenデータを保存する。</b></p>
<p class="p3"><b><span class="Apple-tab-span">	</span>この例ではtokenしか保存していないが、refreshTokenも</b><span class="s1"><b>暗号化して</b></span><b>保存する必要がある。</b></p>
<p class="p5">private IEnumerator OnBootAuthResponse(Dictionary&lt;string, string&gt; responseHeader, string data, Action&lt;int, string&gt; bootAuthFailed)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>var isValidResponse = true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>if (isValidResponse)</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>Autoya.Persist_Update(AuthSettings.AUTH_STORED_FRAMEWORK_DOMAIN, AuthSettings.AUTH_STORED_TOKEN_FILENAME, data);</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5"><span class="Apple-converted-space">    </span>else</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>bootAuthFailed(-1, "failed to boot validation.");</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5"><span class="Apple-converted-space">    </span>yield break;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>3.リフレッシュトークンの送信。保存してあるrefreshTokenを復号する必要がある。このコードではまんま保存しておいたtokenを送っているため、保存するところから変えないと行けない。</b></p>
<p class="p5">private IEnumerator OnTokenRefreshRequest(Action&lt;Dictionary&lt;string, string&gt;, string&gt; setHeaderToRequest)</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>// set refresh body data for Http.Post to server.(if empty, this framework use Http.Get for sending data to server.)</p>
<p class="p5"><span class="Apple-converted-space">    </span>var data = "some refresh data";</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>// return refresh token for re-authenticate.</p>
<p class="p5"><span class="Apple-converted-space">    </span>var refreshToken = Autoya.Persist_Load(AuthSettings.AUTH_STORED_FRAMEWORK_DOMAIN, AuthSettings.AUTH_STORED_TOKEN_FILENAME);</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>var base64Str = Base64.FromString(refreshToken);</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>var refreshRequestHeader = new Dictionary&lt;string, string&gt; {</p>
<p class="p5"><span class="Apple-converted-space">        </span>{"Authorization", base64Str}</p>
<p class="p5"><span class="Apple-converted-space">    </span>};</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>setHeaderToRequest(refreshRequestHeader, data);</p>
<p class="p5"><span class="Apple-converted-space">    </span>yield break;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>4.リフレッシュトークンの受信。validationしてOKだったら、新たに得たtokenとrefreshTokenを</b><span class="s1"><b>暗号化して</b></span><b>保存。</b></p>
<p class="p5">private IEnumerator OnTokenRefreshResponse(Dictionary&lt;string, string&gt; responseHeader, string data, Action&lt;int, string&gt; refreshFailed)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>var isValidResponse = true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>if (isValidResponse)</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>Autoya.Persist_Update(AuthSettings.AUTH_STORED_FRAMEWORK_DOMAIN, AuthSettings.AUTH_STORED_TOKEN_FILENAME, data);</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5"><span class="Apple-converted-space">    </span>else</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>// failsafe here.</p>
<p class="p6"><br></p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">        </span>// set result as failure.</p>
<p class="p5"><span class="Apple-converted-space">        </span>refreshFailed(-1, "failed to refresh token.");</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>yield break;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>authorized http request &amp; response handlers.</b></p>
<p class="p2"><br></p>
<p class="p3"><b>5.JWTなどのdigest生成を行うのはここ。</b></p>
<p class="p5">private Dictionary&lt;string, string&gt; OnHttpRequest(string method, string url, Dictionary&lt;string, string&gt; requestHeader, string data)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>var accessToken = Autoya.Persist_Load(AuthSettings.AUTH_STORED_FRAMEWORK_DOMAIN, AuthSettings.AUTH_STORED_TOKEN_FILENAME);</p>
<p class="p5"><span class="Apple-converted-space">    </span>requestHeader["Authorization"] = Base64.FromString(accessToken);</p>
<p class="p6"><br></p>
<p class="p5"><span class="Apple-converted-space">    </span>return requestHeader;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>6.レスポンスに対してのチェックを行うのはここ。(string)</b></p>
<p class="p5">private bool OnValidateHttpResponse(string method, string url, Dictionary&lt;string, string&gt; responseHeader, string data, out string reason)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>// let's validate http response if need.</p>
<p class="p5"><span class="Apple-converted-space">    </span>var isValid = true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>if (isValid)</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>reason = string.Empty;</p>
<p class="p5"><span class="Apple-converted-space">        </span>return true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5"><span class="Apple-converted-space">    </span>else</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>reason = "run over by a bicycle.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>7.レスポンスに対してのチェックを行うのはここ。(byte[])</b></p>
<p class="p5">private bool OnValidateHttpResponse(string method, string url, Dictionary&lt;string, string&gt; responseHeader, byte[] data, out string reason)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>// let's validate http response if need.</p>
<p class="p5"><span class="Apple-converted-space">    </span>var isValid = true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>if (isValid)</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>reason = string.Empty;</p>
<p class="p5"><span class="Apple-converted-space">        </span>return true;</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5"><span class="Apple-converted-space">    </span>else</p>
<p class="p5"><span class="Apple-converted-space">    </span>{</p>
<p class="p5"><span class="Apple-converted-space">        </span>reason = "run over by a bicycle.";</p>
<p class="p5"><span class="Apple-converted-space">        </span>return false;</p>
<p class="p5"><span class="Apple-converted-space">    </span>}</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>purchase feature handlers.</b></p>
<p class="p2"><br></p>
<p class="p3"><b>8.サーバ側が最新状態を持っているので、必要があれば課金関連のパラメータを更新する。</b></p>
<p class="p5">private void onPaidPurchaseDoneInBackground(string backgroundPurchasedProductId)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>// server deployed some products for this player. update player's parameter if need.</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>AssetBundles handlers.</b></p>
<p class="p2"><br></p>
<p class="p3"><b>9.リストを保存する際に</b><span class="s1"><b>暗号化</b></span><b>すると良い。</b></p>
<p class="p5">private AssetBundleList[] LoadAssetBundleListsFromStorage()</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>// load stored assetBundleList then return it.</p>
<p class="p5"><span class="Apple-converted-space">    </span>var filePaths = Autoya.Persist_FileNamesInDomain(AssetBundlesSettings.ASSETBUNDLES_LIST_STORED_DOMAIN);</p>
<p class="p5"><span class="Apple-converted-space">    </span>return filePaths.Select(</p>
<p class="p5"><span class="Apple-converted-space">        </span>path =&gt; JsonUtility.FromJson&lt;AssetBundleList&gt;(</p>
<p class="p5"><span class="Apple-converted-space">            </span>Autoya.Persist_Load(</p>
<p class="p5"><span class="Apple-converted-space">                </span>AssetBundlesSettings.ASSETBUNDLES_LIST_STORED_DOMAIN, Path.GetFileName(path)</p>
<p class="p5"><span class="Apple-converted-space">            </span>)</p>
<p class="p5"><span class="Apple-converted-space">        </span>)</p>
<p class="p5"><span class="Apple-converted-space">    </span>).ToArray();</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>10.リストを更新する際、</b><span class="s1"><b>暗号化</b></span><b>すると良い。</b></p>
<p class="p5">private bool StoreAssetBundleListToStorage(AssetBundleList list)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>var listStr = JsonUtility.ToJson(list);</p>
<p class="p5"><span class="Apple-converted-space">    </span>var result = _autoyaFilePersistence.Update(AssetBundlesSettings.ASSETBUNDLES_LIST_STORED_DOMAIN, list.identity, listStr);</p>
<p class="p5"><span class="Apple-converted-space">    </span>return result;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>11.AssetBundleListのGet時に発効。CDNに何かしらアクセス保護を仕込んである場合、ここでパラメータを入れる。</b></p>
<p class="p5">private Dictionary&lt;string, string&gt; OnAssetBundleListGetRequest(string url, Dictionary&lt;string, string&gt; requestHeader)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>return requestHeader;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>12.PreloadListのGet時に発効。CDNに何かしらアクセス保護を仕込んである場合、ここでパラメータを入れる。</b></p>
<p class="p5">private Dictionary&lt;string, string&gt; OnAssetBundlePreloadListGetRequest(string url, Dictionary&lt;string, string&gt; requestHeader)</p>
<p class="p6"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>return requestHeader;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>13.AssetBundleのGet時に発効。CDNに何かしらアクセス保護を仕込んである場合、ここでパラメータを入れる。</b></p>
<p class="p5">private Dictionary&lt;string, string&gt; OnAssetBundleGetRequest(string url, Dictionary&lt;string, string&gt; requestHeader)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>return requestHeader;</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p4"><b>ApplicationManifest handlers.</b></p>
<p class="p2"><br></p>
<p class="p3"><b>14.RuntimeManifestの上書き。</b><span class="s1"><b>暗号化</b></span><b>すると良い。</b></p>
<p class="p5">private bool OnOverwriteRuntimeManifest(string data)</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>return _autoyaFilePersistence.Update(AppSettings.APP_STORED_RUNTIME_MANIFEST_DOMAIN, AppSettings.APP_STORED_RUNTIME_MANIFEST_FILENAME, data);</p>
<p class="p5">}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>15.RuntimeManifestの取り出し。</b><span class="s1"><b>復号化</b></span><b>すると良い。</b></p>
<p class="p5">private string OnLoadRuntimeManifest()</p>
<p class="p5">{</p>
<p class="p5"><span class="Apple-converted-space">    </span>return _autoyaFilePersistence.Load(AppSettings.APP_STORED_RUNTIME_MANIFEST_DOMAIN, AppSettings.APP_STORED_RUNTIME_MANIFEST_FILENAME);</p>
<p class="p5">}</p>
<p class="p2"><br></p>
</body>
</html>
