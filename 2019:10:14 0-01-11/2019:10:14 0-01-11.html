<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><link rel="stylesheet" type="text/less" href="../stylesheets/less/default.less"/><script type="text/javascript" src="../javascripts/less-1.3.0.min.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 22.0px 'Hiragino Sans'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'; min-height: 18.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px 'Hiragino Sans'}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.6px Menlo; color: #1b1f22; background-color: #e6e6e6}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.6px Menlo; color: #57606a; background-color: #e6e6e6}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.6px Menlo; color: #5b28b4; background-color: #e6e6e6}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.6px Menlo; color: #1b1f22; background-color: #e6e6e6; min-height: 16.0px}
    span.s1 {font-kerning: none; color: #cb2339}
    span.s2 {font-kerning: none}
    span.s3 {font-kerning: none; color: #5b28b4}
    span.s4 {font-kerning: none; color: #1b1f22}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><b>Chanquo2系</b></p>
<p class="p2"><br></p>
<p class="p3"><b>概要</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>Chanquo = Typeを接続用パラメータとして扱うGoのchannelもどき for Unity。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1系は正直適当な実装だったんで、goのコードを読みながらアップグレードを目論む。</p>
<p class="p3"><span class="Apple-tab-span">	</span>互換性は破壊されちゃったらごめんねみたいな想定。-&gt;破壊されました。やったぜ！</p>
<p class="p2"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><b>1系のダメなところ</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・structを使えない(致命傷)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・マルチレシーブが特に必要ない感じ(タイムアウトとかがつけば別だが、それはそれで変な実装になる。</p>
<p class="p3"><span class="Apple-tab-span">	</span>・yield returnしたい(一件受けたら云々とか)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・スロットルの概念があってもいい(N個をまとめて受ける)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・MainThreadDispatcher頼み(シーンを超えられるが、超えていいケースは少なかった。)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・コードが汚い(美しくない、拡張性が低い)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Jobまわりを綺麗にアレしたいができない</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>ということで、2系の開発に取り組み、完成した。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span><b>Chanquo</b></p>
<p class="p3"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="https://github.com/sassembla/Chanquo">https://github.com/sassembla/Chanquo</a></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>対応し途中のもの</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>・スロットルの概念があってもいい(N個をまとめて受ける)</p>
<p class="p3"><span class="Apple-tab-span">	</span>・Jobまわりを綺麗にアレしたいができない</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>これらは途中。で、これら以外は対応できた。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><b>結果</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>こんな感じの書き方ができるようになった。</p>
<p class="p4"><span class="s1">var</span><span class="s2"> ch </span><span class="s1">=</span><span class="s2"> Chan&lt;</span><span class="s3">T</span><span class="s2">&gt;.</span><span class="s3">Make</span><span class="s2">();</span></p>
<p class="p4"><span class="s2">ch.</span><span class="s3">Send</span><span class="s2">(</span><span class="s1">new</span><span class="s2"> </span><span class="s3">T</span><span class="s2">(){});</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>struct型Tを指定して、chの生成、chへとデータの送付。</p>
<p class="p3"><span class="Apple-tab-span">	</span>goでの ch &lt;- データ みたいな形。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>受け取り側は複数パターンが使えて、</p>
<p class="p2"><br></p>
<p class="p5"><span class="s2">// start receiving data asynchronously.</span></p>
<p class="p6"><span class="s4">ch.</span><span class="s2">Receive</span><span class="s4">(</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>(</span><span class="s3">T</span><span class="s2"> data, </span><span class="s1">bool</span><span class="s2"> ok) </span><span class="s1">=&gt;</span><span class="s2"> {</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s2">// ok will become false when the channel is closed somewhere.</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s2">// when ok is false, data is empty.</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p4"><span class="s2">);</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>1. select 文に対するcase data, ok := &lt;- chのような扱い。</p>
<p class="p3"><span class="Apple-tab-span">	</span>非同期で継続的な受け取り。これはv1と同じようなシグニチャになっている。と思ったけどそうでもないか。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p3"><span class="Apple-tab-span">	</span>誰かがchをCloseするとokがfalseな状態で飛んでくる。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p5"><span class="s2">// receive data until Chan&lt;T&gt; is closed.</span></p>
<p class="p4"><span class="s1">yield</span><span class="s2"> </span><span class="s1">return</span><span class="s2"> Channels.</span><span class="s3">For</span><span class="s2">&lt;</span><span class="s3">T</span><span class="s2">&gt;(</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>T t </span><span class="s1">=&gt;</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>{</span></p>
<p class="p7"><span class="s2"><span class="Apple-converted-space">        </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p4"><span class="s2">);</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>2. こちらはfor文での for data := range ch 相当。</p>
<p class="p3"><span class="Apple-tab-span">	</span>Unityの場合はブロックせずに一定の位置で待つ、というのがasync汚染なしでは辛い(なんかいい手段ある？)という感じなので、</p>
<p class="p3"><span class="Apple-tab-span">	</span>yield return と組み合わせる形にしている。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p5"><span class="s2">// wait first data then go through.</span></p>
<p class="p4"><span class="s1">yield</span><span class="s2"> </span><span class="s1">return</span><span class="s2"> Channels.</span><span class="s3">WaitFirst</span><span class="s2">&lt;</span><span class="s3">T</span><span class="s2">&gt;();</span></p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>3. こちらは単純に &lt;- ch と同じようなもの。</p>
<p class="p3"><span class="Apple-tab-span">	</span>T型のデータがどこかから送信されると、yieldを抜ける。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>goの場合はgoroutineでブロックをつくりまくっても全体には影響が及ばないのだが、</p>
<p class="p3"><span class="Apple-tab-span">	</span>Unity C#の場合はブロックするとてきめんに詰む。</p>
<p class="p2"><br></p>
<p class="p3"><span class="Apple-tab-span">	</span>そのため、「その位置で待つ」という機能としてyield returnを使っている。</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p2"><br></p>
<p class="p3"><b>感想</b></p>
<p class="p3"><span class="Apple-tab-span">	</span>より捨てやすく、なんとなーくUnityフレンドリーな書き方もできるようになった。</p>
<p class="p3"><span class="Apple-tab-span">	</span>structが使えるのもよい。</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
</body>
</html>
